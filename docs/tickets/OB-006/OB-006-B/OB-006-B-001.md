# OB-006-B-001: Calcular estado de compromiso automaticamente

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-006 - Compromisos de Aporte |
| Story | OB-006-B - Estados y seguimiento de compromisos |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, calculo, estado |
| Depends on | OB-006-A-001 |
| Assigned | unassigned |

## Descripcion

Implementar el calculo automatico del estado de un compromiso basado en la suma de aportes asociados vs el monto comprometido.

## Contexto Tecnico

### Archivos afectados
- `src/services/compromiso.service.ts`
- `src/utils/compromiso-estado.ts`

### Enfoque tecnico
Funcion pura que calcula el estado. Se usa tanto en consultas como en respuestas de API. Estado es derivado, no almacenado.

## Criterios de Aceptacion

- [ ] PENDIENTE: totalAportado = 0
- [ ] PARCIAL: 0 < totalAportado < montoComprometido
- [ ] CUMPLIDO: totalAportado >= montoComprometido
- [ ] Solo considera aportes confirmados
- [ ] Funcion reutilizable en todo el sistema

## Notas de Implementacion

```typescript
interface EstadoCompromisoResult {
  estado: EstadoCompromiso;
  montoComprometido: Decimal;
  totalAportado: Decimal;
  montoPendiente: Decimal;
  porcentajeCumplimiento: number;
}

async function calcularEstadoCompromiso(
  compromisoId: string
): Promise<EstadoCompromisoResult> {
  const compromiso = await typeorm.compromiso.findUnique({
    where: { id: compromisoId },
    include: {
      aportes: {
        where: { estado: 'CONFIRMADO' }
      }
    }
  });

  const totalAportado = compromiso.aportes.reduce(
    (sum, a) => sum.add(a.monto),
    new Decimal(0)
  );

  let estado: EstadoCompromiso;
  if (totalAportado.isZero()) {
    estado = 'PENDIENTE';
  } else if (totalAportado.lessThan(compromiso.montoComprometido)) {
    estado = 'PARCIAL';
  } else {
    estado = 'CUMPLIDO';
  }

  return {
    estado,
    montoComprometido: compromiso.montoComprometido,
    totalAportado,
    montoPendiente: Decimal.max(
      compromiso.montoComprometido.sub(totalAportado),
      new Decimal(0)
    ),
    porcentajeCumplimiento: Math.min(
      totalAportado.div(compromiso.montoComprometido).mul(100).toNumber(),
      100
    )
  };
}
```

## Testing

- [ ] Sin aportes retorna PENDIENTE
- [ ] Con aportes parciales retorna PARCIAL
- [ ] Con aportes >= comprometido retorna CUMPLIDO
- [ ] Solo suma aportes CONFIRMADOS
- [ ] Porcentaje no excede 100%
