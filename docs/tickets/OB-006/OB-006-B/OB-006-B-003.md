# OB-006-B-003: Implementar filtros de compromisos por estado

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-006 - Compromisos de Aporte |
| Story | OB-006-B - Estados y seguimiento de compromisos |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, filtros |
| Depends on | OB-006-B-001 |
| Assigned | unassigned |

## Descripcion

Implementar filtros avanzados en el listado de compromisos, incluyendo filtro por estado calculado y "morosos" (pendientes vencidos).

## Contexto Tecnico

### Archivos afectados
- `src/services/pledge.service.ts`
- `src/api/controllers/pledges.controller.ts`

### Enfoque tecnico
Filtrado post-calculo del estado, ya que el estado es derivado. Considerar vistas materializadas para mejor performance.

## Criterios de Aceptacion

- [ ] Filtro por estado (PENDIENTE, PARCIAL, CUMPLIDO)
- [ ] Filtro "morosos" (pendientes despues de fecha fin actividad)
- [ ] Filtro por torre o bloque
- [ ] Exportable la lista filtrada
- [ ] Ordenamiento por monto pendiente

## Notas de Implementacion

Endpoint con filtros:
```
GET /api/.../activities/:actId/pledges?status=PENDING&delinquent=true&tower=uuid&orderBy=pendingAmount&order=desc
```

Logica de "morosos":
```typescript
// Determina si un compromiso esta en mora
function isDelinquent(pledge: Pledge, activity: FundraisingActivity): boolean {
  const statusInfo = calculatePledgeStatus(pledge.id);
  const deadline = activity.endDate || activity.objective.endDate;

  return (
    statusInfo.status !== 'FULFILLED' &&
    deadline &&
    new Date() > deadline
  );
}
```

Response con estado calculado:
```json
{
  "data": [
    {
      "id": "uuid",
      "apartment": { "number": "101", "tower": "Tower A" },
      "pledgedAmount": "100000.00",
      "calculatedStatus": {
        "status": "PARTIAL",
        "totalContributed": "30000.00",
        "pendingAmount": "70000.00",
        "percentage": 30
      },
      "isDelinquent": true
    }
  ],
  "pagination": { ... }
}
```

## Testing

- [ ] Filtro por estado funciona correctamente
- [ ] Morosos se identifican correctamente
- [ ] Combinacion de filtros funciona
- [ ] Ordenamiento por monto pendiente funciona
