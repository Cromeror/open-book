# OB-006-B-003: Implementar filtros de compromisos por estado

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-006 - Compromisos de Aporte |
| Story | OB-006-B - Estados y seguimiento de compromisos |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, filtros |
| Depends on | OB-006-B-001 |
| Assigned | unassigned |

## Descripcion

Implementar filtros avanzados en el listado de compromisos, incluyendo filtro por estado calculado y "morosos" (pendientes vencidos).

## Contexto Tecnico

### Archivos afectados
- `src/services/compromiso.service.ts`
- `src/api/controllers/compromisos.controller.ts`

### Enfoque tecnico
Filtrado post-calculo del estado, ya que el estado es derivado. Considerar vistas materializadas para mejor performance.

## Criterios de Aceptacion

- [ ] Filtro por estado (PENDIENTE, PARCIAL, CUMPLIDO)
- [ ] Filtro "morosos" (pendientes despues de fecha fin actividad)
- [ ] Filtro por torre o bloque
- [ ] Exportable la lista filtrada
- [ ] Ordenamiento por monto pendiente

## Notas de Implementacion

Endpoint con filtros:
```
GET /api/.../actividades/:actId/compromisos?estado=PENDIENTE&morosos=true&torre=uuid&orderBy=montoPendiente&order=desc
```

Logica de "morosos":
```typescript
function esMoroso(compromiso: Compromiso, actividad: Actividad): boolean {
  const estadoInfo = calcularEstadoCompromiso(compromiso.id);
  const fechaLimite = actividad.fechaFin || actividad.objetivo.fechaFin;

  return (
    estadoInfo.estado !== 'CUMPLIDO' &&
    fechaLimite &&
    new Date() > fechaLimite
  );
}
```

Response con estado calculado:
```json
{
  "data": [
    {
      "id": "uuid",
      "apartamento": { "numero": "101", "torre": "Torre A" },
      "montoComprometido": "100000.00",
      "estadoCalculado": {
        "estado": "PARCIAL",
        "totalAportado": "30000.00",
        "montoPendiente": "70000.00",
        "porcentaje": 30
      },
      "esMoroso": true
    }
  ],
  "pagination": { ... }
}
```

## Testing

- [ ] Filtro por estado funciona correctamente
- [ ] Morosos se identifican correctamente
- [ ] Combinacion de filtros funciona
- [ ] Ordenamiento por monto pendiente funciona
