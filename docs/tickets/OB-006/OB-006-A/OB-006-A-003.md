# OB-006-A-003: Validar compromiso unico por apartamento-actividad

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-006 - Compromisos de Aporte |
| Story | OB-006-A - Modelo y CRUD de compromisos |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, validacion, unicidad |
| Depends on | OB-006-A-002 |
| Assigned | unassigned |

## Descripcion

Implementar validacion de negocio que asegure que un apartamento solo pueda tener un compromiso activo por actividad.

## Contexto Tecnico

### Archivos afectados
- `src/services/compromiso.service.ts`
- `src/api/validators/compromiso.validator.ts`

### Enfoque tecnico
Validar en capa de servicio antes de crear. El constraint de BD es respaldo.

## Criterios de Aceptacion

- [ ] No se puede crear compromiso duplicado para mismo apartamento-actividad
- [ ] Mensaje de error claro cuando ya existe compromiso
- [ ] Compromisos eliminados (soft delete) no bloquean nuevos
- [ ] Opcion de actualizar monto de compromiso existente
- [ ] Sugerir actualizar en lugar de crear si ya existe

## Notas de Implementacion

```typescript
async function validateCompromisoUnico(
  apartamentoId: string,
  actividadId: string,
  excludeId?: string
): Promise<void> {
  const existing = await typeorm.compromiso.findFirst({
    where: {
      apartamentoId,
      actividadId,
      deletedAt: null,
      id: excludeId ? { not: excludeId } : undefined
    }
  });

  if (existing) {
    throw new ConflictError(
      `El apartamento ya tiene un compromiso para esta actividad. ` +
      `Puede actualizar el compromiso existente (ID: ${existing.id}) ` +
      `en lugar de crear uno nuevo.`
    );
  }
}
```

Endpoint alternativo para "crear o actualizar":
```
PUT /api/.../actividades/:actId/compromisos/apartamento/:aptId
Body: { "montoComprometido": 50000 }
```

Este endpoint crea si no existe o actualiza si ya existe.

## Testing

- [ ] Duplicado retorna 409 con mensaje claro
- [ ] Compromisos soft-deleted no bloquean
- [ ] PUT crea o actualiza correctamente
- [ ] Constraint de BD funciona como respaldo
