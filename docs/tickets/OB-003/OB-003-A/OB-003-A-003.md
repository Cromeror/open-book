# OB-003-A-003: Vincular administradores a copropiedades

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-003 - Gestion de Copropiedades y Apartamentos |
| Story | OB-003-A - Modelo y gestion de copropiedades |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, administradores, relacion |
| Depends on | OB-003-A-002 |
| Assigned | unassigned |

## Descripcion

Implementar la relacion entre administradores y copropiedades. Un administrador puede gestionar multiples copropiedades y una copropiedad puede tener multiples administradores.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/entities/copropiedad-admin.entity.ts`
- `apps/api/src/modules/copropiedades/copropiedades.controller.ts`
- `apps/api/src/modules/copropiedades/copropiedades.service.ts`

### Enfoque tecnico
Entidad de union CopropiedadAdmin para relacion many-to-many con TypeORM. Endpoints NestJS para agregar/remover administradores.

## Criterios de Aceptacion

- [ ] Entidad CopropiedadAdmin creada con TypeORM
- [ ] POST /api/copropiedades/:id/admins - Agregar admin
- [ ] DELETE /api/copropiedades/:id/admins/:userId - Remover admin
- [ ] GET /api/copropiedades/:id/admins - Listar admins
- [ ] Un admin solo ve copropiedades que administra
- [ ] Debe haber al menos un admin por copropiedad

## Notas de Implementacion

Entidad CopropiedadAdmin con TypeORM:
```typescript
import { Entity, Column, ManyToOne, JoinColumn, Unique } from 'typeorm';
import { BaseEntity } from './base.entity';
import { Copropiedad } from './copropiedad.entity';
import { User } from './user.entity';

@Entity('copropiedad_admins')
@Unique(['copropiedadId', 'userId'])
export class CopropiedadAdmin extends BaseEntity {
  @Column()
  copropiedadId: string;

  @ManyToOne(() => Copropiedad, (cop) => cop.administradores)
  @JoinColumn({ name: 'copropiedadId' })
  copropiedad: Copropiedad;

  @Column()
  userId: string;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'userId' })
  user: User;

  @Column({ default: false })
  isPrimary: boolean; // Admin principal
}
```

Controller NestJS:
```typescript
@Controller('copropiedades')
@UseGuards(JwtAuthGuard, RolesGuard)
export class CopropiedadesController {
  @Post(':id/admins')
  @Roles(Role.ADMIN)
  addAdmin(@Param('id') id: string, @Body() dto: AddAdminDto) {
    return this.copropiedadesService.addAdmin(id, dto.userId);
  }

  @Delete(':id/admins/:userId')
  @Roles(Role.ADMIN)
  removeAdmin(@Param('id') id: string, @Param('userId') userId: string) {
    return this.copropiedadesService.removeAdmin(id, userId);
  }

  @Get(':id/admins')
  @Roles(Role.ADMIN)
  listAdmins(@Param('id') id: string) {
    return this.copropiedadesService.listAdmins(id);
  }
}
```

Considerar:
- No permitir remover el ultimo admin
- Marcar un admin como principal (isPrimary)
- Registrar en auditoria

## Testing

- [ ] Se puede agregar admin a copropiedad
- [ ] No se puede duplicar la relacion
- [ ] No se puede remover ultimo admin
- [ ] Admin solo ve sus copropiedades
