# OB-003-A-002: Implementar CRUD de copropiedades

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-003 - Gestion de Copropiedades y Apartamentos |
| Story | OB-003-A - Modelo y gestion de copropiedades |
| Status | pending |
| Priority | critical |
| Created | 2025-12-31 |
| Updated | 2026-01-09 |
| Labels | task, api, crud, copropiedad |
| Depends on | OB-003-A-001 |
| Assigned | unassigned |

## Descripcion

Implementar los endpoints REST para crear, leer, actualizar y desactivar copropiedades. Estos endpoints deben estar bajo el prefijo `/admin/` ya que son operaciones de gestion administrativa.

## Contexto Tecnico

### Archivos a crear
- `apps/api/src/modules/admin/condominiums/condominiums.module.ts`
- `apps/api/src/modules/admin/condominiums/condominiums.controller.ts`
- `apps/api/src/modules/admin/condominiums/condominiums.service.ts`
- `apps/api/src/modules/admin/condominiums/dto/create-condominium.dto.ts`
- `apps/api/src/modules/admin/condominiums/dto/update-condominium.dto.ts`

### Archivos a modificar
- `apps/api/src/modules/admin/admin.module.ts` - Registrar CondominiumsModule en RouterModule

### Infraestructura existente
- `AdminModule` configurado con RouterModule para prefijo `/admin`
- Sistema de permisos con `@RequirePermission()` y `@RequireModule()` decoradores
- `BaseEntity` con campos de auditoria (createdBy, updatedBy, deletedBy)
- `GoalsModule` como patron de referencia para CRUD con permisos

## Criterios de Aceptacion

- [ ] POST /admin/condominiums - Crear copropiedad
- [ ] GET /admin/condominiums - Listar copropiedades (paginado)
- [ ] GET /admin/condominiums/:id - Obtener copropiedad
- [ ] PATCH /admin/condominiums/:id - Actualizar copropiedad
- [ ] DELETE /admin/condominiums/:id - Desactivar (soft delete)
- [ ] Todos los endpoints requieren autenticacion JWT
- [ ] Requiere permiso `condominiums:create|read|update|delete`
- [ ] Validacion de datos de entrada con class-validator

## Notas de Implementacion

### Estructura de Endpoints

```
# Admin endpoints (bajo RouterModule /admin)
POST   /admin/condominiums                 - Crear
GET    /admin/condominiums?page=1&limit=10 - Listar con paginacion
GET    /admin/condominiums/:id             - Obtener uno
PATCH  /admin/condominiums/:id             - Actualizar
DELETE /admin/condominiums/:id             - Soft delete
```

### DTOs

```typescript
// create-condominium.dto.ts
import { IsString, IsOptional, IsNumber, Min, MaxLength } from 'class-validator';

export class CreateCondominiumDto {
  @IsString()
  @MaxLength(200)
  name: string;

  @IsOptional()
  @IsString()
  @MaxLength(20)
  nit?: string;

  @IsString()
  @MaxLength(500)
  address: string;

  @IsString()
  @MaxLength(100)
  city: string;

  @IsNumber()
  @Min(1)
  unitCount: number;
}
```

### Controller (seguir patron de GoalsController)

```typescript
@Controller('condominiums')
@UseGuards(JwtAuthGuard, PermissionsGuard)
@RequireModule('condominiums')
export class CondominiumsController {
  @Post()
  @RequirePermission('condominiums:create')
  async create(@Body() dto: CreateCondominiumDto, @CurrentUser() user: User) {
    return this.service.create(dto, user.id);
  }

  @Get()
  @RequirePermission('condominiums:read')
  async findAll(@Query() query: PaginationDto) {
    return this.service.findAll(query);
  }

  @Get(':id')
  @RequirePermission('condominiums:read')
  async findOne(@Param('id', ParseUUIDPipe) id: string) {
    return this.service.findOne(id);
  }

  @Patch(':id')
  @RequirePermission('condominiums:update')
  async update(
    @Param('id', ParseUUIDPipe) id: string,
    @Body() dto: UpdateCondominiumDto,
    @CurrentUser() user: User
  ) {
    return this.service.update(id, dto, user.id);
  }

  @Delete(':id')
  @RequirePermission('condominiums:delete')
  async remove(@Param('id', ParseUUIDPipe) id: string, @CurrentUser() user: User) {
    return this.service.softDelete(id, user.id);
  }
}
```

### Registrar en AdminModule

```typescript
// apps/api/src/modules/admin/admin.module.ts
@Module({
  imports: [
    UsersModule,
    CondominiumsModule, // <-- Agregar
    RouterModule.register([
      {
        path: 'admin',
        children: [
          { path: 'users', module: UsersModule },
          { path: 'condominiums', module: CondominiumsModule }, // <-- Agregar
        ],
      },
    ]),
  ],
})
export class AdminModule {}
```

### Response crear (201)

```json
{
  "id": "uuid",
  "name": "Conjunto Residencial Los Pinos",
  "nit": "900123456-1",
  "address": "Calle 123 #45-67",
  "city": "Bogota",
  "unitCount": 120,
  "isActive": true,
  "createdAt": "2026-01-01T00:00:00Z",
  "createdBy": "user-uuid"
}
```

## Testing

- [ ] CRUD funciona correctamente
- [ ] No-autenticado recibe 401
- [ ] Sin permiso adecuado recibe 403
- [ ] Validacion rechaza datos invalidos
- [ ] Delete hace soft delete (actualiza deletedAt y deletedBy)
- [ ] NIT duplicado retorna error 409 Conflict

## Referencias

- `apps/api/src/modules/goals/` - Patron de referencia para CRUD con permisos
- `apps/api/src/modules/admin/users/` - Ejemplo de modulo bajo admin
- `apps/api/src/modules/admin/admin.module.ts` - Configuracion RouterModule
