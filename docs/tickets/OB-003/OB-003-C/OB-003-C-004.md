# OB-003-C-004: Filtrar datos por apartamento del residente

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-003 - Gestion de Copropiedades y Apartamentos |
| Story | OB-003-C - Asociacion de usuarios a apartamentos |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, seguridad, filtrado, acceso |
| Depends on | OB-003-C-001 |
| Assigned | unassigned |

## Descripcion

Implementar la logica de filtrado que asegura que un residente solo puede ver datos relacionados con su apartamento. Esto es fundamental para el principio de acceso controlado.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/common/guards/apartment-scope.guard.ts`
- `apps/api/src/modules/**/*.service.ts` (multiples servicios)
- `apps/api/src/common/decorators/user-apartment.decorator.ts`

### Enfoque tecnico
Crear Guard de NestJS que obtiene el apartamento activo del usuario y lo inyecta en el contexto. Los servicios usan este contexto para filtrar queries con TypeORM.

## Criterios de Aceptacion

- [ ] Guard ApartmentScopeGuard implementado
- [ ] Decorador @UserApartment() para inyectar apartamento
- [ ] Servicios de compromisos filtran por apartamento
- [ ] Servicios de aportes filtran por apartamento
- [ ] Residente sin apartamento recibe error claro
- [ ] Admin puede ver todos los datos (sin filtro)

## Notas de Implementacion

Guard de NestJS:
```typescript
// apartment-scope.guard.ts
import { Injectable, CanActivate, ExecutionContext, ForbiddenException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { ApartamentoResidente, EstadoAsociacion } from '../entities/apartamento-residente.entity';
import { Role } from '../entities/user.entity';

@Injectable()
export class ApartmentScopeGuard implements CanActivate {
  constructor(
    @InjectRepository(ApartamentoResidente)
    private apartamentoResidenteRepository: Repository<ApartamentoResidente>,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const user = request.user;

    if (!user) return false;

    // Admins no tienen restriccion de apartamento
    if (user.role === Role.ADMIN) {
      return true;
    }

    const asociacion = await this.apartamentoResidenteRepository.findOne({
      where: {
        userId: user.id,
        estado: EstadoAsociacion.ACTIVE,
      },
      relations: ['apartamento'],
    });

    if (!asociacion) {
      throw new ForbiddenException('No tiene un apartamento asociado activo');
    }

    request.userApartamento = asociacion.apartamento;
    return true;
  }
}
```

Decorador para obtener apartamento:
```typescript
// user-apartment.decorator.ts
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const UserApartment = createParamDecorator(
  (data: unknown, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    return request.userApartamento;
  },
);
```

Uso en servicios:
```typescript
@Injectable()
export class AportesService {
  async findByUser(apartamentoId?: string) {
    return this.aporteRepository.find({
      where: apartamentoId ? { apartamentoId } : {},
    });
  }
}
```

## Testing

- [ ] Residente solo ve sus compromisos
- [ ] Residente solo ve sus aportes
- [ ] Admin ve todos los datos
- [ ] Residente sin apartamento recibe 403
- [ ] No hay fugas de informacion
