# OB-003-C-001: Crear entidad ApartmentResident con TypeORM

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-003 - Gestion de Copropiedades y Apartamentos |
| Story | OB-003-C - Asociacion de usuarios a apartamentos |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2026-01-09 |
| Labels | task, entidad, typeorm, relacion |
| Depends on | OB-003-B-001, OB-002-A-001 |
| Assigned | unassigned |

## Descripcion

Crear la entidad de relacion entre usuarios y apartamentos con TypeORM, permitiendo registrar el tipo de relacion (propietario, arrendatario) y mantener historial.

## Contexto Tecnico

### Archivos a crear
- `apps/api/src/entities/apartment-resident.entity.ts`
- `apps/api/src/migrations/XXXXXX-CreateApartmentResidentsTable.ts`

### Archivos a modificar
- `apps/api/src/entities/apartment.entity.ts` - Agregar relacion residents
- `apps/api/src/entities/index.ts` - Exportar nueva entidad

## Criterios de Aceptacion

- [ ] Entidad ApartmentResident creada con TypeORM
- [ ] Campos: relationType (OWNER/TENANT/OTHER)
- [ ] Estado de la asociacion (PENDING, ACTIVE, INACTIVE, REJECTED)
- [ ] Fechas de inicio y fin de vigencia
- [ ] Un usuario solo puede estar activo en un apartamento a la vez
- [ ] Hereda campos de auditoria de BaseEntity
- [ ] Migracion creada y aplicada

## Notas de Implementacion

### Enums (nombrado en ingles segun CLAUDE.md)

```typescript
// apps/api/src/entities/apartment-resident.entity.ts
export enum RelationType {
  OWNER = 'OWNER',           // Propietario
  TENANT = 'TENANT',         // Arrendatario
  OTHER = 'OTHER',           // Otro
}

export enum AssociationStatus {
  PENDING = 'PENDING',       // Pendiente aprobacion
  ACTIVE = 'ACTIVE',         // Activa
  INACTIVE = 'INACTIVE',     // Inactiva
  REJECTED = 'REJECTED',     // Rechazada
}
```

### Entidad ApartmentResident

```typescript
import { Entity, Column, ManyToOne, JoinColumn, Index } from 'typeorm';
import { BaseEntity } from './base.entity';
import { Apartment } from './apartment.entity';
import { User } from './user.entity';

@Entity('apartment_residents')
@Index('idx_apartment_residents_unique_active', ['apartmentId', 'userId'], {
  unique: true,
  where: "status = 'ACTIVE'"  // Solo una asociacion activa por usuario-apartamento
})
export class ApartmentResident extends BaseEntity {
  @Column({ name: 'apartment_id', type: 'uuid' })
  @Index('idx_apartment_residents_apartment')
  apartmentId!: string;

  @ManyToOne(() => Apartment, (apt) => apt.residents)
  @JoinColumn({ name: 'apartment_id' })
  apartment!: Apartment;

  @Column({ name: 'user_id', type: 'uuid' })
  @Index('idx_apartment_residents_user')
  userId!: string;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'user_id' })
  user!: User;

  @Column({
    name: 'relation_type',
    type: 'varchar',
    length: 20,
  })
  relationType!: RelationType;

  @Column({
    type: 'varchar',
    length: 20,
    default: AssociationStatus.PENDING,
  })
  status!: AssociationStatus;

  @Column({ name: 'start_date', type: 'timestamp with time zone', nullable: true })
  startDate?: Date;

  @Column({ name: 'end_date', type: 'timestamp with time zone', nullable: true })
  endDate?: Date;

  @Column({ name: 'is_primary', type: 'boolean', default: false })
  isPrimary!: boolean;

  @Column({ name: 'approved_by', type: 'uuid', nullable: true })
  approvedBy?: string;

  @Column({ name: 'approved_at', type: 'timestamp with time zone', nullable: true })
  approvedAt?: Date;

  @Column({ name: 'rejection_reason', type: 'text', nullable: true })
  rejectionReason?: string;
}
```

### Agregar relacion en Apartment entity

```typescript
// Agregar a apps/api/src/entities/apartment.entity.ts
@OneToMany(() => ApartmentResident, (ar) => ar.apartment)
residents!: ApartmentResident[];
```

### Mapeo de Nombres

| Documentacion (Espanol) | Implementacion (Ingles) | Columna BD |
|-------------------------|-------------------------|------------|
| apartamentoId | apartmentId | apartment_id |
| tipoRelacion | relationType | relation_type |
| estado | status | status |
| fechaInicio | startDate | start_date |
| fechaFin | endDate | end_date |
| isPrimary | isPrimary | is_primary |
| approvedBy | approvedBy | approved_by |
| approvedAt | approvedAt | approved_at |

### Constraint de Unicidad

Un usuario solo puede tener UNA asociacion ACTIVE por apartamento. Esto permite:
- Mantener historial de asociaciones anteriores (INACTIVE)
- Tener solicitudes pendientes (PENDING) sin conflicto
- Rechazar solicitudes (REJECTED) sin afectar activas

## Testing

- [ ] Entidad se crea correctamente
- [ ] Constraint de unicidad funciona para estado ACTIVE
- [ ] Estados se manejan correctamente
- [ ] Relaciones con User y Apartment funcionan
- [ ] Multiples asociaciones INACTIVE permitidas
