# OB-003-B-004: Validar unicidad de apartamento en copropiedad

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-003 - Gestion de Copropiedades y Apartamentos |
| Story | OB-003-B - Modelo y gestion de apartamentos |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, validacion, unicidad |
| Depends on | OB-003-B-001 |
| Assigned | unassigned |

## Descripcion

Implementar validacion robusta de unicidad de apartamentos considerando diferentes escenarios: con torre, sin torre, y cambios de torre.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/modules/apartamentos/apartamentos.service.ts`
- `apps/api/src/modules/apartamentos/validators/apartamento.validator.ts`

### Enfoque tecnico
Validar unicidad en la capa de servicio NestJS antes de insertar/actualizar. El constraint de BD (TypeORM) es respaldo, pero los mensajes de error deben ser claros.

## Criterios de Aceptacion

- [ ] No se pueden crear dos "101" en la misma torre
- [ ] Se pueden crear dos "101" en torres diferentes
- [ ] Copropiedades sin torres: numero unico en toda la copropiedad
- [ ] Al mover apartamento de torre, validar unicidad
- [ ] Mensajes de error claros y especificos

## Notas de Implementacion

Escenarios de unicidad:
1. **Con torres**: unico por (copropiedadId, torreId, numero)
2. **Sin torres**: unico por (copropiedadId, null, numero)
3. **Mixto**: apartamentos sin torre son globales a la copropiedad

Servicio NestJS con TypeORM:
```typescript
@Injectable()
export class ApartamentosService {
  constructor(
    @InjectRepository(Apartamento)
    private apartamentoRepository: Repository<Apartamento>,
  ) {}

  async validateUniqueness(
    copropiedadId: string,
    numero: string,
    torreId: string | null,
    excludeId?: string
  ): Promise<void> {
    const queryBuilder = this.apartamentoRepository
      .createQueryBuilder('apt')
      .where('apt.copropiedadId = :copropiedadId', { copropiedadId })
      .andWhere('apt.numero = :numero', { numero })
      .andWhere('apt.deletedAt IS NULL');

    if (torreId) {
      queryBuilder.andWhere('apt.torreId = :torreId', { torreId });
    } else {
      queryBuilder.andWhere('apt.torreId IS NULL');
    }

    if (excludeId) {
      queryBuilder.andWhere('apt.id != :excludeId', { excludeId });
    }

    const existing = await queryBuilder.getOne();

    if (existing) {
      const location = torreId
        ? 'en la torre seleccionada'
        : 'en esta copropiedad';
      throw new ConflictException(
        `Ya existe un apartamento ${numero} ${location}`
      );
    }
  }
}
```

## Testing

- [ ] Duplicado exacto falla con mensaje claro
- [ ] Mismo numero en torres diferentes es valido
- [ ] Actualizacion que causa duplicado falla
- [ ] Apartamentos eliminados (soft) no bloquean
