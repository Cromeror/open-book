# OB-003-B-002: Implementar CRUD de apartamentos

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-003 - Gestion de Copropiedades y Apartamentos |
| Story | OB-003-B - Modelo y gestion de apartamentos |
| Status | pending |
| Priority | critical |
| Created | 2025-12-31 |
| Updated | 2026-01-09 |
| Labels | task, api, crud, apartamento |
| Depends on | OB-003-B-001 |
| Assigned | unassigned |

## Descripcion

Implementar endpoints REST para el CRUD de apartamentos, anidados bajo la copropiedad correspondiente. Los endpoints de gestion deben estar bajo `/admin/`.

## Contexto Tecnico

### Archivos a crear
- `apps/api/src/modules/admin/apartments/apartments.module.ts`
- `apps/api/src/modules/admin/apartments/apartments.controller.ts`
- `apps/api/src/modules/admin/apartments/apartments.service.ts`
- `apps/api/src/modules/admin/apartments/dto/create-apartment.dto.ts`
- `apps/api/src/modules/admin/apartments/dto/update-apartment.dto.ts`
- `apps/api/src/modules/admin/apartments/dto/filter-apartments.dto.ts`

### Archivos a modificar
- `apps/api/src/modules/admin/admin.module.ts` - Registrar ApartmentsModule

### Infraestructura existente
- AdminModule con RouterModule para prefijo `/admin`
- Sistema de permisos con `@RequirePermission()` y `@RequireModule()`
- Patron de GoalsModule como referencia

## Criterios de Aceptacion

- [ ] POST /admin/condominiums/:condoId/apartments - Crear
- [ ] GET /admin/condominiums/:condoId/apartments - Listar (paginado)
- [ ] GET /admin/condominiums/:condoId/apartments/:id - Obtener uno
- [ ] PATCH /admin/condominiums/:condoId/apartments/:id - Actualizar
- [ ] DELETE /admin/condominiums/:condoId/apartments/:id - Soft delete
- [ ] Filtros: por towerId, isActive, floor
- [ ] Requiere permiso `apartments:create|read|update|delete`

## Notas de Implementacion

### Estructura de Endpoints

```
# Admin endpoints (bajo RouterModule /admin)
POST   /admin/condominiums/:condoId/apartments           - Crear
GET    /admin/condominiums/:condoId/apartments           - Listar con paginacion y filtros
GET    /admin/condominiums/:condoId/apartments/:id       - Obtener uno
PATCH  /admin/condominiums/:condoId/apartments/:id       - Actualizar
DELETE /admin/condominiums/:condoId/apartments/:id       - Soft delete
```

### DTOs

```typescript
// create-apartment.dto.ts
import { IsString, IsOptional, IsNumber, IsUUID, MaxLength, Min } from 'class-validator';

export class CreateApartmentDto {
  @IsString()
  @MaxLength(20)
  number: string;

  @IsOptional()
  @IsNumber()
  @Min(0)
  floor?: number;

  @IsOptional()
  @IsUUID()
  towerId?: string;
}

// filter-apartments.dto.ts
export class FilterApartmentsDto extends PaginationDto {
  @IsOptional()
  @IsUUID()
  towerId?: string;

  @IsOptional()
  @IsBoolean()
  @Transform(({ value }) => value === 'true')
  isActive?: boolean;

  @IsOptional()
  @IsNumber()
  @Transform(({ value }) => parseInt(value))
  floor?: number;
}
```

### Controller

```typescript
@Controller('condominiums/:condominiumId/apartments')
@UseGuards(JwtAuthGuard, PermissionsGuard)
@RequireModule('apartments')
export class ApartmentsController {
  @Post()
  @RequirePermission('apartments:create')
  async create(
    @Param('condominiumId', ParseUUIDPipe) condominiumId: string,
    @Body() dto: CreateApartmentDto,
    @CurrentUser() user: User
  ) {
    return this.service.create(condominiumId, dto, user.id);
  }

  @Get()
  @RequirePermission('apartments:read')
  async findAll(
    @Param('condominiumId', ParseUUIDPipe) condominiumId: string,
    @Query() query: FilterApartmentsDto
  ) {
    return this.service.findAll(condominiumId, query);
  }
  // ... resto de metodos
}
```

### Registrar en AdminModule

```typescript
// apps/api/src/modules/admin/admin.module.ts
RouterModule.register([
  {
    path: 'admin',
    children: [
      { path: 'users', module: UsersModule },
      { path: 'condominiums', module: CondominiumsModule },
      { path: 'condominiums/:condominiumId/apartments', module: ApartmentsModule },
    ],
  },
]),
```

### Response Listar

```json
{
  "data": [
    {
      "id": "uuid",
      "number": "101",
      "floor": 1,
      "tower": { "id": "uuid", "name": "Tower A" },
      "isActive": true,
      "createdAt": "2026-01-01T00:00:00Z"
    }
  ],
  "meta": {
    "total": 50,
    "page": 1,
    "limit": 20,
    "totalPages": 3
  }
}
```

## Testing

- [ ] CRUD funciona correctamente
- [ ] Filtros funcionan (towerId, isActive, floor)
- [ ] Paginacion funciona
- [ ] Sin permiso adecuado recibe 403
- [ ] Validacion de datos funciona
- [ ] condominiumId invalido retorna 404
