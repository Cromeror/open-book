# OB-010-D-002: Procesar cambio al aprobar PQR

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-010 - Sistema de PQR |
| Story | OB-010-D - Integracion con visibilidad de estados |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, automatizacion, visibilidad |
| Depends on | OB-010-D-001, OB-011-B |
| Assigned | unassigned |

## Descripcion

Cuando admin aprueba PQR de visibilidad, ejecutar automaticamente el cambio.

## Criterios de Aceptacion

- [ ] Al responder con aprobacion, se ejecuta cambio
- [ ] Se registra el cambio con referencia a la PQR
- [ ] Se notifica al usuario del cambio efectuado
- [ ] Auditoria completa con justificacion = PQR

## Notas de Implementacion

Al responder PQR de visibilidad con aprobacion:
```typescript
async function procesarRespuestaPQRVisibilidad(pqrId: string, aprobado: boolean) {
  const pqr = await typeorm.pQR.findUnique({ where: { id: pqrId } });

  if (pqr.categoria === 'VISIBILIDAD' && aprobado) {
    const metadatos = pqr.metadatos as VisibilidadMetadatos;

    await visibilidadService.cambiarVisibilidad({
      userId: pqr.userId,
      nuevaVisibilidad: metadatos.visibilidadSolicitada,
      justificacion: `Aprobado via PQR ${pqr.radicado}`,
      aprobadoPor: currentUserId,
      pqrId: pqr.id
    });
  }
}
```

## Testing

- [ ] Cambio se ejecuta al aprobar
- [ ] No se ejecuta si se rechaza
- [ ] Auditoria tiene referencia a PQR
