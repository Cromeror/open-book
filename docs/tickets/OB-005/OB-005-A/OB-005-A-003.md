# OB-005-A-003: Validar asociacion con objetivo activo

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-005 - Actividades de Recaudo |
| Story | OB-005-A - Modelo y CRUD de actividades |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, validacion, negocio |
| Depends on | OB-005-A-002 |
| Assigned | unassigned |

## Descripcion

Implementar validaciones de negocio para actividades, especialmente la validacion de que solo se pueden crear actividades en objetivos activos.

## Contexto Tecnico

### Archivos afectados
- `src/services/actividad.service.ts`
- `src/api/validators/actividad.validator.ts`

### Enfoque tecnico
Validaciones en capa de servicio que verifican el estado del objetivo antes de crear/modificar actividades.

## Criterios de Aceptacion

- [ ] Solo crear actividades en objetivos ACTIVOS
- [ ] No eliminar actividades con compromisos asociados
- [ ] No eliminar actividades con aportes asociados
- [ ] Fechas de actividad dentro del rango del objetivo
- [ ] Mensajes de error claros

## Notas de Implementacion

```typescript
async function validateActividadCreation(
  objetivoId: string,
  data: CreateActividadDto
): Promise<void> {
  const objetivo = await typeorm.objetivo.findUnique({
    where: { id: objetivoId }
  });

  if (!objetivo) {
    throw new NotFoundError('Objetivo no encontrado');
  }

  if (objetivo.estado !== 'ACTIVO') {
    throw new BusinessError(
      'Solo se pueden crear actividades en objetivos activos'
    );
  }

  // Validar fechas dentro del rango del objetivo
  if (data.fechaInicio < objetivo.fechaInicio) {
    throw new BusinessError(
      'La fecha de inicio no puede ser anterior a la del objetivo'
    );
  }

  if (objetivo.fechaFin && data.fechaFin && data.fechaFin > objetivo.fechaFin) {
    throw new BusinessError(
      'La fecha fin no puede ser posterior a la del objetivo'
    );
  }
}

async function canDeleteActividad(actividadId: string): Promise<void> {
  const compromisos = await typeorm.compromiso.count({
    where: { actividadId }
  });

  if (compromisos > 0) {
    throw new BusinessError(
      'No se puede eliminar una actividad con compromisos asociados'
    );
  }
}
```

## Testing

- [ ] Crear en objetivo no activo falla
- [ ] Fechas fuera de rango del objetivo falla
- [ ] Eliminar con compromisos falla
- [ ] Eliminar con aportes falla
