# OB-005-B-003: Implementar cambio de estado de actividad

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-005 - Actividades de Recaudo |
| Story | OB-005-B - Tipos y configuracion de actividades |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, estados, workflow |
| Depends on | OB-005-A-002 |
| Assigned | unassigned |

## Descripcion

Implementar la gestion de estados de actividades (ACTIVA, PAUSADA, FINALIZADA, CANCELADA) con transiciones validas y registro de historial.

## Contexto Tecnico

### Archivos afectados
- `src/domain/activity-state-machine.ts`
- `src/api/routes/activities.routes.ts`
- `src/services/activity.service.ts`

### Enfoque tecnico
Maquina de estados similar a objetivos pero para actividades.

## Criterios de Aceptacion

- [ ] Estados: ACTIVA, PAUSADA, FINALIZADA, CANCELADA
- [ ] Endpoint PATCH /api/.../activities/:id/status
- [ ] Transiciones validas definidas y validadas
- [ ] Historial de cambios de estado
- [ ] No se pueden crear aportes en actividades no activas

## Notas de Implementacion

Transiciones:
```
ACTIVA
  -> PAUSADA
  -> FINALIZADA
  -> CANCELADA

PAUSADA
  -> ACTIVA
  -> CANCELADA

FINALIZADA -> (terminal)
CANCELADA -> (terminal)
```

Request:
```
PATCH /api/condominiums/:condoId/objectives/:objId/activities/:id/status
Body: {
  "newStatus": "COMPLETED",
  "justification": "Rifa realizada exitosamente el 15/04"
}
```

Validaciones adicionales:
- Al finalizar actividad, verificar si hay compromisos pendientes
- Al pausar, los nuevos aportes quedan bloqueados
- Al cancelar, considerar que hacer con compromisos pendientes

## Testing

- [ ] Transiciones validas funcionan
- [ ] Transiciones invalidas son rechazadas
- [ ] Estados terminales no permiten transicion
- [ ] Historial se registra correctamente
