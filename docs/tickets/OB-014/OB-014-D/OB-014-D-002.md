# OB-014-D-002: Implementar HOC withRole

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Rol de Usuario |
| Story | OB-014-D - Componentes compartidos y utilidades de rol |
| Status | pending |
| Priority | medium |
| Created | 2026-01-05 |
| Updated | 2026-01-05 |
| Labels | task, frontend, hoc, utility |
| Depends on | OB-014-A-002 |
| Assigned | unassigned |

## Descripcion

Crear Higher-Order Component para proteger componentes completos segun rol, util para paginas o secciones grandes.

## Contexto Tecnico

### Archivos afectados
- `apps/web/src/components/hoc/withRole.tsx`
- `apps/web/src/components/hoc/withAuth.tsx`

### Enfoque tecnico
HOC que envuelve componentes y verifica autenticacion/rol antes de renderizar.

## Criterios de Aceptacion

- [ ] withAuth HOC verifica autenticacion
- [ ] withRole HOC verifica rol especifico
- [ ] Redireccion configurable
- [ ] Loading state mientras verifica

## Notas de Implementacion

```typescript
// components/hoc/withAuth.tsx
'use client';

import { useAuth } from '@/hooks/useAuth';
import { useRouter } from 'next/navigation';
import { useEffect, ComponentType } from 'react';

interface WithAuthOptions {
  redirectTo?: string;
}

export function withAuth<P extends object>(
  WrappedComponent: ComponentType<P>,
  options: WithAuthOptions = {}
) {
  const { redirectTo = '/login' } = options;

  return function WithAuthComponent(props: P) {
    const { isAuthenticated, isLoading } = useAuth();
    const router = useRouter();

    useEffect(() => {
      if (!isLoading && !isAuthenticated) {
        router.push(redirectTo);
      }
    }, [isLoading, isAuthenticated, router]);

    if (isLoading) {
      return <div>Cargando...</div>;
    }

    if (!isAuthenticated) {
      return null;
    }

    return <WrappedComponent {...props} />;
  };
}

// components/hoc/withRole.tsx
'use client';

import { useAuth } from '@/hooks/useAuth';
import { Role } from '@/types/auth';
import { useRouter } from 'next/navigation';
import { useEffect, ComponentType } from 'react';

interface WithRoleOptions {
  allowedRoles: Role[];
  redirectTo?: string;
}

export function withRole<P extends object>(
  WrappedComponent: ComponentType<P>,
  options: WithRoleOptions
) {
  const { allowedRoles, redirectTo = '/acceso-denegado' } = options;

  return function WithRoleComponent(props: P) {
    const { user, isLoading } = useAuth();
    const router = useRouter();

    const hasAccess = user && allowedRoles.includes(user.role);

    useEffect(() => {
      if (!isLoading && !hasAccess) {
        router.push(redirectTo);
      }
    }, [isLoading, hasAccess, router]);

    if (isLoading) {
      return <div>Verificando permisos...</div>;
    }

    if (!hasAccess) {
      return null;
    }

    return <WrappedComponent {...props} />;
  };
}

// Uso:
// const AdminOnlyPage = withRole(MyComponent, {
//   allowedRoles: [Role.ADMIN],
// });
```

## Testing

- [ ] withAuth redirige si no autenticado
- [ ] withRole redirige si rol no permitido
- [ ] Componente se renderiza si tiene acceso
