# OB-014-E-001: Definir tipos y constantes de permisos

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Rol y Sistema de Permisos Granulares |
| Story | OB-014-E - Sistema de permisos granulares |
| Status | pending |
| Priority | high |
| Created | 2026-01-05 |
| Updated | 2026-01-05 |
| Labels | task, frontend, permissions, types |
| Depends on | - |
| Assigned | unassigned |

## Descripcion

Crear los tipos TypeScript y constantes para el sistema de permisos granulares. Esto incluye la definicion de recursos, acciones, permisos y la matriz de permisos por rol.

## Contexto Tecnico

### Archivos afectados
- `apps/web/src/lib/permissions.types.ts`
- `apps/web/src/lib/permissions.ts`
- `apps/web/src/lib/permissions.constants.ts`

### Enfoque tecnico
Definir tipos estrictos para recursos y acciones, usando template literal types para permisos. Crear constantes inmutables para permisos y matriz de roles.

## Criterios de Aceptacion

- [ ] Tipo Resource con todos los recursos del sistema
- [ ] Tipo Action con todas las acciones disponibles
- [ ] Tipo Permission como combinacion recurso:accion
- [ ] Constantes RESOURCES y ACTIONS exportadas
- [ ] Constante PERMISSIONS con todos los permisos
- [ ] Matriz ROLE_PERMISSIONS con permisos por rol
- [ ] Funciones helper para validacion de permisos
- [ ] Sincronizado con permisos del backend

## Notas de Implementacion

```typescript
// lib/permissions.types.ts
export const RESOURCES = [
  'users',
  'copropiedades',
  'apartamentos',
  'objetivos',
  'actividades',
  'compromisos',
  'aportes',
  'pqr',
  'reportes',
  'auditoria',
  'configuracion',
] as const;

export type Resource = typeof RESOURCES[number];

export const ACTIONS = [
  'create',
  'read',
  'update',
  'delete',
  'approve',
  'export',
  'manage',
  '*',
] as const;

export type Action = typeof ACTIONS[number];

export type Permission = `${Resource}:${Action}`;

// lib/permissions.constants.ts
import { Permission, Resource, Action } from './permissions.types';

export const PERMISSIONS = {
  // Users
  USERS_CREATE: 'users:create',
  USERS_READ: 'users:read',
  USERS_UPDATE: 'users:update',
  USERS_DELETE: 'users:delete',
  USERS_MANAGE: 'users:*',

  // Copropiedades
  COPROPIEDADES_CREATE: 'copropiedades:create',
  COPROPIEDADES_READ: 'copropiedades:read',
  COPROPIEDADES_UPDATE: 'copropiedades:update',
  COPROPIEDADES_DELETE: 'copropiedades:delete',
  COPROPIEDADES_MANAGE: 'copropiedades:*',

  // Objetivos
  OBJETIVOS_CREATE: 'objetivos:create',
  OBJETIVOS_READ: 'objetivos:read',
  OBJETIVOS_UPDATE: 'objetivos:update',
  OBJETIVOS_DELETE: 'objetivos:delete',
  OBJETIVOS_APPROVE: 'objetivos:approve',
  OBJETIVOS_MANAGE: 'objetivos:*',

  // Aportes
  APORTES_CREATE: 'aportes:create',
  APORTES_READ: 'aportes:read',
  APORTES_UPDATE: 'aportes:update',
  APORTES_EXPORT: 'aportes:export',
  APORTES_MANAGE: 'aportes:*',

  // PQR
  PQR_CREATE: 'pqr:create',
  PQR_READ: 'pqr:read',
  PQR_UPDATE: 'pqr:update',
  PQR_MANAGE: 'pqr:manage',

  // Reportes
  REPORTES_READ: 'reportes:read',
  REPORTES_EXPORT: 'reportes:export',
  REPORTES_MANAGE: 'reportes:*',

  // Auditoria
  AUDITORIA_READ: 'auditoria:read',

  // Configuracion
  CONFIGURACION_READ: 'configuracion:read',
  CONFIGURACION_UPDATE: 'configuracion:update',
  CONFIGURACION_MANAGE: 'configuracion:*',
} as const satisfies Record<string, Permission>;

// lib/permissions.ts
import { Permission } from './permissions.types';
import { PERMISSIONS } from './permissions.constants';

export enum UserRole {
  ADMIN = 'ADMIN',
  RESIDENT = 'RESIDENT',
}

export const ROLE_PERMISSIONS: Record<UserRole, Permission[]> = {
  [UserRole.ADMIN]: [
    PERMISSIONS.USERS_MANAGE,
    PERMISSIONS.COPROPIEDADES_MANAGE,
    PERMISSIONS.OBJETIVOS_MANAGE,
    PERMISSIONS.APORTES_MANAGE,
    PERMISSIONS.PQR_MANAGE,
    PERMISSIONS.REPORTES_MANAGE,
    PERMISSIONS.AUDITORIA_READ,
    PERMISSIONS.CONFIGURACION_MANAGE,
  ],
  [UserRole.RESIDENT]: [
    PERMISSIONS.COPROPIEDADES_READ,
    PERMISSIONS.OBJETIVOS_READ,
    PERMISSIONS.APORTES_READ,
    PERMISSIONS.PQR_CREATE,
    PERMISSIONS.PQR_READ,
  ],
};

/**
 * Check if a permission matches (including wildcards)
 */
export function permissionMatches(
  userPermissions: Permission[],
  requiredPermission: Permission
): boolean {
  const [resource, action] = requiredPermission.split(':') as [Resource, Action];

  // Check exact match
  if (userPermissions.includes(requiredPermission)) {
    return true;
  }

  // Check wildcard match (resource:*)
  const wildcardPermission = `${resource}:*` as Permission;
  if (userPermissions.includes(wildcardPermission)) {
    return true;
  }

  return false;
}

/**
 * Get all permissions for a role
 */
export function getPermissionsForRole(role: UserRole): Permission[] {
  return ROLE_PERMISSIONS[role] ?? [];
}
```

## Testing

- [ ] Tipos compilan sin errores
- [ ] PERMISSIONS contiene todos los permisos necesarios
- [ ] ROLE_PERMISSIONS asigna permisos correctos por rol
- [ ] permissionMatches funciona con permisos exactos
- [ ] permissionMatches funciona con wildcards
