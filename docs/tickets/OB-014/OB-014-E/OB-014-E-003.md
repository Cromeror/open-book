# OB-014-E-003: Crear componentes Can, CanAny, CanAll

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Rol y Sistema de Permisos Granulares |
| Story | OB-014-E - Sistema de permisos granulares |
| Status | pending |
| Priority | high |
| Created | 2026-01-05 |
| Updated | 2026-01-05 |
| Labels | task, frontend, permissions, components |
| Depends on | OB-014-E-002 |
| Assigned | unassigned |

## Descripcion

Crear componentes declarativos para renderizado condicional basado en permisos. Estos componentes encapsulan la logica del hook usePermissions y proporcionan una API limpia para mostrar/ocultar elementos de UI.

## Contexto Tecnico

### Archivos afectados
- `apps/web/src/components/permissions/Can.tsx`
- `apps/web/src/components/permissions/CanAny.tsx`
- `apps/web/src/components/permissions/CanAll.tsx`
- `apps/web/src/components/permissions/index.ts`

### Enfoque tecnico
Componentes wrapper que usan usePermissions internamente. Soportan children como ReactNode o render props para casos avanzados. Incluyen prop `fallback` opcional para contenido alternativo.

## Criterios de Aceptacion

- [ ] Componente Can para verificar un permiso
- [ ] Componente CanAny para verificar al menos uno
- [ ] Componente CanAll para verificar todos
- [ ] Soporte para children como ReactNode
- [ ] Soporte para render props (children como funcion)
- [ ] Prop `fallback` opcional para contenido alternativo
- [ ] TypeScript estricto con tipos exportados
- [ ] Tests unitarios con React Testing Library

## Notas de Implementacion

```typescript
// components/permissions/Can.tsx
import { ReactNode } from 'react';
import { usePermissions } from '@/hooks/usePermissions';
import { Permission } from '@/lib/permissions';

export interface CanProps {
  /** Permission to check */
  permission: Permission;
  /** Content to render if permission is granted */
  children: ReactNode | ((hasPermission: boolean) => ReactNode);
  /** Content to render if permission is denied */
  fallback?: ReactNode;
}

export function Can({ permission, children, fallback = null }: CanProps): ReactNode {
  const { can } = usePermissions();
  const hasPermission = can(permission);

  if (typeof children === 'function') {
    return children(hasPermission);
  }

  return hasPermission ? children : fallback;
}

// components/permissions/CanAny.tsx
import { ReactNode } from 'react';
import { usePermissions } from '@/hooks/usePermissions';
import { Permission } from '@/lib/permissions';

export interface CanAnyProps {
  /** Permissions to check (at least one required) */
  permissions: Permission[];
  /** Content to render if any permission is granted */
  children: ReactNode | ((hasPermission: boolean) => ReactNode);
  /** Content to render if no permission is granted */
  fallback?: ReactNode;
}

export function CanAny({ permissions, children, fallback = null }: CanAnyProps): ReactNode {
  const { canAny } = usePermissions();
  const hasPermission = canAny(permissions);

  if (typeof children === 'function') {
    return children(hasPermission);
  }

  return hasPermission ? children : fallback;
}

// components/permissions/CanAll.tsx
import { ReactNode } from 'react';
import { usePermissions } from '@/hooks/usePermissions';
import { Permission } from '@/lib/permissions';

export interface CanAllProps {
  /** Permissions to check (all required) */
  permissions: Permission[];
  /** Content to render if all permissions are granted */
  children: ReactNode | ((hasPermission: boolean) => ReactNode);
  /** Content to render if any permission is missing */
  fallback?: ReactNode;
}

export function CanAll({ permissions, children, fallback = null }: CanAllProps): ReactNode {
  const { canAll } = usePermissions();
  const hasPermission = canAll(permissions);

  if (typeof children === 'function') {
    return children(hasPermission);
  }

  return hasPermission ? children : fallback;
}

// components/permissions/index.ts
export { Can, type CanProps } from './Can';
export { CanAny, type CanAnyProps } from './CanAny';
export { CanAll, type CanAllProps } from './CanAll';
```

### Ejemplos de Uso

```tsx
// Uso basico
<Can permission="users:create">
  <button>Crear Usuario</button>
</Can>

// Con fallback
<Can permission="reportes:export" fallback={<span>Sin permiso</span>}>
  <button>Exportar Reporte</button>
</Can>

// Con render prop
<Can permission="objetivos:approve">
  {(canApprove) => (
    <button disabled={!canApprove}>
      {canApprove ? 'Aprobar' : 'Sin permiso para aprobar'}
    </button>
  )}
</Can>

// Multiples permisos (cualquiera)
<CanAny permissions={['reportes:read', 'reportes:export']}>
  <ReportesSection />
</CanAny>

// Multiples permisos (todos)
<CanAll permissions={['users:create', 'users:update']}>
  <UserManagement />
</CanAll>
```

## Testing

- [ ] Can renderiza children cuando tiene permiso
- [ ] Can renderiza fallback cuando no tiene permiso
- [ ] Can funciona con render props
- [ ] CanAny renderiza cuando tiene al menos un permiso
- [ ] CanAny no renderiza cuando no tiene ningun permiso
- [ ] CanAll renderiza solo cuando tiene todos los permisos
- [ ] Componentes manejan usuario no autenticado
