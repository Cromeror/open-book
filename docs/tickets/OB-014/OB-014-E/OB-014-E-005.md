# OB-014-E-005: Registrar modulos especializados

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Permisos y Modulos |
| Story | OB-014-E - Sistema de Permisos Gobernado por Backend |
| Status | pending |
| Priority | medium |
| Created | 2026-01-06 |
| Updated | 2026-01-06 |
| Labels | task, frontend, modules, specialized |
| Depends on | OB-014-E-002, OB-014-E-003 |

## Descripcion

Crear modulos especializados que requieren UI compleja. Se construyen en frontend pero se registran en backend para aparecer en navegacion y respetar permisos.

## Modulos Especializados

| Codigo | Componente | Descripcion |
|--------|------------|-------------|
| `reports` | ReportsModule | Graficos, dashboards, exportacion |
| `audit` | AuditModule | Log de auditoria, filtros avanzados |
| `settings` | SettingsModule | Configuracion del sistema |

## Estructura

```
apps/web/src/modules/
├── reports/
│   ├── index.ts
│   ├── ReportsModule.tsx
│   └── components/
│       ├── ContributionsChart.tsx
│       ├── ProgressChart.tsx
│       └── ExportDialog.tsx
├── audit/
│   ├── index.ts
│   ├── AuditModule.tsx
│   └── components/
│       ├── AuditTable.tsx
│       └── AuditFilters.tsx
├── settings/
│   ├── index.ts
│   └── SettingsModule.tsx
└── index.ts
```

## Implementacion

### 1. Registro de Modulos (apps/web/src/modules/index.ts)

```typescript
import { moduleRegistry } from '@/lib/module-registry';

// Lazy loading de modulos especializados
const ReportsModule = lazy(() => import('./reports').then(m => ({ default: m.ReportsModule })));
const AuditModule = lazy(() => import('./audit').then(m => ({ default: m.AuditModule })));
const SettingsModule = lazy(() => import('./settings').then(m => ({ default: m.SettingsModule })));

export function registerSpecializedModules(): void {
  moduleRegistry.register('reports', ReportsModule);
  moduleRegistry.register('audit', AuditModule);
  moduleRegistry.register('settings', SettingsModule);
}
```

### 2. ReportsModule

```typescript
// apps/web/src/modules/reports/ReportsModule.tsx
import type { ModuleProps } from '@/lib/types/modules';
import { ContributionsChart } from './components/ContributionsChart';
import { ProgressChart } from './components/ProgressChart';
import { ExportDialog } from './components/ExportDialog';
import { ModuleHeader } from '@/components/modules/ModuleHeader';
import { Button } from '@/components/ui/button';
import { Download } from 'lucide-react';
import { useState } from 'react';

export function ReportsModule({ moduleCode, metadata }: ModuleProps) {
  const [showExport, setShowExport] = useState(false);
  // Verificar accion por codigo (codigo accion = codigo permiso)
  const canExport = metadata.actions.some(a => a.code === 'export');

  return (
    <div className="space-y-6">
      <ModuleHeader
        title={metadata.label}
        description={metadata.description}
        actions={
          canExport && (
            <Button onClick={() => setShowExport(true)}>
              <Download className="w-4 h-4 mr-2" />
              Exportar
            </Button>
          )
        }
      />

      <div className="grid gap-6 md:grid-cols-2">
        <ContributionsChart />
        <ProgressChart />
      </div>

      {/* Resumen de metricas */}
      <div className="grid gap-4 md:grid-cols-4">
        <MetricCard title="Total Recaudado" value="$15,250,000" />
        <MetricCard title="Objetivos Activos" value="5" />
        <MetricCard title="Aportes este Mes" value="23" />
        <MetricCard title="% Cumplimiento" value="68%" />
      </div>

      {showExport && (
        <ExportDialog
          onClose={() => setShowExport(false)}
        />
      )}
    </div>
  );
}

function MetricCard({ title, value }: { title: string; value: string }) {
  return (
    <div className="p-4 bg-white rounded-lg border">
      <p className="text-sm text-gray-500">{title}</p>
      <p className="text-2xl font-bold">{value}</p>
    </div>
  );
}
```

### 3. AuditModule

```typescript
// apps/web/src/modules/audit/AuditModule.tsx
import type { ModuleProps } from '@/lib/types/modules';
import { AuditTable } from './components/AuditTable';
import { AuditFilters } from './components/AuditFilters';
import { ModuleHeader } from '@/components/modules/ModuleHeader';
import { useState } from 'react';

interface AuditFilters {
  entity?: string;
  action?: string;
  userId?: string;
  dateFrom?: string;
  dateTo?: string;
}

export function AuditModule({ moduleCode, metadata }: ModuleProps) {
  const [filters, setFilters] = useState<AuditFilters>({});

  return (
    <div className="space-y-6">
      <ModuleHeader
        title={metadata.label}
        description={metadata.description}
      />

      <AuditFilters
        filters={filters}
        onChange={setFilters}
      />

      <AuditTable filters={filters} />
    </div>
  );
}
```

### 4. SettingsModule

```typescript
// apps/web/src/modules/settings/SettingsModule.tsx
import type { ModuleProps } from '@/lib/types/modules';
import { ModuleHeader } from '@/components/modules/ModuleHeader';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';

export function SettingsModule({ moduleCode, metadata }: ModuleProps) {
  // Verificar accion por codigo (codigo accion = codigo permiso)
  const canManage = metadata.actions.some(a => a.code === 'manage');

  return (
    <div className="space-y-6">
      <ModuleHeader
        title={metadata.label}
        description={metadata.description}
      />

      <Tabs defaultValue="general">
        <TabsList>
          <TabsTrigger value="general">General</TabsTrigger>
          <TabsTrigger value="notifications">Notificaciones</TabsTrigger>
          {canManage && <TabsTrigger value="advanced">Avanzado</TabsTrigger>}
        </TabsList>

        <TabsContent value="general">
          <GeneralSettings />
        </TabsContent>

        <TabsContent value="notifications">
          <NotificationSettings />
        </TabsContent>

        {canManage && (
          <TabsContent value="advanced">
            <AdvancedSettings />
          </TabsContent>
        )}
      </Tabs>
    </div>
  );
}

function GeneralSettings() {
  return (
    <div className="p-4 bg-white rounded-lg border">
      <h3 className="font-medium mb-4">Configuracion General</h3>
      {/* Formularios de configuracion */}
    </div>
  );
}

function NotificationSettings() {
  return (
    <div className="p-4 bg-white rounded-lg border">
      <h3 className="font-medium mb-4">Preferencias de Notificaciones</h3>
      {/* Opciones de notificaciones */}
    </div>
  );
}

function AdvancedSettings() {
  return (
    <div className="p-4 bg-white rounded-lg border">
      <h3 className="font-medium mb-4">Configuracion Avanzada</h3>
      {/* Solo visible con permiso 'manage' */}
    </div>
  );
}
```

### 5. Registro en Backend

Los modulos especializados deben existir en la tabla `modules` del backend con `actions_config`:

```sql
INSERT INTO modules (code, label, description, icon, type, component, actions_config, nav_config, "order") VALUES
('reports', 'Reportes', 'Visualiza reportes y estadisticas de la copropiedad', 'BarChart3', 'specialized',
 'ReportsModule',
 '[{"code": "view", "label": "Ver reportes", "description": "Visualizar reportes", "settings": {"type": "generic"}}, {"code": "export", "label": "Exportar", "description": "Exportar a PDF/Excel", "settings": {"type": "generic", "formats": ["pdf", "excel", "csv"]}}]',
 '{"path": "/reports", "order": 60}', 60),
('audit', 'Auditoria', 'Log de auditoria del sistema', 'FileText', 'specialized',
 'AuditModule',
 '[{"code": "view", "label": "Ver logs", "description": "Ver log de auditoria", "settings": {"type": "generic"}}, {"code": "search", "label": "Buscar", "description": "Buscar en logs", "settings": {"type": "generic"}}]',
 '{"path": "/audit", "order": 80}', 80),
('settings', 'Configuracion', 'Configuracion del sistema', 'Settings', 'specialized',
 'SettingsModule',
 '[{"code": "view", "label": "Ver configuracion", "description": "Ver configuracion", "settings": {"type": "generic"}}, {"code": "manage", "label": "Administrar", "description": "Modificar configuracion", "settings": {"type": "generic"}}]',
 '{"path": "/settings", "order": 90}', 90);
```

### 6. Inicializacion en App

```typescript
// apps/web/src/app/layout.tsx o similar
import { registerSpecializedModules } from '@/modules';

// Registrar al iniciar
registerSpecializedModules();
```

## Criterios de Aceptacion

- [ ] ReportsModule con graficos de contribuciones y progreso
- [ ] AuditModule con filtros y tabla de logs
- [ ] SettingsModule con tabs y verificacion de acciones
- [ ] Todos registrados en moduleRegistry con defaultActions
- [ ] Registrados en backend con type='specialized' y actions_config
- [ ] Verificacion de acciones via `metadata.actions.some(a => a.code === 'xxx')`
- [ ] Code splitting (lazy loading)
- [ ] Acciones respetadas dentro de cada modulo (codigo accion = codigo permiso)
- [ ] Tests de componentes
