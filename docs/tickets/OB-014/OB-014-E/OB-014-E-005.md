# OB-014-E-005: Integrar permisos en navegacion

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Rol y Sistema de Permisos Granulares |
| Story | OB-014-E - Sistema de permisos granulares |
| Status | pending |
| Priority | medium |
| Created | 2026-01-05 |
| Updated | 2026-01-05 |
| Labels | task, frontend, permissions, navigation |
| Depends on | OB-014-E-002, OB-014-E-003 |
| Assigned | unassigned |

## Descripcion

Integrar el sistema de permisos granulares en el componente de navegacion principal. Los items del menu deben mostrarse/ocultarse basado en los permisos del usuario, y las rutas deben estar protegidas.

## Contexto Tecnico

### Archivos afectados
- `apps/web/src/components/layout/Navigation.tsx`
- `apps/web/src/components/layout/Sidebar.tsx`
- `apps/web/src/config/navigation.ts`

### Enfoque tecnico
Definir configuracion de navegacion con permisos requeridos por ruta. Filtrar items visibles usando usePermissions. Usar componentes Can para renderizado condicional de elementos de menu.

## Criterios de Aceptacion

- [ ] Configuracion de navegacion con permisos por item
- [ ] Items de menu se filtran segun permisos del usuario
- [ ] Submenu se oculta si usuario no tiene ningun permiso hijo
- [ ] Indicadores visuales para secciones restringidas
- [ ] Navegacion responsive respeta permisos
- [ ] Tests de integracion

## Notas de Implementacion

### Configuracion de Navegacion

```typescript
// config/navigation.ts
import { Permission } from '@/lib/permissions';
import { PERMISSIONS } from '@/lib/permissions.constants';
import {
  HomeIcon,
  UsersIcon,
  BuildingOfficeIcon,
  ChartBarIcon,
  CurrencyDollarIcon,
  ChatBubbleLeftRightIcon,
  DocumentChartBarIcon,
  ClipboardDocumentListIcon,
  CogIcon,
} from '@heroicons/react/24/outline';

export interface NavItem {
  label: string;
  href: string;
  icon: React.ComponentType<{ className?: string }>;
  /** Permission(s) required to see this item */
  permissions?: Permission | Permission[];
  /** If true, requires all permissions. Default: false (any) */
  requireAll?: boolean;
  /** Nested items */
  children?: NavItem[];
}

export const navigationConfig: NavItem[] = [
  {
    label: 'Inicio',
    href: '/dashboard',
    icon: HomeIcon,
    // No permissions = visible for all authenticated users
  },
  {
    label: 'Usuarios',
    href: '/admin/usuarios',
    icon: UsersIcon,
    permissions: PERMISSIONS.USERS_READ,
  },
  {
    label: 'Copropiedades',
    href: '/copropiedades',
    icon: BuildingOfficeIcon,
    permissions: PERMISSIONS.COPROPIEDADES_READ,
  },
  {
    label: 'Objetivos',
    href: '/objetivos',
    icon: ChartBarIcon,
    permissions: PERMISSIONS.OBJETIVOS_READ,
    children: [
      {
        label: 'Lista de Objetivos',
        href: '/objetivos',
        icon: ChartBarIcon,
        permissions: PERMISSIONS.OBJETIVOS_READ,
      },
      {
        label: 'Crear Objetivo',
        href: '/objetivos/nuevo',
        icon: ChartBarIcon,
        permissions: PERMISSIONS.OBJETIVOS_CREATE,
      },
      {
        label: 'Aprobar Objetivos',
        href: '/objetivos/aprobar',
        icon: ChartBarIcon,
        permissions: PERMISSIONS.OBJETIVOS_APPROVE,
      },
    ],
  },
  {
    label: 'Aportes',
    href: '/aportes',
    icon: CurrencyDollarIcon,
    permissions: PERMISSIONS.APORTES_READ,
  },
  {
    label: 'PQR',
    href: '/pqr',
    icon: ChatBubbleLeftRightIcon,
    permissions: [PERMISSIONS.PQR_READ, PERMISSIONS.PQR_CREATE],
  },
  {
    label: 'Reportes',
    href: '/reportes',
    icon: DocumentChartBarIcon,
    permissions: PERMISSIONS.REPORTES_READ,
  },
  {
    label: 'Auditoria',
    href: '/auditoria',
    icon: ClipboardDocumentListIcon,
    permissions: PERMISSIONS.AUDITORIA_READ,
  },
  {
    label: 'Configuracion',
    href: '/configuracion',
    icon: CogIcon,
    permissions: PERMISSIONS.CONFIGURACION_READ,
  },
];
```

### Hook para Navegacion Filtrada

```typescript
// hooks/useFilteredNavigation.ts
import { useMemo } from 'react';
import { usePermissions } from './usePermissions';
import { NavItem, navigationConfig } from '@/config/navigation';

export function useFilteredNavigation(): NavItem[] {
  const { can, canAny, canAll } = usePermissions();

  const filterItems = useMemo(() => {
    const filter = (items: NavItem[]): NavItem[] => {
      return items
        .filter((item) => {
          // No permissions required = always visible
          if (!item.permissions) return true;

          const perms = Array.isArray(item.permissions)
            ? item.permissions
            : [item.permissions];

          if (item.requireAll) {
            return canAll(perms);
          }
          return canAny(perms);
        })
        .map((item) => ({
          ...item,
          children: item.children ? filter(item.children) : undefined,
        }))
        // Remove items whose children were all filtered out
        .filter((item) => !item.children || item.children.length > 0);
    };

    return filter;
  }, [can, canAny, canAll]);

  return useMemo(() => filterItems(navigationConfig), [filterItems]);
}
```

### Componente Sidebar

```tsx
// components/layout/Sidebar.tsx
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useFilteredNavigation } from '@/hooks/useFilteredNavigation';
import { cn } from '@/lib/utils';

export function Sidebar() {
  const pathname = usePathname();
  const navigation = useFilteredNavigation();

  return (
    <nav className="flex flex-col gap-1 p-4">
      {navigation.map((item) => {
        const isActive = pathname === item.href || pathname.startsWith(item.href + '/');
        const Icon = item.icon;

        return (
          <div key={item.href}>
            <Link
              href={item.href}
              className={cn(
                'flex items-center gap-3 rounded-lg px-3 py-2 text-sm transition-colors',
                isActive
                  ? 'bg-primary text-primary-foreground'
                  : 'text-muted-foreground hover:bg-muted hover:text-foreground'
              )}
            >
              <Icon className="h-5 w-5" />
              {item.label}
            </Link>

            {item.children && item.children.length > 0 && (
              <div className="ml-6 mt-1 flex flex-col gap-1">
                {item.children.map((child) => (
                  <Link
                    key={child.href}
                    href={child.href}
                    className={cn(
                      'rounded-lg px-3 py-1.5 text-sm transition-colors',
                      pathname === child.href
                        ? 'bg-muted font-medium'
                        : 'text-muted-foreground hover:bg-muted'
                    )}
                  >
                    {child.label}
                  </Link>
                ))}
              </div>
            )}
          </div>
        );
      })}
    </nav>
  );
}
```

## Testing

- [ ] Usuario ADMIN ve todos los items de navegacion
- [ ] Usuario RESIDENT ve solo items permitidos
- [ ] Submenu se oculta si no tiene permisos hijos
- [ ] Items padre se ocultan si todos los hijos estan ocultos
- [ ] Navegacion responsive filtra correctamente
- [ ] Links activos se marcan correctamente
