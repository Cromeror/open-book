# OB-014-E-004: Implementar PermissionGuard para rutas

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Rol y Sistema de Permisos Granulares |
| Story | OB-014-E - Sistema de permisos granulares |
| Status | pending |
| Priority | high |
| Created | 2026-01-05 |
| Updated | 2026-01-05 |
| Labels | task, frontend, permissions, routing |
| Depends on | OB-014-E-002 |
| Assigned | unassigned |

## Descripcion

Crear un componente PermissionGuard que protege rutas completas basado en permisos. Este componente se usa como wrapper de paginas para restringir acceso y redirigir usuarios sin permisos.

## Contexto Tecnico

### Archivos afectados
- `apps/web/src/components/permissions/PermissionGuard.tsx`
- `apps/web/src/components/permissions/index.ts`

### Enfoque tecnico
Componente que verifica permisos antes de renderizar children. Si el usuario no tiene permisos, redirige a una pagina de acceso denegado o a la pagina principal. Soporta verificacion de uno o multiples permisos.

## Criterios de Aceptacion

- [ ] Componente PermissionGuard creado
- [ ] Soporte para permiso unico o array de permisos
- [ ] Prop `requireAll` para definir si requiere todos o alguno
- [ ] Redireccion automatica a pagina de acceso denegado
- [ ] Prop `redirectTo` opcional para redireccion personalizada
- [ ] Estado de loading mientras verifica permisos
- [ ] Integrado con sistema de rutas de Next.js
- [ ] Tests unitarios

## Notas de Implementacion

```typescript
// components/permissions/PermissionGuard.tsx
'use client';

import { ReactNode, useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { usePermissions } from '@/hooks/usePermissions';
import { Permission } from '@/lib/permissions';

export interface PermissionGuardProps {
  /** Permission(s) required to access this route */
  permissions: Permission | Permission[];
  /** If true, all permissions are required. If false, any permission grants access */
  requireAll?: boolean;
  /** Where to redirect if access is denied. Defaults to /acceso-denegado */
  redirectTo?: string;
  /** Content to render while checking permissions */
  loadingFallback?: ReactNode;
  /** Content to render if access is granted */
  children: ReactNode;
}

export function PermissionGuard({
  permissions,
  requireAll = false,
  redirectTo = '/acceso-denegado',
  loadingFallback = null,
  children,
}: PermissionGuardProps): ReactNode {
  const router = useRouter();
  const { can, canAny, canAll, isAuthenticated } = usePermissions();
  const [isChecking, setIsChecking] = useState(true);
  const [hasAccess, setHasAccess] = useState(false);

  useEffect(() => {
    if (!isAuthenticated) {
      router.replace('/login');
      return;
    }

    const permissionArray = Array.isArray(permissions) ? permissions : [permissions];

    let granted: boolean;
    if (permissionArray.length === 1) {
      granted = can(permissionArray[0]);
    } else if (requireAll) {
      granted = canAll(permissionArray);
    } else {
      granted = canAny(permissionArray);
    }

    if (!granted) {
      router.replace(redirectTo);
      return;
    }

    setHasAccess(true);
    setIsChecking(false);
  }, [permissions, requireAll, redirectTo, isAuthenticated, can, canAny, canAll, router]);

  if (isChecking) {
    return loadingFallback;
  }

  if (!hasAccess) {
    return null;
  }

  return children;
}
```

### Pagina de Acceso Denegado

```typescript
// app/acceso-denegado/page.tsx
export default function AccesoDenegadoPage() {
  return (
    <div className="flex flex-col items-center justify-center min-h-screen">
      <h1 className="text-2xl font-bold text-red-600">Acceso Denegado</h1>
      <p className="mt-4 text-gray-600">
        No tienes permisos para acceder a esta seccion.
      </p>
      <a href="/" className="mt-6 text-blue-600 hover:underline">
        Volver al inicio
      </a>
    </div>
  );
}
```

### Ejemplos de Uso

```tsx
// Pagina que requiere permiso especifico
// app/admin/usuarios/page.tsx
import { PermissionGuard } from '@/components/permissions';
import { PERMISSIONS } from '@/lib/permissions.constants';

export default function UsuariosPage() {
  return (
    <PermissionGuard permissions={PERMISSIONS.USERS_MANAGE}>
      <UsersManagement />
    </PermissionGuard>
  );
}

// Pagina que requiere cualquiera de varios permisos
// app/reportes/page.tsx
export default function ReportesPage() {
  return (
    <PermissionGuard
      permissions={[PERMISSIONS.REPORTES_READ, PERMISSIONS.REPORTES_EXPORT]}
    >
      <ReportesView />
    </PermissionGuard>
  );
}

// Pagina que requiere todos los permisos
// app/admin/configuracion/page.tsx
export default function ConfiguracionPage() {
  return (
    <PermissionGuard
      permissions={[PERMISSIONS.CONFIGURACION_READ, PERMISSIONS.CONFIGURACION_UPDATE]}
      requireAll
    >
      <ConfiguracionPanel />
    </PermissionGuard>
  );
}

// Con loading personalizado
export default function SecurePage() {
  return (
    <PermissionGuard
      permissions={PERMISSIONS.AUDITORIA_READ}
      loadingFallback={<LoadingSpinner />}
    >
      <AuditoriaView />
    </PermissionGuard>
  );
}
```

## Testing

- [ ] Renderiza children cuando tiene permiso
- [ ] Redirige a /acceso-denegado cuando no tiene permiso
- [ ] Redirige a /login cuando no esta autenticado
- [ ] Respeta prop redirectTo personalizado
- [ ] requireAll=true requiere todos los permisos
- [ ] requireAll=false permite cualquier permiso
- [ ] Muestra loadingFallback mientras verifica
