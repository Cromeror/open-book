# OB-014-C-002: Implementar submenus por permisos granulares

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Permisos y Modulos |
| Story | OB-014-C - Navegacion adaptativa por modulos |
| Status | done |
| Priority | high |
| Created | 2026-01-05 |
| Updated | 2026-01-06 |
| Labels | task, frontend, navigation, permisos |
| Depends on | OB-014-C-001 |
| Assigned | unassigned |

## Descripcion

Implementar submenus que muestran opciones basadas en permisos granulares del usuario (read, create, manage, etc).

## Contexto Tecnico

### Archivos creados/modificados
- `apps/web/src/lib/nav-config.ts` - Children con permisos granulares
- `apps/web/src/lib/nav-filter.server.ts` - Filtrado recursivo de children
- `apps/web/src/components/layout/Sidebar.tsx` - Submenus expandibles

### Enfoque tecnico
- Cada child puede tener su propio `permission` requirement
- Filtrado recursivo que elimina items sin acceso
- Padres sin children visibles se ocultan automaticamente

## Criterios de Aceptacion

- [x] Submenus muestran acciones segun permisos granulares
- [x] Permisos verificados con `can('module:action')`
- [x] Items padre se ocultan si no tienen children visibles
- [x] Submenus expandibles con animacion

## Implementacion Final

```typescript
// apps/web/src/lib/nav-config.ts
{
  path: '/pqr',
  label: 'PQR',
  icon: 'MessageSquare',
  module: 'pqr',
  children: [
    { path: '/pqr', label: 'Mis PQR', icon: 'List', permission: 'pqr:read' },
    { path: '/pqr/nuevo', label: 'Nueva solicitud', icon: 'Plus', permission: 'pqr:create' },
    { path: '/pqr/gestionar', label: 'Gestionar', icon: 'Settings', permission: 'pqr:manage' },
  ],
}

// Sidebar.tsx - Submenu expandible
const renderNavItem = (item: NavItem, depth = 0) => {
  const hasChildren = item.children && item.children.length > 0;
  const isExpanded = expandedItems.has(item.path);

  return hasChildren ? (
    <>
      <button onClick={() => toggleExpanded(item.path)}>
        {item.label}
        {isExpanded ? <ChevronDown /> : <ChevronRight />}
      </button>
      {isExpanded && (
        <ul>{item.children.map((child) => renderNavItem(child, depth + 1))}</ul>
      )}
    </>
  ) : (
    <Link href={item.path}>{item.label}</Link>
  );
};
```

## Testing

- [x] Submenus renderizan correctamente
- [x] Permisos granulares filtran opciones
- [x] Animacion de expand/collapse funciona
- [x] Build pasa sin errores
