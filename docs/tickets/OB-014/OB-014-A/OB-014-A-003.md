# OB-014-A-003: Crear middleware de proteccion de rutas

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Rol de Usuario |
| Story | OB-014-A - Contexto de autenticacion y proteccion de rutas |
| Status | pending |
| Priority | critical |
| Created | 2026-01-05 |
| Updated | 2026-01-05 |
| Labels | task, frontend, middleware, security |
| Depends on | OB-002-B-002 |
| Assigned | unassigned |

## Descripcion

Implementar middleware de Next.js para proteger rutas a nivel de servidor, verificando autenticacion y rol antes de renderizar las paginas.

## Contexto Tecnico

### Archivos afectados
- `apps/web/middleware.ts`
- `apps/web/src/lib/auth.ts`

### Enfoque tecnico
Usar Next.js Middleware para interceptar requests y verificar el token JWT. Redirigir segun estado de autenticacion y rol.

## Criterios de Aceptacion

- [ ] Middleware intercepta rutas protegidas
- [ ] Verifica token JWT en cookies
- [ ] Rutas /admin/* requieren rol ADMIN
- [ ] Rutas /resident/* requieren autenticacion
- [ ] Rutas publicas no requieren auth
- [ ] Redireccion apropiada segun caso

## Notas de Implementacion

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { jwtVerify } from 'jose';

const PUBLIC_ROUTES = ['/login', '/registro', '/recuperar-password'];
const ADMIN_ROUTES = ['/admin'];
const RESIDENT_ROUTES = ['/resident'];

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // Rutas publicas - permitir acceso
  if (PUBLIC_ROUTES.some(route => pathname.startsWith(route))) {
    return NextResponse.next();
  }

  // Obtener token de cookie
  const token = request.cookies.get('access_token')?.value;

  if (!token) {
    // No autenticado - redirigir a login
    return NextResponse.redirect(new URL('/login', request.url));
  }

  try {
    // Verificar token
    const secret = new TextEncoder().encode(process.env.JWT_SECRET);
    const { payload } = await jwtVerify(token, secret);
    const userRole = payload.role as string;

    // Verificar permisos para rutas admin
    if (ADMIN_ROUTES.some(route => pathname.startsWith(route))) {
      if (userRole !== 'ADMIN') {
        return NextResponse.redirect(new URL('/acceso-denegado', request.url));
      }
    }

    // Rutas de residente - cualquier usuario autenticado
    if (RESIDENT_ROUTES.some(route => pathname.startsWith(route))) {
      // Permitir acceso
      return NextResponse.next();
    }

    return NextResponse.next();
  } catch {
    // Token invalido
    return NextResponse.redirect(new URL('/login', request.url));
  }
}

export const config = {
  matcher: [
    '/((?!api|_next/static|_next/image|favicon.ico).*)',
  ],
};
```

## Testing

- [ ] Rutas publicas accesibles sin token
- [ ] Rutas protegidas redirigen a login sin token
- [ ] Rutas admin redirigen a acceso-denegado si no es admin
- [ ] Token valido permite acceso
