# OB-014-A-004: Implementar componentes AuthGuard y RoleGuard

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Rol de Usuario |
| Story | OB-014-A - Contexto de autenticacion y proteccion de rutas |
| Status | pending |
| Priority | high |
| Created | 2026-01-05 |
| Updated | 2026-01-05 |
| Labels | task, frontend, components, guards |
| Depends on | OB-014-A-001 |
| Assigned | unassigned |

## Descripcion

Crear componentes wrapper para proteger secciones de la UI segun autenticacion y rol del usuario. Utiles para proteccion adicional a nivel de componente.

## Contexto Tecnico

### Archivos afectados
- `apps/web/src/components/guards/AuthGuard.tsx`
- `apps/web/src/components/guards/RoleGuard.tsx`
- `apps/web/src/components/guards/index.ts`

### Enfoque tecnico
Componentes HOC que verifican autenticacion/rol y renderizan children o muestran fallback/redirigen.

## Criterios de Aceptacion

- [ ] AuthGuard verifica autenticacion
- [ ] RoleGuard verifica rol especifico
- [ ] Soporte para fallback personalizado
- [ ] Opcion de redirigir o mostrar mensaje
- [ ] Loading state mientras verifica

## Notas de Implementacion

```typescript
// components/guards/AuthGuard.tsx
'use client';

import { useAuth } from '@/hooks/useAuth';
import { useRouter } from 'next/navigation';
import { useEffect, ReactNode } from 'react';

interface AuthGuardProps {
  children: ReactNode;
  fallback?: ReactNode;
  redirectTo?: string;
}

export function AuthGuard({
  children,
  fallback = null,
  redirectTo = '/login'
}: AuthGuardProps) {
  const { isAuthenticated, isLoading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push(redirectTo);
    }
  }, [isLoading, isAuthenticated, router, redirectTo]);

  if (isLoading) {
    return <div>Cargando...</div>;
  }

  if (!isAuthenticated) {
    return fallback;
  }

  return <>{children}</>;
}

// components/guards/RoleGuard.tsx
'use client';

import { useAuth } from '@/hooks/useAuth';
import { Role } from '@/types/auth';
import { useRouter } from 'next/navigation';
import { useEffect, ReactNode } from 'react';

interface RoleGuardProps {
  children: ReactNode;
  allowedRoles: Role[];
  fallback?: ReactNode;
  redirectTo?: string;
}

export function RoleGuard({
  children,
  allowedRoles,
  fallback = null,
  redirectTo = '/acceso-denegado'
}: RoleGuardProps) {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  const hasAccess = user && allowedRoles.includes(user.role);

  useEffect(() => {
    if (!isLoading && !hasAccess) {
      router.push(redirectTo);
    }
  }, [isLoading, hasAccess, router, redirectTo]);

  if (isLoading) {
    return <div>Verificando permisos...</div>;
  }

  if (!hasAccess) {
    return fallback;
  }

  return <>{children}</>;
}

// Uso ejemplo:
// <RoleGuard allowedRoles={[Role.ADMIN]}>
//   <AdminOnlyContent />
// </RoleGuard>
```

## Testing

- [ ] AuthGuard redirige si no autenticado
- [ ] RoleGuard redirige si rol no permitido
- [ ] Children se renderizan si tiene acceso
- [ ] Fallback se muestra cuando corresponde
