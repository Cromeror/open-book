# OB-014-A-001: Implementar middleware de autenticacion

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Permisos y Modulos |
| Story | OB-014-A - Autenticacion Server-Side y Proteccion de Rutas |
| Status | pending |
| Priority | critical |
| Created | 2026-01-05 |
| Updated | 2026-01-06 |
| Labels | task, frontend, middleware, auth, server-first |
| Depends on | OB-002-B-001 |
| Assigned | unassigned |

## Descripcion

Implementar el middleware de Next.js para proteger rutas a nivel de servidor. El middleware corre en Edge Runtime y es la primera capa de defensa - verifica que exista un JWT valido antes de permitir acceso a rutas protegidas.

**Server-First**: El middleware solo hace verificacion basica de JWT (no accede a DB). La verificacion completa de permisos se hace en Server Components.

## Contexto Tecnico

### Archivos afectados
- `apps/web/middleware.ts`
- `apps/web/src/lib/auth.ts`
- `apps/web/src/lib/routes.config.ts`

### Enfoque tecnico
Middleware en Edge Runtime verifica JWT usando `jose` (compatible con Edge). No hace queries a DB - solo decodifica el token y verifica firma/expiracion.

## Criterios de Aceptacion

- [ ] Middleware intercepta todas las rutas protegidas
- [ ] Verifica existencia y validez del JWT en cookie
- [ ] Redirige a /login si no hay token o es invalido
- [ ] Rutas /admin/* requieren isSuperAdmin en JWT
- [ ] Rutas publicas no requieren autenticacion
- [ ] Preserva redirect URL en query param al ir a login
- [ ] Funciona en Edge Runtime (sin node APIs)

## Notas de Implementacion

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { jwtVerify } from 'jose';

// Rutas publicas (no requieren autenticacion)
const PUBLIC_ROUTES = [
  '/login',
  '/registro',
  '/recuperar-password',
  '/verificar-email',
  '/',
];

// Rutas solo para SuperAdmin
const SUPERADMIN_ROUTES = [
  '/admin',
];

// Patrones a ignorar
const IGNORED_PATTERNS = [
  /^\/_next/,
  /^\/api/,
  /\.[^/]+$/,  // archivos estaticos
];

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // Ignorar assets y API routes
  if (IGNORED_PATTERNS.some(pattern => pattern.test(pathname))) {
    return NextResponse.next();
  }

  // Rutas publicas - permitir sin auth
  if (PUBLIC_ROUTES.some(route => pathname === route || pathname.startsWith(route + '/'))) {
    return NextResponse.next();
  }

  // Obtener token de cookie httpOnly
  const token = request.cookies.get('access_token')?.value;

  if (!token) {
    return redirectToLogin(request);
  }

  try {
    // Verificar JWT (Edge-compatible con jose)
    const secret = new TextEncoder().encode(process.env.JWT_SECRET);
    const { payload } = await jwtVerify(token, secret);

    // Verificar rutas de SuperAdmin
    if (SUPERADMIN_ROUTES.some(route => pathname.startsWith(route))) {
      if (!payload.isSuperAdmin) {
        return NextResponse.redirect(new URL('/acceso-denegado', request.url));
      }
    }

    // Token valido - continuar
    // La verificacion de modulos se hace en Server Components
    return NextResponse.next();

  } catch (error) {
    // Token invalido o expirado
    return redirectToLogin(request, true);
  }
}

function redirectToLogin(request: NextRequest, expired = false) {
  const loginUrl = new URL('/login', request.url);
  loginUrl.searchParams.set('redirect', request.nextUrl.pathname);
  if (expired) {
    loginUrl.searchParams.set('expired', 'true');
  }
  return NextResponse.redirect(loginUrl);
}

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico, robots.txt, etc.
     */
    '/((?!_next/static|_next/image|favicon.ico|robots.txt|sitemap.xml).*)',
  ],
};

// lib/auth.ts (Edge-compatible utilities)
import { jwtVerify, SignJWT } from 'jose';

const JWT_SECRET = new TextEncoder().encode(process.env.JWT_SECRET);

export interface JWTPayload {
  sub: string;
  email: string;
  isSuperAdmin: boolean;
  iat: number;
  exp: number;
}

export async function verifyToken(token: string): Promise<JWTPayload | null> {
  try {
    const { payload } = await jwtVerify(token, JWT_SECRET);
    return payload as unknown as JWTPayload;
  } catch {
    return null;
  }
}

// lib/routes.config.ts
export const ROUTE_CONFIG = {
  public: ['/login', '/registro', '/recuperar-password', '/verificar-email', '/'],
  superadmin: ['/admin'],
  // La configuracion de modulos por ruta se maneja en Server Components
} as const;
```

## Flujo del Middleware

```
Request entrante
       │
       ▼
┌─────────────────┐
│  ¿Es asset o    │
│  API route?     │──YES──> Next()
│       │         │
│      NO         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  ¿Ruta publica? │──YES──> Next()
│       │         │
│      NO         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  ¿Tiene JWT?    │──NO──> Redirect /login?redirect=...
│       │         │
│      YES        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  ¿JWT valido?   │──NO──> Redirect /login?expired=true
│       │         │
│      YES        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ ¿Ruta /admin/*? │──YES──> ¿isSuperAdmin?
│       │         │              │
│      NO         │         NO───┴───YES
│       │         │         │         │
│       │         │    Redirect      Next()
│       │         │  /acceso-denegado
└────────┬────────┘
         │
         ▼
      Next()
```

## Seguridad

- **httpOnly cookie**: El token NUNCA debe ser accesible desde JavaScript
- **Secure flag**: Solo enviar cookie sobre HTTPS en produccion
- **SameSite**: Usar 'lax' o 'strict' para prevenir CSRF
- **No exponer payload**: El middleware no agrega headers con datos del usuario

## Testing

- [ ] Rutas publicas accesibles sin token
- [ ] Rutas protegidas redirigen a /login sin token
- [ ] Token expirado redirige con ?expired=true
- [ ] Rutas /admin/* redirigen si no es SuperAdmin
- [ ] Query param redirect se preserva
- [ ] Funciona en Edge Runtime (no usa node:* imports)
