# OB-001-B-005: Implementar soft delete para inmutabilidad

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-001 - Configuracion e Infraestructura del Proyecto |
| Story | OB-001-B - Configuracion de base de datos y ORM |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, soft-delete, inmutabilidad, transparencia |
| Depends on | OB-001-B-003 |
| Assigned | unassigned |

## Descripcion

Implementar soft delete como mecanismo estandar de eliminacion en el sistema. Segun los principios de transparencia, los registros no deben eliminarse fisicamente; en su lugar, se marcan como eliminados manteniendo la trazabilidad completa.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/entities/base.entity.ts` (decorador @DeleteDateColumn)
- `apps/api/src/subscribers/soft-delete.subscriber.ts` (subscriber)
- `apps/api/src/utils/soft-delete.ts` (utilidades)

### Enfoque tecnico
Usar el decorador @DeleteDateColumn de TypeORM que automaticamente filtra registros eliminados en queries. Configurar subscriber para registrar deletedBy.

## Criterios de Aceptacion

- [ ] @DeleteDateColumn configurado en entidad base
- [ ] softRemove() marca deletedAt automaticamente
- [ ] Queries filtran automaticamente registros con deletedAt != null
- [ ] Metodo withDeleted() para consultar registros eliminados (auditoria)
- [ ] Campo deletedBy se llena con el usuario que elimina
- [ ] Documentacion del comportamiento de soft delete

## Notas de Implementacion

Ejemplo de uso con TypeORM:

```typescript
// Entidad con soft delete
@Entity('usuarios')
export class Usuario extends BaseEntity {
  @Column()
  nombre: string;

  @Column({ unique: true })
  email: string;
}

// En el servicio
@Injectable()
export class UsuariosService {
  constructor(
    @InjectRepository(Usuario)
    private usuariosRepository: Repository<Usuario>,
  ) {}

  // Soft delete - marca deletedAt
  async remove(id: string): Promise<void> {
    await this.usuariosRepository.softDelete(id);
  }

  // Obtener todos incluyendo eliminados
  async findAllWithDeleted(): Promise<Usuario[]> {
    return this.usuariosRepository.find({ withDeleted: true });
  }

  // Restaurar registro eliminado
  async restore(id: string): Promise<void> {
    await this.usuariosRepository.restore(id);
  }
}
```

- Los aportes financieros NUNCA deben poder eliminarse (ni soft delete)
- Principio de inmutabilidad: solo correccion con justificacion

## Testing

- [ ] softDelete() marca deletedAt en lugar de eliminar
- [ ] find() no retorna registros eliminados por defecto
- [ ] find({ withDeleted: true }) incluye registros eliminados
- [ ] deletedBy se registra correctamente
- [ ] restore() recupera registros eliminados
