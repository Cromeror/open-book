# OB-008-A-003: Implementar cache de calculos

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-008 - Calculo y Visualizacion de Avance |
| Story | OB-008-A - Motor de calculo de avance |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, cache, performance |
| Depends on | OB-008-A-001 |
| Assigned | unassigned |

## Descripcion

Implementar sistema de cache para los calculos de avance, mejorando performance en dashboards con muchos datos.

## Contexto Tecnico

### Archivos afectados
- `src/services/calculo.service.ts`
- `src/lib/cache.ts`

## Criterios de Aceptacion

- [ ] Cache con TTL configurable (ej: 5 minutos)
- [ ] Invalidacion al confirmar/anular aporte
- [ ] Opcion de forzar recalculo
- [ ] Cache key por objetivo/actividad

## Notas de Implementacion

```typescript
const CACHE_TTL = 5 * 60 * 1000; // 5 minutos

async function getAvanceObjetivo(objetivoId: string, force = false) {
  const cacheKey = `avance:objetivo:${objetivoId}`;

  if (!force) {
    const cached = await cache.get(cacheKey);
    if (cached) return cached;
  }

  const avance = await calcularAvanceObjetivo(objetivoId);
  await cache.set(cacheKey, avance, CACHE_TTL);
  return avance;
}

// Invalidar al confirmar/anular aporte
async function invalidarCacheAvance(aporteId: string) {
  const aporte = await typeorm.aporte.findUnique({
    where: { id: aporteId },
    include: { actividad: true }
  });
  await cache.del(`avance:objetivo:${aporte.actividad.objetivoId}`);
  await cache.del(`avance:actividad:${aporte.actividadId}`);
}
```

## Testing

- [ ] Cache se usa cuando existe
- [ ] Cache se invalida correctamente
- [ ] Force recalcula siempre
