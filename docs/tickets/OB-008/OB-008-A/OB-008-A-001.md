# OB-008-A-001: Implementar servicio de calculo de avance

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-008 - Calculo y Visualizacion de Avance |
| Story | OB-008-A - Motor de calculo de avance |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, servicio, calculo |
| Depends on | OB-007-B-001 |
| Assigned | unassigned |

## Descripcion

Crear servicio que calcule el avance de un objetivo segun la formula del SUMMARY.md: total recaudado, faltante, y porcentaje.

## Contexto Tecnico

### Archivos afectados
- `src/services/calculo.service.ts`
- `src/types/avance.ts`

### Enfoque tecnico
Funcion que agrega aportes confirmados de todas las actividades del objetivo y calcula metricas.

## Criterios de Aceptacion

- [ ] calcularAvanceObjetivo(objetivoId) implementado
- [ ] Retorna: totalRecaudado, faltante, porcentajeAvance
- [ ] Solo suma aportes con estado CONFIRMADO
- [ ] Maneja objetivo sin aportes (0%)
- [ ] Maneja sobre-recaudo (>100%)

## Notas de Implementacion

```typescript
interface AvanceObjetivo {
  objetivoId: string;
  montoObjetivo: Decimal;
  totalRecaudado: Decimal;
  faltante: Decimal;
  porcentajeAvance: number;
  sobreRecaudo: boolean;
}

async function calcularAvanceObjetivo(objetivoId: string): Promise<AvanceObjetivo> {
  const objetivo = await typeorm.objetivo.findUnique({
    where: { id: objetivoId }
  });

  const totalRecaudado = await typeorm.aporte.aggregate({
    where: {
      actividad: { objetivoId },
      estado: 'CONFIRMADO'
    },
    _sum: { monto: true }
  });

  const recaudado = totalRecaudado._sum.monto || new Decimal(0);
  const faltante = Decimal.max(objetivo.montoObjetivo.sub(recaudado), new Decimal(0));
  const porcentaje = objetivo.montoObjetivo.isZero()
    ? 0
    : recaudado.div(objetivo.montoObjetivo).mul(100).toNumber();

  return {
    objetivoId,
    montoObjetivo: objetivo.montoObjetivo,
    totalRecaudado: recaudado,
    faltante,
    porcentajeAvance: porcentaje,
    sobreRecaudo: recaudado.greaterThan(objetivo.montoObjetivo)
  };
}
```

## Testing

- [ ] Objetivo sin aportes retorna 0%
- [ ] Calculos son precisos
- [ ] Solo suma CONFIRMADOS
- [ ] Sobre-recaudo se detecta
