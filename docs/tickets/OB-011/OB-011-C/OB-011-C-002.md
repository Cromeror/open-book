# OB-011-C-002: Validar reciprocidad en consultas

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-011 - Visibilidad de Estados de Cuenta |
| Story | OB-011-C - Visualizacion de estados de cuenta publicos |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, validacion, reciprocidad |
| Depends on | OB-011-C-001 |
| Assigned | unassigned |

## Descripcion

Implementar middleware que valide la reciprocidad: solo quien comparte puede ver.

## Criterios de Aceptacion

- [ ] Middleware reciprocidadMiddleware creado
- [ ] Verifica visibilidad del solicitante
- [ ] Retorna 403 si es PRIVADO
- [ ] Mensaje de error explicativo

## Notas de Implementacion

```typescript
async function reciprocidadMiddleware(req, res, next) {
  const user = await typeorm.user.findUnique({
    where: { id: req.user.id },
    select: { publicAccountConsent: true }
  });

  if (!user.publicAccountConsent) {
    return res.status(403).json({
      error: 'Acceso denegado',
      mensaje: 'Solo residentes con estados de cuenta PUBLICOS pueden ver los estados de otros residentes. Su configuracion actual es PRIVADA.',
      accion: 'Puede solicitar cambio de visibilidad desde su perfil.'
    });
  }

  next();
}
```

## Testing

- [ ] Usuario PRIVADO recibe 403
- [ ] Usuario PUBLICO pasa
- [ ] Mensaje es claro
