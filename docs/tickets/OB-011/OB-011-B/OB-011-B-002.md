# OB-011-B-002: Ejecutar cambio de visibilidad

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-011 - Visibilidad de Estados de Cuenta |
| Story | OB-011-B - Gestion de cambios de visibilidad |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, cambio, ejecucion |
| Depends on | OB-011-B-001 |
| Assigned | unassigned |

## Descripcion

Servicio que ejecuta el cambio de visibilidad y registra nuevo consentimiento.

## Criterios de Aceptacion

- [ ] Funcion cambiarVisibilidad() implementada
- [ ] Actualiza publicAccountConsent en User
- [ ] Crea nuevo registro de ConsentimientoVisibilidad
- [ ] Notifica al usuario
- [ ] Registra en auditoria general

## Notas de Implementacion

```typescript
interface CambioVisibilidadParams {
  userId: string;
  nuevaVisibilidad: Visibilidad;
  justificacion: string;
  pqrId?: string;
  cambiadoPorAdmin: boolean;
  adminId?: string;
}

async function cambiarVisibilidad(params: CambioVisibilidadParams) {
  await typeorm.$transaction(async (tx) => {
    // Actualizar usuario
    await tx.user.update({
      where: { id: params.userId },
      data: {
        publicAccountConsent: params.nuevaVisibilidad === 'PUBLICO',
        consentDate: new Date()
      }
    });

    // Registrar consentimiento
    await tx.consentimientoVisibilidad.create({
      data: {
        userId: params.userId,
        visibilidad: params.nuevaVisibilidad,
        textoAceptado: `Cambio a ${params.nuevaVisibilidad}. Justificacion: ${params.justificacion}`,
        ipAddress: '...',
        pqrId: params.pqrId,
        cambiadoPorAdmin: params.cambiadoPorAdmin,
        justificacionAdmin: params.cambiadoPorAdmin ? params.justificacion : null
      }
    });

    // Notificar
    await notificationService.send({
      userId: params.userId,
      tipo: 'VISIBILIDAD_CAMBIADA',
      mensaje: `Su visibilidad ha sido cambiada a ${params.nuevaVisibilidad}`
    });
  });
}
```

## Testing

- [ ] Usuario se actualiza correctamente
- [ ] Consentimiento se registra
- [ ] Notificacion se envia
