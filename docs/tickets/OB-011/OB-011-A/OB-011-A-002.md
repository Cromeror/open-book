# OB-011-A-002: Registrar consentimiento con fecha y detalle

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-011 - Visibilidad de Estados de Cuenta |
| Story | OB-011-A - Configuracion inicial de visibilidad |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, consentimiento, auditoria |
| Depends on | OB-011-A-001 |
| Assigned | unassigned |

## Descripcion

Registrar en base de datos el consentimiento de visibilidad con todos los detalles requeridos para cumplimiento legal.

## Criterios de Aceptacion

- [ ] Entidad ConsentimientoVisibilidad creada con TypeORM
- [ ] Registra: fecha, IP, user agent, texto aceptado
- [ ] Vinculado al usuario
- [ ] Historial de cambios de consentimiento
- [ ] Inmutable (no se elimina, se agrega nuevo)

## Notas de Implementacion

Entidad ConsentimientoVisibilidad con TypeORM:
```typescript
import { Entity, Column, ManyToOne, JoinColumn, CreateDateColumn, PrimaryGeneratedColumn, Index } from 'typeorm';
import { User } from './user.entity';

export enum Visibilidad {
  PUBLICO = 'PUBLICO',
  PRIVADO = 'PRIVADO',
}

@Entity('consentimiento_visibilidad')
@Index(['userId'])
export class ConsentimientoVisibilidad {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'userId' })
  user: User;

  @Column({
    type: 'enum',
    enum: Visibilidad,
  })
  visibilidad: Visibilidad;

  @Column({ type: 'text' })
  textoAceptado: string; // Texto que el usuario leyo y acepto

  @Column()
  ipAddress: string;

  @Column({ nullable: true })
  userAgent: string;

  @Column({ nullable: true })
  pqrId: string; // Si el cambio fue via PQR

  @Column({ default: false })
  cambiadoPorAdmin: boolean;

  @Column({ type: 'text', nullable: true })
  justificacionAdmin: string; // Si fue cambio administrativo

  @CreateDateColumn()
  createdAt: Date;
}
```

## Testing

- [ ] Consentimiento se registra al crear usuario
- [ ] Todos los campos se llenan correctamente
- [ ] Historial es inmutable
