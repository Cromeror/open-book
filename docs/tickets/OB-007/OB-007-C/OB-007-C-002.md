# OB-007-C-002: Implementar visualizacion de comprobantes

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-007 - Aportes Reales |
| Story | OB-007-C - Gestion de comprobantes |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, archivos, visualizacion |
| Depends on | OB-007-C-001 |
| Assigned | unassigned |

## Descripcion

Implementar el endpoint para visualizar/descargar comprobantes de aportes. El acceso debe ser controlado segun permisos.

## Contexto Tecnico

### Archivos afectados
- `src/api/routes/aportes.routes.ts`
- `src/api/controllers/aportes.controller.ts`
- `src/services/storage.service.ts`

### Enfoque tecnico
Servir archivos con verificacion de permisos. Admins pueden ver cualquier comprobante, residentes solo de sus aportes.

## Criterios de Aceptacion

- [ ] GET /api/.../aportes/:id/comprobante implementado
- [ ] Admins pueden ver cualquier comprobante
- [ ] Residentes solo ven comprobantes de su apartamento
- [ ] Retorna archivo con content-type correcto
- [ ] 404 si no tiene comprobante

## Notas de Implementacion

Request:
```
GET /api/.../aportes/:id/comprobante
Authorization: Bearer <token>
```

Response:
- Content-Type: application/pdf (o image/jpeg, etc.)
- Content-Disposition: inline; filename="comprobante.pdf"
- Body: [archivo binario]

Verificacion de acceso:
```typescript
async function canAccessComprobante(
  userId: string,
  userRole: Role,
  aporteId: string
): Promise<boolean> {
  if (userRole === 'ADMIN') return true;

  // Residente: verificar que el aporte es de su apartamento
  const aporte = await typeorm.aporte.findUnique({
    where: { id: aporteId },
    include: {
      apartamento: {
        include: {
          residentes: { where: { userId, estado: 'ACTIVE' } }
        }
      }
    }
  });

  return aporte?.apartamento.residentes.length > 0;
}
```

Para produccion con S3:
- Generar URL pre-firmada con expiracion corta (15 min)
- Redirigir al cliente a la URL firmada

## Testing

- [ ] Admin puede descargar cualquier comprobante
- [ ] Residente puede descargar comprobante propio
- [ ] Residente no puede descargar comprobante ajeno
- [ ] Content-type es correcto
- [ ] Sin comprobante retorna 404
