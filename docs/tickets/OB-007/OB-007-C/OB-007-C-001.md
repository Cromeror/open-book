# OB-007-C-001: Implementar carga de comprobantes

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-007 - Aportes Reales |
| Story | OB-007-C - Gestion de comprobantes |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, archivos, upload |
| Depends on | OB-007-A-002 |
| Assigned | unassigned |

## Descripcion

Implementar la funcionalidad para subir archivos de comprobante al momento de registrar un aporte o posteriormente.

## Contexto Tecnico

### Archivos afectados
- `src/api/routes/contributions.routes.ts`
- `src/api/controllers/contributions.controller.ts`
- `src/services/storage.service.ts`
- `src/config/storage.ts`

### Enfoque tecnico
Usar multer para manejo de uploads. Almacenar en sistema de archivos o S3 segun configuracion.

## Criterios de Aceptacion

- [ ] POST /api/.../contributions/:id/receipt implementado
- [ ] Soporta multipart/form-data
- [ ] Formatos permitidos: PDF, JPG, PNG
- [ ] Tamano maximo: 5MB
- [ ] Genera URL unica para el archivo
- [ ] Actualiza campos receiptUrl y receiptFilename

## Notas de Implementacion

Request:
```
POST /api/.../contributions/:id/receipt
Content-Type: multipart/form-data
file: [archivo binario]
```

Response (200):
```json
{
  "receiptUrl": "/uploads/contributions/uuid/receipt-123.pdf",
  "receiptFilename": "recibo_pago.pdf",
  "uploadedAt": "2025-02-15T11:00:00Z"
}
```

Configuracion de multer:
```typescript
// Configuracion para carga de comprobantes
const upload = multer({
  storage: multer.diskStorage({
    destination: './uploads/contributions',
    filename: (req, file, cb) => {
      const uniqueName = `${req.params.id}-${Date.now()}-${file.originalname}`;
      cb(null, uniqueName);
    }
  }),
  limits: { fileSize: 5 * 1024 * 1024 }, // 5MB
  fileFilter: (req, file, cb) => {
    const allowed = ['application/pdf', 'image/jpeg', 'image/png'];
    cb(null, allowed.includes(file.mimetype));
  }
});
```

Consideraciones:
- En produccion usar S3 o similar
- Generar URLs firmadas con expiracion
- Escanear archivos por virus (opcional)

## Testing

- [ ] Upload de PDF funciona
- [ ] Upload de imagen funciona
- [ ] Archivo muy grande es rechazado
- [ ] Formato no permitido es rechazado
- [ ] URL se guarda en contribution
