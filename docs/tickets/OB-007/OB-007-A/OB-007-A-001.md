# OB-007-A-001: Crear entidad Aporte con TypeORM

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-007 - Aportes Reales |
| Story | OB-007-A - Modelo y registro de aportes |
| Status | pending |
| Priority | critical |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, entidad, typeorm, aporte, critico |
| Depends on | OB-005-A-001, OB-006-A-001 |
| Assigned | unassigned |

## Descripcion

Crear la entidad Aporte con decoradores TypeORM segun SUMMARY.md seccion 4.5, con todos los atributos requeridos para el registro contable y la trazabilidad completa.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/entities/aporte.entity.ts`
- `apps/api/src/types/aporte.ts`

### Enfoque tecnico
Entidad robusta con todos los campos de trazabilidad usando decoradores TypeORM. Relaciones con Apartamento, Actividad y Compromiso (opcional).

## Criterios de Aceptacion

- [ ] Entidad Aporte creada con decoradores TypeORM
- [ ] Campos obligatorios: monto, fechaAporte, medioPago
- [ ] Campos opcionales: observaciones, numeroComprobante
- [ ] Relacion con Apartamento (obligatoria)
- [ ] Relacion con Actividad (obligatoria)
- [ ] Relacion con Compromiso (opcional)
- [ ] Estado del aporte (enum)
- [ ] Campos de auditoria extendidos (quien, cuando, desde donde)

## Notas de Implementacion

Entidad Aporte con TypeORM:
```typescript
import { Entity, Column, ManyToOne, OneToMany, JoinColumn, Index } from 'typeorm';
import { BaseEntity } from './base.entity';
import { Apartamento } from './apartamento.entity';
import { Actividad } from './actividad.entity';
import { Compromiso } from './compromiso.entity';
import { AporteHistorial } from './aporte-historial.entity';

export enum MedioPago {
  EFECTIVO = 'EFECTIVO',
  TRANSFERENCIA = 'TRANSFERENCIA',
  CONSIGNACION = 'CONSIGNACION',
  CHEQUE = 'CHEQUE',
  OTRO = 'OTRO',
}

export enum EstadoAporte {
  PENDIENTE = 'PENDIENTE',     // Registrado, pendiente confirmacion
  CONFIRMADO = 'CONFIRMADO',   // Verificado y contabilizado
  ANULADO = 'ANULADO',         // Anulado con justificacion
}

@Entity('aportes')
export class Aporte extends BaseEntity {
  @Column()
  @Index()
  apartamentoId: string;

  @ManyToOne(() => Apartamento, (apt) => apt.aportes)
  @JoinColumn({ name: 'apartamentoId' })
  apartamento: Apartamento;

  @Column()
  @Index()
  actividadId: string;

  @ManyToOne(() => Actividad, (act) => act.aportes)
  @JoinColumn({ name: 'actividadId' })
  actividad: Actividad;

  @Column({ nullable: true })
  compromisoId: string;

  @ManyToOne(() => Compromiso, (c) => c.aportes, { nullable: true })
  @JoinColumn({ name: 'compromisoId' })
  compromiso: Compromiso;

  // Datos del aporte
  @Column({ type: 'decimal', precision: 15, scale: 2 })
  monto: number;

  @Column({ type: 'timestamp' })
  fechaAporte: Date;

  @Column({
    type: 'enum',
    enum: MedioPago,
  })
  medioPago: MedioPago;

  @Column({ type: 'text', nullable: true })
  observaciones: string;

  @Column({ nullable: true })
  numeroComprobante: string;

  // Estado
  @Column({
    type: 'enum',
    enum: EstadoAporte,
    default: EstadoAporte.PENDIENTE,
  })
  estado: EstadoAporte;

  // Soporte documental
  @Column({ nullable: true })
  comprobanteUrl: string;

  @Column({ nullable: true })
  comprobanteNombre: string;

  // Auditoria extendida (NO se usa deletedAt - aportes son inmutables)
  @Column({ nullable: true })
  createdByIp: string;

  @Column({ nullable: true })
  confirmedBy: string;

  @Column({ type: 'timestamp', nullable: true })
  confirmedAt: Date;

  // Historial de cambios
  @OneToMany(() => AporteHistorial, (h) => h.aporte)
  historial: AporteHistorial[];
}
```

IMPORTANTE: Los aportes NO tienen deletedAt. Son inmutables. Solo se anulan.

## Testing

- [ ] Migracion se aplica sin errores
- [ ] Todos los campos se guardan correctamente
- [ ] Relaciones funcionan
- [ ] Estado inicial es PENDIENTE
- [ ] NO hay campo deletedAt (verificar inmutabilidad)
