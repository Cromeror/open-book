# OB-007-A-004: Asociar aporte a compromiso automaticamente

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-007 - Aportes Reales |
| Story | OB-007-A - Modelo y registro de aportes |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, asociacion, compromiso |
| Depends on | OB-007-A-002 |
| Assigned | unassigned |

## Descripcion

Implementar la asociacion automatica de un aporte con el compromiso correspondiente del mismo apartamento para la misma actividad, si existe.

## Contexto Tecnico

### Archivos afectados
- `src/services/aporte.service.ts`

### Enfoque tecnico
Buscar compromiso existente para el par (apartamento, actividad) y asociar automaticamente. Si no existe compromiso, el aporte se registra sin asociacion.

## Criterios de Aceptacion

- [ ] Aporte se asocia a compromiso existente automaticamente
- [ ] Si no hay compromiso, aporte se registra sin asociacion
- [ ] compromisoId puede especificarse manualmente si hay ambiguedad
- [ ] El estado del compromiso se actualiza al registrar aporte
- [ ] Funciona con aportes confirmados

## Notas de Implementacion

```typescript
async function asociarCompromiso(
  apartamentoId: string,
  actividadId: string,
  compromisoIdManual?: string
): Promise<string | null> {
  // Si se especifica manualmente, usar ese
  if (compromisoIdManual) {
    const compromiso = await typeorm.compromiso.findFirst({
      where: {
        id: compromisoIdManual,
        apartamentoId,
        actividadId,
        deletedAt: null
      }
    });
    if (!compromiso) {
      throw new BusinessError('Compromiso especificado no valido');
    }
    return compromiso.id;
  }

  // Buscar compromiso automaticamente
  const compromiso = await typeorm.compromiso.findFirst({
    where: {
      apartamentoId,
      actividadId,
      deletedAt: null
    }
  });

  return compromiso?.id || null;
}
```

Cuando se confirma el aporte, recalcular estado del compromiso:
```typescript
async function actualizarEstadoCompromiso(compromisoId: string) {
  // Delegar a OB-006-B-001 calcularEstadoCompromiso
  // Y actualizar el campo si lo almacenamos (o dejarlo calculado)
}
```

## Testing

- [ ] Aporte se asocia a compromiso existente
- [ ] Aporte sin compromiso se registra correctamente
- [ ] Compromiso manual invalido es rechazado
- [ ] Estado de compromiso se actualiza
