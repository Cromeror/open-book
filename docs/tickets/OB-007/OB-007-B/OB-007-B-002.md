# OB-007-B-002: Implementar anulacion de aporte con justificacion

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-007 - Aportes Reales |
| Story | OB-007-B - Estados e inmutabilidad de aportes |
| Status | pending |
| Priority | critical |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, anulacion, inmutabilidad |
| Depends on | OB-007-A-002 |
| Assigned | unassigned |

## Descripcion

Implementar la anulacion de aportes siguiendo el principio de inmutabilidad: el aporte no se elimina, se marca como ANULADO con justificacion obligatoria y documentada.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/modules/aportes/aportes.controller.ts`
- `apps/api/src/modules/aportes/aportes.service.ts`
- `apps/api/src/entities/aporte.entity.ts` (campos de anulacion)

### Enfoque tecnico
Endpoint PATCH con NestJS que requiere justificacion. La anulacion es irreversible.

## Criterios de Aceptacion

- [ ] PATCH /api/.../aportes/:id/anular implementado
- [ ] Justificacion es OBLIGATORIA
- [ ] Registra quien anula, cuando, y por que
- [ ] Puede anularse desde PENDIENTE o CONFIRMADO
- [ ] Anulacion es IRREVERSIBLE
- [ ] Actualiza estado de compromiso (resta el monto)

## Notas de Implementacion

Agregar campos a la entidad Aporte:
```typescript
@Entity('aportes')
export class Aporte extends BaseEntity {
  // ... campos existentes

  @Column({ nullable: true })
  anuladoBy: string;

  @Column({ type: 'timestamp', nullable: true })
  anuladoAt: Date;

  @Column({ type: 'text', nullable: true })
  motivoAnulacion: string; // Obligatorio si estado = ANULADO
}
```

Controller NestJS:
```typescript
@Controller('aportes')
@UseGuards(JwtAuthGuard)
export class AportesController {
  @Patch(':id/anular')
  @Roles(Role.ADMIN)
  async anular(
    @Param('id') id: string,
    @Body() anularDto: AnularAporteDto,
    @CurrentUser() user: UserPayload,
  ) {
    return this.aportesService.anular(id, anularDto.justificacion, user);
  }
}
```

Request:
```
PATCH /api/.../aportes/:id/anular
Body: {
  "justificacion": "Cheque devuelto por fondos insuficientes"
}
```

Response (200):
```json
{
  "id": "uuid",
  "monto": "50000.00",
  "estado": "ANULADO",
  "estadoAnterior": "CONFIRMADO",
  "motivoAnulacion": "Cheque devuelto por fondos insuficientes",
  "anuladoBy": {
    "id": "uuid",
    "nombre": "Admin Lopez"
  },
  "anuladoAt": "2025-02-20T15:00:00Z"
}
```

IMPORTANTE: La anulacion de un aporte confirmado afecta:
- El total recaudado del objetivo
- El estado del compromiso asociado
- Los reportes y calculos

## Testing

- [ ] Aporte PENDIENTE se anula correctamente
- [ ] Aporte CONFIRMADO se anula correctamente
- [ ] Sin justificacion retorna 400
- [ ] Aporte ya ANULADO no puede anularse de nuevo
- [ ] Historial registra la anulacion
- [ ] Estado compromiso se recalcula
