# OB-007-B-001: Implementar confirmacion de aporte

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-007 - Aportes Reales |
| Story | OB-007-B - Estados e inmutabilidad de aportes |
| Status | pending |
| Priority | critical |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, confirmacion, estado |
| Depends on | OB-007-A-002 |
| Assigned | unassigned |

## Descripcion

Implementar el endpoint para confirmar un aporte, cambiando su estado de PENDIENTE a CONFIRMADO. Solo los aportes confirmados se contabilizan en los calculos de avance.

## Contexto Tecnico

### Archivos afectados
- `src/api/routes/aportes.routes.ts`
- `src/api/controllers/aportes.controller.ts`
- `src/services/aporte.service.ts`

### Enfoque tecnico
Endpoint PATCH para cambio de estado. Registrar quien confirma y cuando.

## Criterios de Aceptacion

- [ ] PATCH /api/.../aportes/:id/confirmar implementado
- [ ] Solo aportes en estado PENDIENTE pueden confirmarse
- [ ] Registra confirmedBy y confirmedAt
- [ ] Crea entrada en historial de aporte
- [ ] Actualiza estado de compromiso asociado (si existe)

## Notas de Implementacion

Request:
```
PATCH /api/copropiedades/:copId/objetivos/:objId/actividades/:actId/aportes/:id/confirmar
Authorization: Bearer <token-admin>
Body: {
  "observaciones": "Verificado contra recibo bancario" // opcional
}
```

Response (200):
```json
{
  "id": "uuid",
  "monto": "50000.00",
  "estado": "CONFIRMADO",
  "estadoAnterior": "PENDIENTE",
  "confirmedBy": {
    "id": "uuid",
    "nombre": "Admin Lopez"
  },
  "confirmedAt": "2025-02-16T09:00:00Z"
}
```

Logica:
```typescript
async function confirmarAporte(aporteId: string, userId: string) {
  const aporte = await typeorm.aporte.findUnique({ where: { id: aporteId } });

  if (aporte.estado !== 'PENDIENTE') {
    throw new BusinessError(
      `Solo se pueden confirmar aportes pendientes. Estado actual: ${aporte.estado}`
    );
  }

  // Actualizar aporte
  await typeorm.aporte.update({
    where: { id: aporteId },
    data: {
      estado: 'CONFIRMADO',
      confirmedBy: userId,
      confirmedAt: new Date()
    }
  });

  // Registrar en historial
  await registrarHistorial(aporteId, 'CONFIRMACION', userId);

  // Actualizar estado compromiso si existe
  if (aporte.compromisoId) {
    await actualizarEstadoCompromiso(aporte.compromisoId);
  }
}
```

## Testing

- [ ] Aporte PENDIENTE se confirma exitosamente
- [ ] Aporte ya CONFIRMADO no puede confirmarse de nuevo
- [ ] Aporte ANULADO no puede confirmarse
- [ ] confirmedBy y confirmedAt se registran
- [ ] Historial se crea
