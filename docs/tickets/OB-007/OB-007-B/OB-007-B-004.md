# OB-007-B-004: Bloquear eliminacion fisica de aportes

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-007 - Aportes Reales |
| Story | OB-007-B - Estados e inmutabilidad de aportes |
| Status | pending |
| Priority | critical |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, seguridad, inmutabilidad |
| Depends on | OB-007-A-001 |
| Assigned | unassigned |

## Descripcion

Implementar medidas de seguridad que impidan la eliminacion fisica de aportes a nivel de aplicacion y base de datos. Esto es fundamental para el principio de inmutabilidad.

## Contexto Tecnico

### Archivos afectados
- `src/services/aporte.service.ts`
- `src/api/routes/aportes.routes.ts`
- Migracion SQL para trigger (opcional)

### Enfoque tecnico
Multiples capas de proteccion: no exponer endpoint DELETE, middleware de proteccion, y opcionalmente trigger en BD.

## Criterios de Aceptacion

- [ ] NO existe endpoint DELETE para aportes
- [ ] Intentar eliminar via TypeORM lanza error
- [ ] Subscriber intercepta cualquier intento de delete
- [ ] Log de seguridad si se intenta eliminar
- [ ] Documentacion clara sobre inmutabilidad

## Notas de Implementacion

1. **No exponer endpoint DELETE**:
```typescript
// NO IMPLEMENTAR
// router.delete('/:id', ...);
```

2. **Subscriber de TypeORM para bloquear delete**:
```typescript
// apps/api/src/subscribers/aporte.subscriber.ts

import { EventSubscriber, EntitySubscriberInterface, RemoveEvent, Logger } from 'typeorm';
import { Aporte } from '../entities/aporte.entity';

@EventSubscriber()
export class AporteSubscriber implements EntitySubscriberInterface<Aporte> {
  private readonly logger = new Logger(AporteSubscriber.name);

  listenTo() {
    return Aporte;
  }

  beforeRemove(event: RemoveEvent<Aporte>) {
    this.logger.warn(`Intento de eliminar aporte: ${event.entityId}`);
    throw new Error(
      'Los aportes no pueden eliminarse. Use anulacion en su lugar.'
    );
  }
}
```

3. **Trigger de base de datos (opcional, capa adicional)**:
```sql
CREATE OR REPLACE FUNCTION prevent_aporte_delete()
RETURNS TRIGGER AS $$
BEGIN
  RAISE EXCEPTION 'No se permite eliminar aportes. Principio de inmutabilidad.';
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER no_delete_aporte
BEFORE DELETE ON "Aporte"
FOR EACH ROW
EXECUTE FUNCTION prevent_aporte_delete();
```

4. **Log de intentos**:
```typescript
if (params.model === 'Aporte' && params.action === 'delete') {
  logger.security({
    event: 'ATTEMPTED_APORTE_DELETE',
    aporteId: params.args.where.id,
    userId: getCurrentUserId(),
    timestamp: new Date()
  });
  throw new Error('...');
}
```

## Testing

- [ ] No existe ruta DELETE
- [ ] aporteRepository.remove() lanza error (bloqueado por Subscriber)
- [ ] aporteRepository.delete() lanza error (bloqueado por Subscriber)
- [ ] Trigger de BD previene delete directo (si se implementa)
- [ ] Log de seguridad se genera en intentos
