# OB-007-B-003: Registrar historial de cambios de aporte

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-007 - Aportes Reales |
| Story | OB-007-B - Estados e inmutabilidad de aportes |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, historial, auditoria, trazabilidad |
| Depends on | OB-007-A-001 |
| Assigned | unassigned |

## Descripcion

Implementar el registro de historial para cada cambio en un aporte, cumpliendo con el principio de auditoria. Cada accion debe quedar documentada permanentemente.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/entities/aporte-historial.entity.ts`
- `apps/api/src/modules/aportes/aporte-historial.service.ts`

### Enfoque tecnico
Entidad TypeORM de historial inmutable que registra cada cambio de estado y modificacion de un aporte.

## Criterios de Aceptacion

- [ ] Entidad AporteHistorial creada con TypeORM
- [ ] Registro automatico al crear aporte
- [ ] Registro automatico al confirmar aporte
- [ ] Registro automatico al anular aporte
- [ ] GET /api/.../aportes/:id/historial disponible
- [ ] Historial es inmutable (solo insert)

## Notas de Implementacion

Entidad AporteHistorial con TypeORM:
```typescript
import { Entity, Column, ManyToOne, JoinColumn, CreateDateColumn, PrimaryGeneratedColumn, Index } from 'typeorm';
import { Aporte, EstadoAporte } from './aporte.entity';
import { User } from './user.entity';

export enum AccionAporte {
  CREACION = 'CREACION',
  CONFIRMACION = 'CONFIRMACION',
  ANULACION = 'ANULACION',
  EDICION = 'EDICION', // Si se permite editar observaciones
}

@Entity('aporte_historial')
export class AporteHistorial {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  @Index()
  aporteId: string;

  @ManyToOne(() => Aporte, (a) => a.historial)
  @JoinColumn({ name: 'aporteId' })
  aporte: Aporte;

  @Column({
    type: 'enum',
    enum: AccionAporte,
  })
  accion: AccionAporte;

  @Column({
    type: 'enum',
    enum: EstadoAporte,
    nullable: true,
  })
  estadoAnterior: EstadoAporte;

  @Column({
    type: 'enum',
    enum: EstadoAporte,
    nullable: true,
  })
  estadoNuevo: EstadoAporte;

  @Column({ type: 'text', nullable: true })
  detalle: string; // Justificacion, observaciones

  @Column()
  userId: string;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'userId' })
  user: User;

  @Column({ nullable: true })
  ipAddress: string;

  @CreateDateColumn()
  createdAt: Date;
}
```

Controller NestJS para historial:
```typescript
@Controller('aportes')
@UseGuards(JwtAuthGuard)
export class AportesController {
  @Get(':id/historial')
  async getHistorial(@Param('id') id: string) {
    return this.aportesService.getHistorial(id);
  }
}
```

Response:
```json
{
  "data": [
    {
      "accion": "CREACION",
      "estadoNuevo": "PENDIENTE",
      "usuario": "Admin Lopez",
      "fecha": "2025-02-15T10:30:00Z",
      "ip": "192.168.1.100"
    },
    {
      "accion": "CONFIRMACION",
      "estadoAnterior": "PENDIENTE",
      "estadoNuevo": "CONFIRMADO",
      "usuario": "Admin Lopez",
      "fecha": "2025-02-16T09:00:00Z"
    }
  ]
}
```

## Testing

- [ ] Creacion de aporte crea historial
- [ ] Confirmacion crea historial
- [ ] Anulacion crea historial con detalle
- [ ] Historial es consultable
- [ ] No se puede modificar historial existente
