# OB-012-A-003: Implementar servicio de auditoría base

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-012 - Auditoría y Trazabilidad |
| Story | OB-012-A - Modelo de auditoría |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, servicio, typescript |
| Depends on | OB-012-A-001 |
| Assigned | unassigned |

## Descripcion

Implementar el servicio base de auditoría que será utilizado por otros módulos para registrar operaciones.

## Criterios de Aceptacion

- [ ] Clase AuditService implementada
- [ ] Método para registrar operaciones
- [ ] Captura automática de contexto (IP, user agent)
- [ ] Manejo de errores sin afectar operación principal

## Notas de Implementacion

```typescript
// apps/api/src/modules/audit/audit.service.ts

import { Injectable, Logger } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { AuditLog, TipoOperacion, EntidadAuditada } from '../../entities/audit-log.entity';

interface AuditContext {
  usuarioId: string;
  ipAddress?: string;
  userAgent?: string;
}

interface AuditEntry {
  tipoOperacion: TipoOperacion;
  entidad: EntidadAuditada;
  entidadId: string;
  valorAnterior?: object;
  valorNuevo?: object;
  descripcion?: string;
}

@Injectable()
export class AuditService {
  private readonly logger = new Logger(AuditService.name);

  constructor(
    @InjectRepository(AuditLog)
    private auditLogRepository: Repository<AuditLog>,
  ) {}

  async registrar(
    context: AuditContext,
    entry: AuditEntry
  ): Promise<void> {
    try {
      const auditLog = this.auditLogRepository.create({
        usuarioId: context.usuarioId,
        ipAddress: context.ipAddress,
        userAgent: context.userAgent,
        tipoOperacion: entry.tipoOperacion,
        entidad: entry.entidad,
        entidadId: entry.entidadId,
        valorAnterior: entry.valorAnterior,
        valorNuevo: entry.valorNuevo,
        descripcion: entry.descripcion,
      });
      await this.auditLogRepository.save(auditLog);
    } catch (error) {
      // Log error pero no fallar la operación principal
      this.logger.error('Error registrando auditoría:', error);
    }
  }

  async registrarCambio<T extends object>(
    context: AuditContext,
    entidad: EntidadAuditada,
    entidadId: string,
    valorAnterior: T,
    valorNuevo: T
  ): Promise<void> {
    await this.registrar(context, {
      tipoOperacion: TipoOperacion.ACTUALIZAR,
      entidad,
      entidadId,
      valorAnterior,
      valorNuevo,
      descripcion: this.generarDescripcionCambio(valorAnterior, valorNuevo),
    });
  }

  private generarDescripcionCambio<T extends object>(
    anterior: T,
    nuevo: T
  ): string {
    const cambios: string[] = [];
    for (const key of Object.keys(nuevo)) {
      if (anterior[key] !== nuevo[key]) {
        cambios.push(`${key}: ${anterior[key]} -> ${nuevo[key]}`);
      }
    }
    return cambios.join(', ');
  }
}
```

## Testing

- [ ] Servicio crea registros correctamente
- [ ] Errores no afectan operación principal
- [ ] Contexto se captura correctamente
