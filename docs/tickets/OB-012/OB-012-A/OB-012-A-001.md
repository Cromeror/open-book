# OB-012-A-001: Crear entidad AuditLog con TypeORM

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-012 - Auditoria y Trazabilidad |
| Story | OB-012-A - Modelo de auditoria |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, typeorm, entidad |
| Depends on | OB-001-A-001 |
| Assigned | unassigned |

## Descripcion

Crear la entidad AuditLog con decoradores TypeORM para almacenar todas las operaciones auditables del sistema.

## Criterios de Aceptacion

- [ ] Entidad AuditLog definida con decoradores TypeORM
- [ ] Migracion ejecutada exitosamente
- [ ] Indices para consultas eficientes

## Notas de Implementacion

Entidad AuditLog con TypeORM:
```typescript
import { Entity, Column, ManyToOne, JoinColumn, Index, CreateDateColumn, PrimaryGeneratedColumn } from 'typeorm';
import { User } from './user.entity';

export enum TipoOperacion {
  CREAR = 'CREAR',
  ACTUALIZAR = 'ACTUALIZAR',
  ELIMINAR = 'ELIMINAR',
  ANULAR = 'ANULAR',
  CAMBIO_ESTADO = 'CAMBIO_ESTADO',
  CAMBIO_VISIBILIDAD = 'CAMBIO_VISIBILIDAD',
  LOGIN = 'LOGIN',
  LOGOUT = 'LOGOUT',
}

export enum EntidadAuditada {
  USUARIO = 'USUARIO',
  COPROPIEDAD = 'COPROPIEDAD',
  APARTAMENTO = 'APARTAMENTO',
  OBJETIVO = 'OBJETIVO',
  ACTIVIDAD = 'ACTIVIDAD',
  COMPROMISO = 'COMPROMISO',
  APORTE = 'APORTE',
  PQR = 'PQR',
  VISIBILIDAD = 'VISIBILIDAD',
}

@Entity('audit_logs')
@Index(['usuarioId'])
@Index(['entidad', 'entidadId'])
@Index(['tipoOperacion'])
@Index(['createdAt'])
export class AuditLog {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  // Que operacion
  @Column({
    type: 'enum',
    enum: TipoOperacion,
  })
  tipoOperacion: TipoOperacion;

  @Column({
    type: 'enum',
    enum: EntidadAuditada,
  })
  entidad: EntidadAuditada;

  @Column()
  entidadId: string;

  // Quien
  @Column()
  usuarioId: string;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'usuarioId' })
  usuario: User;

  // Detalles
  @Column({ type: 'jsonb', nullable: true })
  valorAnterior: Record<string, any>; // Estado antes del cambio

  @Column({ type: 'jsonb', nullable: true })
  valorNuevo: Record<string, any>; // Estado despues del cambio

  @Column({ type: 'text', nullable: true })
  descripcion: string; // Descripcion legible

  // Contexto
  @Column({ nullable: true })
  ipAddress: string;

  @Column({ nullable: true })
  userAgent: string;

  // Timestamp (inmutable)
  @CreateDateColumn()
  createdAt: Date;
}
```

## Testing

- [ ] Migracion sin errores
- [ ] Entidad accesible desde repositorio TypeORM
- [ ] Indices creados correctamente
