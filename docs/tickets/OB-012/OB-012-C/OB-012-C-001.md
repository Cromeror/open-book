# OB-012-C-001: Implementar endpoint de consulta de logs

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-012 - Auditoría y Trazabilidad |
| Story | OB-012-C - Consulta y reportes de auditoría |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, consulta |
| Depends on | OB-012-B |
| Assigned | unassigned |

## Descripcion

Crear endpoint para que administradores consulten los logs de auditoría del sistema.

## Criterios de Aceptacion

- [ ] GET /api/admin/auditoria implementado
- [ ] Paginación funcional
- [ ] Solo accesible por administradores
- [ ] Incluye información del usuario que realizó la acción

## Notas de Implementacion

Request:
```
GET /api/admin/auditoria?page=1&limit=50
Authorization: Bearer <token-admin>
```

Response:
```json
{
  "data": [
    {
      "id": "uuid",
      "tipoOperacion": "CREAR",
      "entidad": "APORTE",
      "entidadId": "uuid-del-aporte",
      "usuario": {
        "id": "uuid",
        "email": "usuario@ejemplo.com",
        "nombre": "Juan Pérez"
      },
      "valorAnterior": null,
      "valorNuevo": {
        "monto": "50000.00",
        "estado": "CONFIRMADO"
      },
      "descripcion": "Aporte de 50000.00 registrado para compromiso X",
      "ipAddress": "192.168.1.1",
      "createdAt": "2025-01-15T10:30:00Z"
    }
  ],
  "meta": {
    "total": 1234,
    "page": 1,
    "limit": 50,
    "totalPages": 25
  }
}
```

Implementación del controlador:
```typescript
// GET /api/admin/auditoria
async getAuditLogs(req: Request, res: Response) {
  const { page = 1, limit = 50 } = req.query;

  const [data, total] = await Promise.all([
    typeorm.auditLog.findMany({
      skip: (Number(page) - 1) * Number(limit),
      take: Number(limit),
      orderBy: { createdAt: 'desc' },
      include: {
        usuario: {
          select: { id: true, email: true, nombre: true }
        }
      }
    }),
    typeorm.auditLog.count()
  ]);

  res.json({
    data,
    meta: {
      total,
      page: Number(page),
      limit: Number(limit),
      totalPages: Math.ceil(total / Number(limit))
    }
  });
}
```

## Testing

- [ ] Endpoint retorna datos correctamente
- [ ] Paginación funciona
- [ ] No-admin recibe 403
- [ ] Datos del usuario incluidos
