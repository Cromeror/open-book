# OB-012-C-003: Exportar reportes de auditoría

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-012 - Auditoría y Trazabilidad |
| Story | OB-012-C - Consulta y reportes de auditoría |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, exportacion, reportes |
| Depends on | OB-012-C-002 |
| Assigned | unassigned |

## Descripcion

Implementar funcionalidad para exportar los logs de auditoría en formatos CSV y PDF.

## Criterios de Aceptacion

- [ ] Exportación a CSV implementada
- [ ] Exportación a PDF implementada
- [ ] Aplica los mismos filtros que la consulta
- [ ] Límite de registros por exportación

## Notas de Implementacion

Endpoints:
```
GET /api/admin/auditoria/exportar/csv?[mismos-filtros]
GET /api/admin/auditoria/exportar/pdf?[mismos-filtros]
```

Implementación CSV:
```typescript
import { Parser } from 'json2csv';

async exportarCSV(req: Request, res: Response) {
  const logs = await this.obtenerLogsConFiltros(req.query, 10000); // Máximo 10k

  const campos = [
    { label: 'Fecha', value: 'createdAt' },
    { label: 'Tipo', value: 'tipoOperacion' },
    { label: 'Entidad', value: 'entidad' },
    { label: 'ID Entidad', value: 'entidadId' },
    { label: 'Usuario', value: 'usuario.email' },
    { label: 'Descripción', value: 'descripcion' },
    { label: 'IP', value: 'ipAddress' },
  ];

  const parser = new Parser({ fields: campos });
  const csv = parser.parse(logs);

  res.header('Content-Type', 'text/csv');
  res.header('Content-Disposition', 'attachment; filename=auditoria.csv');
  res.send(csv);
}
```

Implementación PDF:
```typescript
import PDFDocument from 'pdfkit';

async exportarPDF(req: Request, res: Response) {
  const logs = await this.obtenerLogsConFiltros(req.query, 1000); // Máximo 1k para PDF

  const doc = new PDFDocument();

  res.header('Content-Type', 'application/pdf');
  res.header('Content-Disposition', 'attachment; filename=auditoria.pdf');

  doc.pipe(res);

  // Encabezado
  doc.fontSize(18).text('Reporte de Auditoría', { align: 'center' });
  doc.moveDown();
  doc.fontSize(10).text(`Generado: ${new Date().toISOString()}`);
  doc.text(`Total registros: ${logs.length}`);
  doc.moveDown();

  // Tabla de datos
  for (const log of logs) {
    doc.fontSize(9);
    doc.text(`${log.createdAt} | ${log.tipoOperacion} | ${log.entidad}`);
    doc.text(`  Usuario: ${log.usuario.email}`);
    doc.text(`  Descripción: ${log.descripcion || 'N/A'}`);
    doc.moveDown(0.5);
  }

  doc.end();
}
```

## Testing

- [ ] CSV se descarga correctamente
- [ ] PDF se genera correctamente
- [ ] Filtros se aplican en exportación
- [ ] Límite de registros respetado
