# OB-012-C-002: Implementar filtros avanzados de búsqueda

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-012 - Auditoría y Trazabilidad |
| Story | OB-012-C - Consulta y reportes de auditoría |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, filtros |
| Depends on | OB-012-C-001 |
| Assigned | unassigned |

## Descripcion

Agregar filtros avanzados al endpoint de auditoría para facilitar la búsqueda de operaciones específicas.

## Criterios de Aceptacion

- [ ] Filtro por rango de fechas
- [ ] Filtro por tipo de operación
- [ ] Filtro por entidad
- [ ] Filtro por usuario
- [ ] Filtro por entidad específica (entidadId)

## Notas de Implementacion

Request con filtros:
```
GET /api/admin/auditoria?
  page=1&
  limit=50&
  fechaDesde=2025-01-01&
  fechaHasta=2025-01-31&
  tipoOperacion=ANULAR&
  entidad=APORTE&
  usuarioId=uuid&
  entidadId=uuid-del-aporte
```

Implementación:
```typescript
async getAuditLogs(req: Request, res: Response) {
  const {
    page = 1,
    limit = 50,
    fechaDesde,
    fechaHasta,
    tipoOperacion,
    entidad,
    usuarioId,
    entidadId
  } = req.query;

  const where: typeorm.AuditLogWhereInput = {};

  // Filtro por fechas
  if (fechaDesde || fechaHasta) {
    where.createdAt = {};
    if (fechaDesde) {
      where.createdAt.gte = new Date(fechaDesde as string);
    }
    if (fechaHasta) {
      where.createdAt.lte = new Date(fechaHasta as string);
    }
  }

  // Filtros exactos
  if (tipoOperacion) {
    where.tipoOperacion = tipoOperacion as TipoOperacion;
  }
  if (entidad) {
    where.entidad = entidad as EntidadAuditada;
  }
  if (usuarioId) {
    where.usuarioId = usuarioId as string;
  }
  if (entidadId) {
    where.entidadId = entidadId as string;
  }

  const [data, total] = await Promise.all([
    typeorm.auditLog.findMany({
      where,
      skip: (Number(page) - 1) * Number(limit),
      take: Number(limit),
      orderBy: { createdAt: 'desc' },
      include: {
        usuario: {
          select: { id: true, email: true, nombre: true }
        }
      }
    }),
    typeorm.auditLog.count({ where })
  ]);

  res.json({
    data,
    meta: {
      total,
      page: Number(page),
      limit: Number(limit),
      totalPages: Math.ceil(total / Number(limit)),
      filtros: { fechaDesde, fechaHasta, tipoOperacion, entidad, usuarioId, entidadId }
    }
  });
}
```

## Testing

- [ ] Filtro por fechas funciona
- [ ] Filtro por tipo de operación funciona
- [ ] Múltiples filtros combinados funcionan
- [ ] Sin filtros retorna todos los logs
