# OB-012-B-001: Implementar interceptor de auditoria

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-012 - Auditoria y Trazabilidad |
| Story | OB-012-B - Registro automatico de operaciones |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, interceptor, nestjs |
| Depends on | OB-012-A-003 |
| Assigned | unassigned |

## Descripcion

Crear interceptor de NestJS que capture automaticamente el contexto de auditoria para cada request.

## Criterios de Aceptacion

- [ ] Interceptor captura IP y User Agent
- [ ] Contexto disponible en toda la cadena de request
- [ ] Servicio de auditoria inyectable desde cualquier punto

## Notas de Implementacion

```typescript
// apps/api/src/modules/audit/interceptors/audit.interceptor.ts

import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
} from '@nestjs/common';
import { Observable } from 'rxjs';
import { Request } from 'express';

export interface AuditContext {
  usuarioId: string;
  ipAddress: string;
  userAgent: string;
}

export const AUDIT_CONTEXT = 'auditContext';

@Injectable()
export class AuditInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest<Request>();

    // Capturar contexto
    const ipAddress = request.ip ||
      request.headers['x-forwarded-for']?.toString() ||
      'unknown';
    const userAgent = request.headers['user-agent'] || 'unknown';

    // Adjuntar contexto al request
    const auditContext: AuditContext = {
      usuarioId: (request as any).user?.id || 'anonymous',
      ipAddress,
      userAgent,
    };

    request[AUDIT_CONTEXT] = auditContext;

    return next.handle();
  }
}
```

Decorador para obtener contexto de auditoria:
```typescript
// apps/api/src/modules/audit/decorators/audit-context.decorator.ts

import { createParamDecorator, ExecutionContext } from '@nestjs/common';
import { AUDIT_CONTEXT, AuditContext } from '../interceptors/audit.interceptor';

export const GetAuditContext = createParamDecorator(
  (data: unknown, ctx: ExecutionContext): AuditContext => {
    const request = ctx.switchToHttp().getRequest();
    return request[AUDIT_CONTEXT];
  },
);
```

Registrar interceptor globalmente en app.module.ts:
```typescript
// apps/api/src/app.module.ts

import { APP_INTERCEPTOR } from '@nestjs/core';
import { AuditInterceptor } from './modules/audit/interceptors/audit.interceptor';

@Module({
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useClass: AuditInterceptor,
    },
  ],
})
export class AppModule {}
```

Uso en controlador:
```typescript
@Controller('objetivos')
export class ObjetivosController {
  constructor(private auditService: AuditService) {}

  @Post()
  async crear(
    @Body() dto: CrearObjetivoDto,
    @GetAuditContext() auditContext: AuditContext,
  ) {
    const objetivo = await this.objetivosService.crear(dto);

    await this.auditService.registrar(auditContext, {
      tipoOperacion: TipoOperacion.CREAR,
      entidad: EntidadAuditada.OBJETIVO,
      entidadId: objetivo.id,
      valorNuevo: objetivo,
    });

    return objetivo;
  }
}
```

## Testing

- [ ] Interceptor captura IP correctamente
- [ ] User Agent capturado
- [ ] Contexto disponible via decorador @GetAuditContext()
- [ ] AuditService inyectable y funcional
