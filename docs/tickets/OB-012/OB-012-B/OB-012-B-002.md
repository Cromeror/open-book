# OB-012-B-002: Integrar auditoría en operaciones de Aportes

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-012 - Auditoría y Trazabilidad |
| Story | OB-012-B - Registro automático de operaciones |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, aportes, integracion |
| Depends on | OB-012-B-001, OB-007 |
| Assigned | unassigned |

## Descripcion

Integrar el sistema de auditoría en todas las operaciones relacionadas con Aportes, especialmente en creación y anulación.

## Criterios de Aceptacion

- [ ] Creación de aporte genera log de auditoría
- [ ] Anulación de aporte genera log con justificación
- [ ] Cambios de estado quedan registrados
- [ ] Valores anterior y nuevo almacenados

## Notas de Implementacion

En el servicio de aportes:

```typescript
// src/services/aporte.service.ts

async crearAporte(data: CrearAporteDto, req: Request) {
  const aporte = await this.typeorm.aporte.create({
    data: {
      ...data,
      createdBy: req.user.id,
    },
  });

  // Registrar auditoría
  await req.audit.registrar({
    tipoOperacion: 'CREAR',
    entidad: 'APORTE',
    entidadId: aporte.id,
    valorNuevo: aporte,
    descripcion: `Aporte de ${aporte.monto} registrado para compromiso ${aporte.compromisoId}`,
  });

  return aporte;
}

async anularAporte(id: string, justificacion: string, req: Request) {
  const aporteAnterior = await this.typeorm.aporte.findUnique({
    where: { id },
  });

  const aporteAnulado = await this.typeorm.aporte.update({
    where: { id },
    data: {
      estado: 'ANULADO',
      motivoAnulacion: justificacion,
      anuladoPor: req.user.id,
      fechaAnulacion: new Date(),
    },
  });

  // Registrar auditoría de anulación
  await req.audit.registrar({
    tipoOperacion: 'ANULAR',
    entidad: 'APORTE',
    entidadId: id,
    valorAnterior: aporteAnterior,
    valorNuevo: aporteAnulado,
    descripcion: `Aporte anulado. Justificación: ${justificacion}`,
  });

  return aporteAnulado;
}
```

## Testing

- [ ] Log creado al registrar aporte
- [ ] Log de anulación incluye justificación
- [ ] Valores anterior/nuevo son correctos
- [ ] Usuario y contexto registrados
