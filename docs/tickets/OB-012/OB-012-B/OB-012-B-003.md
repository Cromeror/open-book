# OB-012-B-003: Integrar auditoría en cambios de visibilidad

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-012 - Auditoría y Trazabilidad |
| Story | OB-012-B - Registro automático de operaciones |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, visibilidad, integracion |
| Depends on | OB-012-B-001, OB-011 |
| Assigned | unassigned |

## Descripcion

Integrar el sistema de auditoría en todos los cambios de visibilidad, tanto por usuario como administrativos.

## Criterios de Aceptacion

- [ ] Cambio por usuario genera log
- [ ] Cambio administrativo genera log detallado
- [ ] Causal y justificación almacenados
- [ ] Doble registro: ConsentimientoVisibilidad + AuditLog

## Notas de Implementacion

```typescript
// src/services/visibilidad.service.ts

async cambiarVisibilidadUsuario(
  usuarioId: string,
  nuevaVisibilidad: string,
  req: Request
) {
  const consentimientoAnterior = await this.obtenerConsentimientoActual(usuarioId);

  // Crear nuevo consentimiento
  const nuevoConsentimiento = await this.typeorm.consentimientoVisibilidad.create({
    data: {
      usuarioId,
      visibilidad: nuevaVisibilidad,
      fechaConsentimiento: new Date(),
      metodoConsentimiento: 'WEB',
    },
  });

  // Registrar en AuditLog
  await req.audit.registrar({
    tipoOperacion: 'CAMBIO_VISIBILIDAD',
    entidad: 'VISIBILIDAD',
    entidadId: nuevoConsentimiento.id,
    valorAnterior: { visibilidad: consentimientoAnterior?.visibilidad || 'PUBLICO' },
    valorNuevo: { visibilidad: nuevaVisibilidad },
    descripcion: `Usuario cambió su visibilidad a ${nuevaVisibilidad}`,
  });

  return nuevoConsentimiento;
}

async cambiarVisibilidadAdministrativo(
  usuarioId: string,
  data: CambioAdministrativoDto,
  req: Request
) {
  const consentimientoAnterior = await this.obtenerConsentimientoActual(usuarioId);

  // Crear consentimiento administrativo
  const nuevoConsentimiento = await this.typeorm.consentimientoVisibilidad.create({
    data: {
      usuarioId,
      visibilidad: data.nuevaVisibilidad,
      fechaConsentimiento: new Date(),
      metodoConsentimiento: 'ADMIN',
      cambiadoPorAdmin: true,
      adminId: req.user.id,
      causal: data.causal,
      justificacion: data.justificacion,
      soporteUrl: data.soporteUrl,
    },
  });

  // Registrar en AuditLog con más detalle
  await req.audit.registrar({
    tipoOperacion: 'CAMBIO_VISIBILIDAD',
    entidad: 'VISIBILIDAD',
    entidadId: nuevoConsentimiento.id,
    valorAnterior: {
      visibilidad: consentimientoAnterior?.visibilidad || 'PUBLICO'
    },
    valorNuevo: {
      visibilidad: data.nuevaVisibilidad,
      causal: data.causal,
      justificacion: data.justificacion,
    },
    descripcion: `Cambio administrativo de visibilidad. Causal: ${data.causal}. Justificación: ${data.justificacion}`,
  });

  return nuevoConsentimiento;
}
```

## Testing

- [ ] Cambio por usuario genera log simple
- [ ] Cambio admin genera log con causal
- [ ] Justificación almacenada en ambos lugares
- [ ] Admin identificado en el log
