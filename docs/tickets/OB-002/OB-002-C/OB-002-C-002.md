# OB-002-C-002: Crear Guard de autorizacion NestJS

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-002 - Gestion de Usuarios y Autenticacion |
| Story | OB-002-C - Sistema de roles y permisos |
| Status | done |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, guard, autorizacion, nestjs |
| Depends on | OB-002-C-001, OB-002-B-003 |
| Assigned | unassigned |

## Descripcion

Crear un Guard de NestJS que verifique si el usuario autenticado tiene los permisos necesarios para acceder a un recurso o ejecutar una accion.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/modules/auth/guards/roles.guard.ts`
- `apps/api/src/common/decorators/roles.decorator.ts`
- `apps/api/src/modules/**/*.controller.ts` (uso del guard)

### Enfoque tecnico
Guard que usa metadata de Reflector para obtener roles/permisos requeridos y verificar contra el usuario en el request.

## Criterios de Aceptacion

- [ ] Guard RolesGuard creado
- [ ] Decorador @Roles() para especificar roles requeridos
- [ ] Decorador @Permissions() para especificar permisos
- [ ] Retorna 403 si no tiene permiso
- [ ] Se puede usar con multiples permisos (OR/AND)
- [ ] Funciona despues del JwtAuthGuard

## Notas de Implementacion

Guard con NestJS:
```typescript
// roles.guard.ts
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { Role } from '../entities/user.entity';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const requiredRoles = this.reflector.getAllAndOverride<Role[]>('roles', [
      context.getHandler(),
      context.getClass(),
    ]);

    if (!requiredRoles) {
      return true;
    }

    const { user } = context.switchToHttp().getRequest();
    return requiredRoles.some((role) => user.role === role);
  }
}
```

Decorador Roles:
```typescript
// roles.decorator.ts
import { SetMetadata } from '@nestjs/common';
import { Role } from '../entities/user.entity';

export const ROLES_KEY = 'roles';
export const Roles = (...roles: Role[]) => SetMetadata(ROLES_KEY, roles);
```

Uso en controller:
```typescript
@Controller('objetivos')
@UseGuards(JwtAuthGuard, RolesGuard)
export class ObjetivosController {
  @Post()
  @Roles(Role.ADMIN)
  create(@Body() dto: CreateObjetivoDto) {
    return this.objetivosService.create(dto);
  }
}
```

## Testing

- [ ] Usuario con rol permitido pasa el guard
- [ ] Usuario sin rol permitido recibe 403
- [ ] Usuario no autenticado recibe 401
- [ ] Multiples roles funcionan con logica OR
