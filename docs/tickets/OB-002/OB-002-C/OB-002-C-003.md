# OB-002-C-003: Implementar decoradores de permisos NestJS

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-002 - Gestion de Usuarios y Autenticacion |
| Story | OB-002-C - Sistema de roles y permisos |
| Status | done |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, decoradores, nestjs |
| Depends on | OB-002-C-002 |
| Assigned | unassigned |

## Descripcion

Crear decoradores NestJS adicionales para simplificar la aplicacion de permisos en controllers. Esto mejora la legibilidad y mantenibilidad del codigo de autorizacion usando el sistema de metadata de NestJS.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/common/decorators/permissions.decorator.ts`
- `apps/api/src/modules/auth/guards/permissions.guard.ts`
- `apps/api/src/modules/**/*.controller.ts` (uso)

### Enfoque tecnico
Usar decoradores de NestJS con SetMetadata y Reflector para aplicar la logica de verificacion de permisos de forma declarativa.

## Criterios de Aceptacion

- [ ] Decorador @RequirePermission(permission) creado
- [ ] PermissionsGuard que verifica permisos
- [ ] Los decoradores funcionan con metodos de controller
- [ ] Compatible con la arquitectura modular de NestJS
- [ ] Documentacion de uso incluida

## Notas de Implementacion

Decorador de permisos:
```typescript
// permissions.decorator.ts
import { SetMetadata } from '@nestjs/common';

export const PERMISSIONS_KEY = 'permissions';
export const RequirePermission = (...permissions: Permission[]) =>
  SetMetadata(PERMISSIONS_KEY, permissions);
```

Guard de permisos:
```typescript
// permissions.guard.ts
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { PERMISSIONS_KEY } from '../decorators/permissions.decorator';

@Injectable()
export class PermissionsGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const requiredPermissions = this.reflector.getAllAndOverride<Permission[]>(
      PERMISSIONS_KEY,
      [context.getHandler(), context.getClass()],
    );

    if (!requiredPermissions) {
      return true;
    }

    const { user } = context.switchToHttp().getRequest();
    return requiredPermissions.some((permission) =>
      hasPermission(user.role, permission),
    );
  }
}
```

Uso en controller:
```typescript
@Controller('objetivos')
@UseGuards(JwtAuthGuard, PermissionsGuard)
export class ObjetivosController {
  @Post()
  @RequirePermission(Permission.OBJETIVOS_CREATE)
  async create(@Body() dto: CreateObjetivoDto) {
    return this.objetivosService.create(dto);
  }
}
```

## Testing

- [ ] Decorador aplica metadata correctamente
- [ ] La verificacion de permisos funciona via guard
- [ ] Multiples decoradores pueden combinarse
