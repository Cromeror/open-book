# OB-002-C-006: Crear sistema de registro de modulos

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-002 - Gestion de Usuarios y Autenticacion |
| Story | OB-002-C - Sistema de permisos por modulos |
| Status | pending |
| Priority | high |
| Created | 2026-01-05 |
| Updated | 2026-01-05 |
| Labels | task, modulos, migraciones, registro, sistema |
| Depends on | OB-002-C-001 |
| Assigned | unassigned |

## Descripcion

Implementar sistema para registrar modulos y sus permisos de forma automatizada mediante migraciones de TypeORM. Cada modulo del sistema se registra con sus permisos disponibles, permitiendo agregar nuevos modulos conforme se desarrollan.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/modules/permissions/module-registry.service.ts`
- `apps/api/src/modules/permissions/module-registry.ts` (configuracion)
- `apps/api/src/database/migrations/XXXXXX-SeedInitialModules.ts`
- `apps/api/src/database/migrations/XXXXXX-AddNewModule.ts` (template)

### Enfoque tecnico
Los modulos se definen en codigo y se sincronizan con la BD via migraciones. Cada migracion puede agregar nuevos modulos o nuevos permisos a modulos existentes.

## Criterios de Aceptacion

- [ ] Archivo de configuracion de modulos creado
- [ ] Migracion inicial con todos los modulos base
- [ ] Servicio para registrar/actualizar modulos
- [ ] Template de migracion para agregar nuevos modulos
- [ ] Modulos se pueden desactivar sin eliminar
- [ ] Permisos se pueden agregar a modulos existentes
- [ ] Validacion de modulos duplicados
- [ ] Log de modulos registrados al iniciar

## Notas de Implementacion

```typescript
// module-registry.ts - Configuracion de modulos
export interface ModuleDefinition {
  code: string;
  name: string;
  description: string;
  permissions: {
    code: string;
    name: string;
    description?: string;
  }[];
}

export const SYSTEM_MODULES: ModuleDefinition[] = [
  {
    code: 'users',
    name: 'Gestion de Usuarios',
    description: 'Administracion de usuarios del sistema',
    permissions: [
      { code: 'read', name: 'Ver usuarios', description: 'Ver lista y detalle de usuarios' },
      { code: 'update', name: 'Editar usuarios', description: 'Modificar datos de usuarios' },
    ],
  },
  {
    code: 'copropiedades',
    name: 'Copropiedades',
    description: 'Gestion de copropiedades/edificios',
    permissions: [
      { code: 'read', name: 'Ver copropiedades', description: 'Ver informacion de copropiedades' },
      { code: 'update', name: 'Editar copropiedades', description: 'Modificar datos de copropiedades' },
    ],
  },
  {
    code: 'apartamentos',
    name: 'Apartamentos',
    description: 'Gestion de apartamentos/unidades',
    permissions: [
      { code: 'create', name: 'Crear apartamentos' },
      { code: 'read', name: 'Ver apartamentos' },
      { code: 'update', name: 'Editar apartamentos' },
      { code: 'delete', name: 'Eliminar apartamentos' },
    ],
  },
  {
    code: 'objetivos',
    name: 'Objetivos de Recaudo',
    description: 'Definicion de metas de recaudo',
    permissions: [
      { code: 'create', name: 'Crear objetivos' },
      { code: 'read', name: 'Ver objetivos' },
      { code: 'update', name: 'Editar objetivos' },
      { code: 'delete', name: 'Eliminar objetivos' },
    ],
  },
  {
    code: 'actividades',
    name: 'Actividades de Recaudo',
    description: 'Rifas, donaciones, eventos vinculados a objetivos',
    permissions: [
      { code: 'create', name: 'Crear actividades' },
      { code: 'read', name: 'Ver actividades' },
      { code: 'update', name: 'Editar actividades' },
      { code: 'delete', name: 'Eliminar actividades' },
    ],
  },
  {
    code: 'compromisos',
    name: 'Compromisos',
    description: 'Promesas de aporte de apartamentos',
    permissions: [
      { code: 'create', name: 'Crear compromisos' },
      { code: 'read', name: 'Ver compromisos' },
      { code: 'update', name: 'Editar compromisos' },
    ],
  },
  {
    code: 'aportes',
    name: 'Aportes Reales',
    description: 'Registro de contribuciones efectivas',
    permissions: [
      { code: 'create', name: 'Registrar aportes' },
      { code: 'read', name: 'Ver aportes' },
      { code: 'update', name: 'Editar aportes' },
    ],
  },
  {
    code: 'pqr',
    name: 'PQR',
    description: 'Peticiones, quejas y reclamos',
    permissions: [
      { code: 'create', name: 'Crear PQR' },
      { code: 'read', name: 'Ver PQR' },
      { code: 'manage', name: 'Gestionar PQR', description: 'Responder y cerrar PQR' },
    ],
  },
  {
    code: 'reportes',
    name: 'Reportes',
    description: 'Generacion de reportes del sistema',
    permissions: [
      { code: 'read', name: 'Ver reportes' },
      { code: 'export', name: 'Exportar reportes', description: 'Descargar en PDF/Excel' },
    ],
  },
  {
    code: 'auditoria',
    name: 'Auditoria',
    description: 'Logs de auditoria del sistema',
    permissions: [
      { code: 'read', name: 'Ver auditoria', description: 'Consultar historial de cambios' },
    ],
  },
  {
    code: 'notificaciones',
    name: 'Notificaciones',
    description: 'Sistema de notificaciones',
    permissions: [
      { code: 'read', name: 'Ver notificaciones' },
      { code: 'create', name: 'Enviar notificaciones' },
    ],
  },
  {
    code: 'configuracion',
    name: 'Configuracion',
    description: 'Configuracion del sistema',
    permissions: [
      { code: 'read', name: 'Ver configuracion' },
      { code: 'update', name: 'Modificar configuracion' },
    ],
  },
];

// module-registry.service.ts
@Injectable()
export class ModuleRegistryService {
  private readonly logger = new Logger(ModuleRegistryService.name);

  constructor(
    @InjectRepository(Module)
    private moduleRepo: Repository<Module>,
    @InjectRepository(ModulePermission)
    private permissionRepo: Repository<ModulePermission>,
  ) {}

  /**
   * Registra o actualiza un modulo y sus permisos
   */
  async registerModule(definition: ModuleDefinition): Promise<Module> {
    // Buscar modulo existente
    let module = await this.moduleRepo.findOne({
      where: { code: definition.code },
    });

    if (module) {
      // Actualizar nombre y descripcion si cambiaron
      module.name = definition.name;
      module.description = definition.description;
      await this.moduleRepo.save(module);
      this.logger.log(`Modulo actualizado: ${definition.code}`);
    } else {
      // Crear nuevo modulo
      module = this.moduleRepo.create({
        code: definition.code,
        name: definition.name,
        description: definition.description,
        isActive: true,
      });
      await this.moduleRepo.save(module);
      this.logger.log(`Modulo creado: ${definition.code}`);
    }

    // Registrar permisos
    for (const permDef of definition.permissions) {
      await this.registerPermission(module.id, permDef);
    }

    return module;
  }

  /**
   * Registra o actualiza un permiso de modulo
   */
  private async registerPermission(
    moduleId: string,
    definition: { code: string; name: string; description?: string },
  ): Promise<ModulePermission> {
    let permission = await this.permissionRepo.findOne({
      where: { moduleId, code: definition.code },
    });

    if (permission) {
      permission.name = definition.name;
      permission.description = definition.description || null;
      await this.permissionRepo.save(permission);
    } else {
      permission = this.permissionRepo.create({
        moduleId,
        code: definition.code,
        name: definition.name,
        description: definition.description || null,
      });
      await this.permissionRepo.save(permission);
      this.logger.log(`  Permiso creado: ${definition.code}`);
    }

    return permission;
  }

  /**
   * Registra todos los modulos del sistema
   */
  async registerAllModules(): Promise<void> {
    this.logger.log('Iniciando registro de modulos...');

    for (const definition of SYSTEM_MODULES) {
      await this.registerModule(definition);
    }

    this.logger.log(`Registro completado: ${SYSTEM_MODULES.length} modulos`);
  }

  /**
   * Obtiene todos los modulos con sus permisos
   */
  async getAllModules(): Promise<Module[]> {
    return this.moduleRepo.find({
      where: { isActive: true },
      relations: ['permissions'],
      order: { name: 'ASC' },
    });
  }

  /**
   * Desactiva un modulo (soft delete)
   */
  async deactivateModule(code: string): Promise<void> {
    await this.moduleRepo.update({ code }, { isActive: false });
    this.logger.warn(`Modulo desactivado: ${code}`);
  }
}

// Migracion inicial: XXXXXX-SeedInitialModules.ts
import { MigrationInterface, QueryRunner } from 'typeorm';
import { SYSTEM_MODULES } from '../permissions/module-registry';

export class SeedInitialModules1704412800000 implements MigrationInterface {
  name = 'SeedInitialModules1704412800000';

  public async up(queryRunner: QueryRunner): Promise<void> {
    for (const moduleDef of SYSTEM_MODULES) {
      // Insertar modulo
      await queryRunner.query(`
        INSERT INTO modules (id, code, name, description, is_active, created_at, updated_at)
        VALUES (
          uuid_generate_v4(),
          '${moduleDef.code}',
          '${moduleDef.name}',
          '${moduleDef.description}',
          true,
          NOW(),
          NOW()
        )
        ON CONFLICT (code) DO UPDATE SET
          name = EXCLUDED.name,
          description = EXCLUDED.description,
          updated_at = NOW()
      `);

      // Obtener ID del modulo
      const [module] = await queryRunner.query(`
        SELECT id FROM modules WHERE code = '${moduleDef.code}'
      `);

      // Insertar permisos
      for (const permDef of moduleDef.permissions) {
        await queryRunner.query(`
          INSERT INTO module_permissions (id, module_id, code, name, description, created_at, updated_at)
          VALUES (
            uuid_generate_v4(),
            '${module.id}',
            '${permDef.code}',
            '${permDef.name}',
            ${permDef.description ? `'${permDef.description}'` : 'NULL'},
            NOW(),
            NOW()
          )
          ON CONFLICT (module_id, code) DO UPDATE SET
            name = EXCLUDED.name,
            description = EXCLUDED.description,
            updated_at = NOW()
        `);
      }
    }
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    // Eliminar permisos y modulos
    await queryRunner.query(`DELETE FROM module_permissions`);
    await queryRunner.query(`DELETE FROM modules`);
  }
}

// Template para agregar nuevo modulo
// migrations/XXXXXX-AddModuleNuevoModulo.ts
export class AddModuleNuevoModulo implements MigrationInterface {
  name = 'AddModuleNuevoModulo';

  private readonly moduleDef = {
    code: 'nuevo_modulo',
    name: 'Nuevo Modulo',
    description: 'Descripcion del nuevo modulo',
    permissions: [
      { code: 'create', name: 'Crear' },
      { code: 'read', name: 'Ver' },
      { code: 'update', name: 'Editar' },
      { code: 'delete', name: 'Eliminar' },
    ],
  };

  public async up(queryRunner: QueryRunner): Promise<void> {
    // Insertar modulo
    await queryRunner.query(`
      INSERT INTO modules (id, code, name, description, is_active, created_at, updated_at)
      VALUES (
        uuid_generate_v4(),
        '${this.moduleDef.code}',
        '${this.moduleDef.name}',
        '${this.moduleDef.description}',
        true,
        NOW(),
        NOW()
      )
    `);

    const [module] = await queryRunner.query(`
      SELECT id FROM modules WHERE code = '${this.moduleDef.code}'
    `);

    for (const perm of this.moduleDef.permissions) {
      await queryRunner.query(`
        INSERT INTO module_permissions (id, module_id, code, name, created_at, updated_at)
        VALUES (uuid_generate_v4(), '${module.id}', '${perm.code}', '${perm.name}', NOW(), NOW())
      `);
    }
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    const [module] = await queryRunner.query(`
      SELECT id FROM modules WHERE code = '${this.moduleDef.code}'
    `);

    if (module) {
      await queryRunner.query(`
        DELETE FROM module_permissions WHERE module_id = '${module.id}'
      `);
      await queryRunner.query(`
        DELETE FROM modules WHERE id = '${module.id}'
      `);
    }
  }
}
```

## Flujo de Registro

```
1. Desarrollador agrega nuevo modulo a SYSTEM_MODULES
2. Crea migracion usando template
3. Ejecuta migracion: pnpm typeorm:run
4. Modulo disponible para asignar permisos

Alternativa: Al iniciar app, sincronizar automaticamente
- AppModule.onModuleInit() llama moduleRegistryService.registerAllModules()
- Ventaja: No requiere migracion manual
- Desventaja: Menos control, posibles problemas en produccion
```

## Testing

- [ ] Migracion inicial crea todos los modulos
- [ ] Migracion es idempotente (ejecutar multiples veces sin error)
- [ ] Modulos tienen permisos correctos
- [ ] Se pueden agregar nuevos modulos via migracion
- [ ] Se pueden agregar permisos a modulos existentes
- [ ] Desactivar modulo no elimina datos
- [ ] getAllModules retorna solo activos
