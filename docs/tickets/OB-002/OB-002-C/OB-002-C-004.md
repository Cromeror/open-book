# OB-002-C-004: Crear endpoint para cambiar rol de usuario

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-002 - Gestion de Usuarios y Autenticacion |
| Story | OB-002-C - Sistema de roles y permisos |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, roles, admin |
| Depends on | OB-002-C-002 |
| Assigned | unassigned |

## Descripcion

Crear endpoint que permita a administradores cambiar el rol de un usuario. Este cambio debe quedar registrado en el sistema de auditoria para trazabilidad.

## Contexto Tecnico

### Archivos afectados
- `src/api/routes/users.routes.ts`
- `src/api/controllers/users.controller.ts`
- `src/services/user.service.ts`

### Enfoque tecnico
Endpoint PATCH protegido con permiso USUARIOS_MANAGE. Registrar cambio en auditoria con usuario que realizo el cambio.

## Criterios de Aceptacion

- [ ] Endpoint PATCH /api/users/:id/role creado
- [ ] Solo accesible por usuarios con permiso USUARIOS_MANAGE
- [ ] Valida que el rol nuevo sea valido
- [ ] No permite cambiar el propio rol (autoservicio)
- [ ] Registra cambio en sistema de auditoria
- [ ] Retorna usuario actualizado

## Notas de Implementacion

Request:
```
PATCH /api/users/uuid-del-usuario/role
Authorization: Bearer <admin-token>
Body: { "role": "ADMIN" }
```

Response (200):
```json
{
  "id": "uuid",
  "email": "usuario@ejemplo.com",
  "role": "ADMIN",
  "updatedAt": "2025-01-01T00:00:00Z"
}
```

Registro de auditoria:
- Accion: ROLE_CHANGE
- Usuario afectado
- Rol anterior
- Rol nuevo
- Usuario que hizo el cambio
- Fecha/hora

## Testing

- [ ] Admin puede cambiar rol de otro usuario
- [ ] No-admin recibe 403
- [ ] No se puede cambiar el propio rol
- [ ] Rol invalido retorna 400
- [ ] Cambio queda en auditoria
