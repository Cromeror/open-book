# OB-002-B-005: Registrar eventos de login en auditoria

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-002 - Gestion de Usuarios y Autenticacion |
| Story | OB-002-B - Autenticacion con JWT |
| Status | done |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, auditoria, seguridad, trazabilidad |
| Depends on | OB-002-B-001 |
| Assigned | unassigned |

## Descripcion

Implementar el registro de eventos de autenticacion (login exitoso, login fallido, logout) en el sistema de auditoria. Esto es fundamental para el principio de trazabilidad del sistema.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/entities/auth-log.entity.ts`
- `apps/api/src/modules/auth/auth-log.service.ts`
- `apps/api/src/modules/auth/auth.service.ts`

### Enfoque tecnico
Crear entidad TypeORM para registrar eventos de autenticacion con toda la informacion relevante. Integrar con el servicio de autenticacion de NestJS.

## Criterios de Aceptacion

- [x] Entidad AuthLog creada con TypeORM
- [x] Login exitoso registra evento con IP y user agent
- [x] Login fallido registra intento (email, IP, razon)
- [x] Logout registra evento
- [ ] Los eventos son consultables por administradores (pendiente endpoint)
- [x] No se registran contrasenas en ningun caso

## Notas de Implementacion

Entidad AuthLog con TypeORM:
```typescript
import { Entity, Column, ManyToOne, JoinColumn } from 'typeorm';
import { BaseEntity } from './base.entity';
import { User } from './user.entity';

export enum AuthEvent {
  LOGIN = 'LOGIN',
  LOGOUT = 'LOGOUT',
  REFRESH = 'REFRESH',
  PASSWORD_RESET = 'PASSWORD_RESET',
}

@Entity('auth_logs')
export class AuthLog extends BaseEntity {
  @Column({ nullable: true })
  userId: string;

  @ManyToOne(() => User, { nullable: true })
  @JoinColumn({ name: 'userId' })
  user: User;

  @Column({
    type: 'enum',
    enum: AuthEvent,
  })
  event: AuthEvent;

  @Column()
  email: string;

  @Column()
  ipAddress: string;

  @Column({ nullable: true })
  userAgent: string;

  @Column()
  success: boolean;

  @Column({ nullable: true })
  failReason: string;
}
```

Servicio de logging:
```typescript
@Injectable()
export class AuthLogService {
  constructor(
    @InjectRepository(AuthLog)
    private authLogRepository: Repository<AuthLog>,
  ) {}

  async logEvent(data: CreateAuthLogDto): Promise<AuthLog> {
    const log = this.authLogRepository.create(data);
    return this.authLogRepository.save(log);
  }
}
```

Informacion a registrar:
- Tipo de evento (LOGIN, LOGOUT, etc.)
- Usuario (si existe)
- Email intentado
- IP address
- User agent
- Exito/fallo
- Razon de fallo (si aplica)

## Testing

- [ ] Login exitoso crea registro AuthLog
- [ ] Login fallido crea registro con failReason
- [ ] Logout crea registro AuthLog
- [ ] IP y user agent se capturan correctamente
- [ ] No se almacenan contrasenas en logs
