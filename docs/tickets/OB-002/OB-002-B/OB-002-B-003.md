# OB-002-B-003: Crear Guard de autenticacion NestJS

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-002 - Gestion de Usuarios y Autenticacion |
| Story | OB-002-B - Autenticacion con JWT |
| Status | done |
| Priority | critical |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, guard, autenticacion, nestjs |
| Depends on | OB-002-B-002 |
| Assigned | unassigned |

## Descripcion

Crear un Guard de NestJS que verifique el JWT en las solicitudes a rutas protegidas. El guard debe extraer el token del header Authorization, verificarlo usando @nestjs/jwt, y adjuntar el usuario al request.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/modules/auth/guards/jwt-auth.guard.ts`
- `apps/api/src/modules/auth/strategies/jwt.strategy.ts`
- `apps/api/src/common/decorators/current-user.decorator.ts`

### Enfoque tecnico
Usar @nestjs/passport con estrategia JWT. El guard valida el token y la estrategia extrae los datos del usuario.

## Criterios de Aceptacion

- [x] JwtAuthGuard creado usando @nestjs/passport
- [x] JwtStrategy configurada para validar tokens
- [x] Decorador @CurrentUser() para obtener usuario en controllers
- [x] Retorna 401 si no hay token
- [x] Retorna 401 si token es invalido o expirado
- [x] Pasa al siguiente handler si es valido

## Notas de Implementacion

Guard con NestJS Passport:
```typescript
// jwt-auth.guard.ts
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}
```

Estrategia JWT:
```typescript
// jwt.strategy.ts
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor() {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: process.env.JWT_SECRET,
    });
  }

  async validate(payload: any) {
    return {
      id: payload.sub,
      email: payload.email,
      role: payload.role,
    };
  }
}
```

Decorador CurrentUser:
```typescript
// current-user.decorator.ts
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const CurrentUser = createParamDecorator(
  (data: unknown, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    return request.user;
  },
);
```

Uso en controller:
```typescript
@Controller('protected')
@UseGuards(JwtAuthGuard)
export class ProtectedController {
  @Get('profile')
  getProfile(@CurrentUser() user: UserPayload) {
    return user;
  }
}
```

## Testing

- [ ] Request sin header retorna 401
- [ ] Request con token invalido retorna 401
- [ ] Request con token expirado retorna 401
- [ ] Request con token valido pasa al handler
- [ ] @CurrentUser() contiene datos correctos del usuario
