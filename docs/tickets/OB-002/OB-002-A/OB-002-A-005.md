# OB-002-A-005: Registrar consentimiento de visibilidad

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-002 - Gestion de Usuarios y Autenticacion |
| Story | OB-002-A - Modelo de usuario y registro |
| Status | done |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2026-01-05 |
| Labels | task, consentimiento, ley-1581, habeas-data |
| Depends on | OB-002-A-002 |
| Assigned | unassigned |

## Descripcion

Implementar el registro del consentimiento de visibilidad de estados de cuenta al momento del registro, cumpliendo con la Ley 1581 de 2012 (Habeas Data). El usuario debe poder elegir si sus estados de cuenta seran publicos o privados.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/modules/users/users.service.ts`
- `apps/api/src/modules/consent/consent.service.ts`
- `apps/api/src/entities/consent.entity.ts` (entidad Consent si se separa)

### Enfoque tecnico
Registrar el consentimiento con fecha y hora al momento del registro. El consentimiento debe ser explicito y almacenarse con trazabilidad completa usando TypeORM.

## Criterios de Aceptacion

- [x] Campo publicAccountConsent obligatorio en registro
- [x] Fecha de consentimiento (consentDate) se registra automaticamente
- [x] El consentimiento queda asociado al usuario
- [x] Registro de auditoria del consentimiento
- [x] El consentimiento no puede cambiarse directamente (requiere PQR)

## Notas de Implementacion

Segun SUMMARY.md seccion 7 "Visibilidad de Estados de Cuenta":
- Al registro, el residente elige si sus estados de cuenta son publicos
- Esta decision debe ser expresa y clara (Ley 1581 de 2012)
- Si elige publico, podra ver estados de cuenta de otros que tambien eligieron publico
- El cambio de visibilidad requiere solicitud PQR (no es inmediato)

Campos a registrar en la entidad User o Consent:
- publicAccountConsent: boolean
- consentDate: Date (momento del registro)
- consentIpAddress: string (opcional, para auditoria)
- consentUserAgent: string (opcional, para auditoria)

## Testing

- [x] El consentimiento se registra con el usuario
- [x] consentDate se asigna automaticamente
- [x] Un usuario no puede registrarse sin indicar consentimiento
- [x] El campo publicAccountConsent es requerido (no null)
