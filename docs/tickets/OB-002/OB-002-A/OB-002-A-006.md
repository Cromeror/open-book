# OB-002-A-006: Actualizar entidad User para arquitectura sin roles

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-002 - Gestion de Usuarios y Autenticacion |
| Story | OB-002-A - Modelo de usuario y registro |
| Status | done |
| Priority | critical |
| Created | 2026-01-05 |
| Updated | 2026-01-05 |
| Labels | task, entidad, typeorm, usuario, refactor |
| Depends on | OB-002-A-001 |
| Assigned | unassigned |

## Descripcion

Actualizar la entidad User para reflejar la nueva arquitectura de permisos sin roles predefinidos. Eliminar el campo `role` (enum ADMIN/RESIDENT) y reemplazarlo por un flag `isSuperAdmin`. Los permisos de usuario ahora se manejan via modulos y permisos granulares (OB-002-C).

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/entities/user.entity.ts`
- `apps/api/src/types/user.ts`
- `apps/api/src/database/migrations/XXXXXX-RemoveUserRoleAddSuperAdmin.ts`
- `apps/api/src/modules/auth/auth.service.ts` (response de registro)
- DTOs y respuestas que incluyan campo `role`

### Enfoque tecnico
Crear migracion que elimine la columna `role` y agregue `isSuperAdmin`. Actualizar entidad y tipos relacionados.

## Cambios Requeridos

### Antes (con roles)
```typescript
export enum Role {
  ADMIN = 'ADMIN',
  RESIDENT = 'RESIDENT',
}

@Entity('users')
export class User extends BaseEntity {
  // ...

  @Column({
    type: 'enum',
    enum: Role,
    default: Role.RESIDENT,
  })
  role: Role;
}
```

### Después (sin roles)
```typescript
// Eliminar enum Role completamente

@Entity('users')
export class User extends BaseEntity {
  @Column({ unique: true })
  @Index()
  email: string;

  @Column()
  passwordHash: string;

  @Column()
  firstName: string;

  @Column()
  lastName: string;

  @Column({ nullable: true })
  phone: string;

  @Column({ default: false })
  isSuperAdmin: boolean;  // Solo true para el único SuperAdmin

  @Column({ default: true })
  isActive: boolean;

  @Column({ default: false })
  publicAccountConsent: boolean;

  @Column({ type: 'timestamp', nullable: true })
  consentDate: Date;

  @Column({ type: 'timestamp', nullable: true })
  lastLoginAt: Date;

  // Relaciones con permisos (se agregan en OB-002-C)
  // userModules: UserModule[];
  // userPermissions: UserPermission[];
  // poolMemberships: UserPoolMember[];
}
```

## Criterios de Aceptacion

- [x] Campo `role` eliminado de la entidad User
- [x] Enum `Role` eliminado del codigo
- [x] Campo `isSuperAdmin` agregado (boolean, default false)
- [x] Migracion creada para actualizar la tabla
- [x] Migracion maneja datos existentes (convertir ADMIN a isSuperAdmin si aplica)
- [ ] Tests actualizados (no hay tests existentes para actualizar)
- [x] No hay referencias a Role.ADMIN o Role.RESIDENT en el codigo
- [x] Response de registro (POST /api/auth/register) no incluye campo `role`
- [x] DTOs de usuario actualizados sin campo `role`

## Notas de Implementacion

### Migracion

```typescript
// migrations/XXXXXX-RemoveUserRoleAddSuperAdmin.ts
import { MigrationInterface, QueryRunner } from 'typeorm';

export class RemoveUserRoleAddSuperAdmin implements MigrationInterface {
  name = 'RemoveUserRoleAddSuperAdmin';

  public async up(queryRunner: QueryRunner): Promise<void> {
    // 1. Agregar columna isSuperAdmin
    await queryRunner.query(`
      ALTER TABLE users
      ADD COLUMN is_super_admin BOOLEAN NOT NULL DEFAULT false
    `);

    // 2. Migrar datos: si habia un ADMIN, marcarlo como superadmin
    // NOTA: Solo debe haber UN superadmin, verificar manualmente
    // await queryRunner.query(`
    //   UPDATE users SET is_super_admin = true WHERE role = 'ADMIN' LIMIT 1
    // `);

    // 3. Eliminar columna role
    await queryRunner.query(`
      ALTER TABLE users DROP COLUMN role
    `);

    // 4. Eliminar tipo enum si existe
    await queryRunner.query(`
      DROP TYPE IF EXISTS users_role_enum
    `);
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    // 1. Recrear enum
    await queryRunner.query(`
      CREATE TYPE users_role_enum AS ENUM ('ADMIN', 'RESIDENT')
    `);

    // 2. Agregar columna role
    await queryRunner.query(`
      ALTER TABLE users
      ADD COLUMN role users_role_enum NOT NULL DEFAULT 'RESIDENT'
    `);

    // 3. Migrar datos de vuelta
    await queryRunner.query(`
      UPDATE users SET role = 'ADMIN' WHERE is_super_admin = true
    `);

    // 4. Eliminar columna isSuperAdmin
    await queryRunner.query(`
      ALTER TABLE users DROP COLUMN is_super_admin
    `);
  }
}
```

### Buscar y eliminar referencias a Role

```bash
# Buscar todas las referencias al enum Role
grep -r "Role\." apps/api/src/
grep -r "role:" apps/api/src/
grep -r "user.role" apps/api/src/
```

Archivos que probablemente necesiten actualizacion:
- DTOs de usuario (RegisterDto response, UserDto, etc.)
- Guards de autenticacion (eliminar RolesGuard si existe)
- Servicios que verifican roles
- Tests unitarios
- Response de POST /api/auth/register (eliminar `"role": "RESIDENT"` del response)

## Testing

- [ ] Migracion se aplica sin errores
- [ ] Migracion se revierte correctamente (down)
- [ ] Campo isSuperAdmin funciona correctamente
- [x] No hay errores de compilacion por referencias a Role
- [ ] Seed de SuperAdmin funciona (si existe)
- [ ] Login funciona sin campo role

## Notas Importantes

1. **SuperAdmin unico**: Solo debe existir UN usuario con `isSuperAdmin: true`. Esto se puede configurar via:
   - Variable de entorno `SUPER_ADMIN_EMAIL` en el seed inicial
   - O marcar manualmente en BD

2. **Permisos de usuarios**: Despues de esta migracion, los usuarios NO tienen permisos por defecto. Deben asignarse via:
   - Modulos (OB-002-C-001)
   - Permisos granulares (OB-002-C-001)
   - Pools (OB-002-C-004)

3. **Orden de ejecucion**: Esta migracion debe ejecutarse ANTES de las migraciones de OB-002-C que crean las tablas de permisos.
