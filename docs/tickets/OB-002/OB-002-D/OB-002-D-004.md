# OB-002-D-004: Implementar recuperacion de contrasena

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-002 - Gestion de Usuarios y Autenticacion |
| Story | OB-002-D - Gestion de perfil de usuario |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, seguridad, recuperacion |
| Depends on | OB-002-A-004, OB-013 |
| Assigned | unassigned |

## Descripcion

Implementar flujo de recuperacion de contrasena via email. El usuario solicita recuperacion, recibe un link con token de un solo uso, y puede establecer nueva contrasena.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/entities/password-reset-token.entity.ts`
- `apps/api/src/modules/auth/auth.controller.ts`
- `apps/api/src/modules/auth/auth.service.ts`
- `apps/api/src/modules/email/email.service.ts`

### Enfoque tecnico
Dos endpoints NestJS: uno para solicitar reset (genera token y envia email), otro para completar reset (valida token y cambia contrasena).

## Criterios de Aceptacion

- [ ] Endpoint POST /api/auth/forgot-password creado
- [ ] Endpoint POST /api/auth/reset-password creado
- [ ] Token de reset expira en 1 hora
- [ ] Token es de un solo uso
- [ ] Email se envia con link de reset
- [ ] No revelar si el email existe o no (seguridad)
- [ ] Rate limiting para prevenir abuso

## Notas de Implementacion

Entidad PasswordResetToken con TypeORM:
```typescript
import { Entity, Column, ManyToOne, JoinColumn } from 'typeorm';
import { BaseEntity } from './base.entity';
import { User } from './user.entity';

@Entity('password_reset_tokens')
export class PasswordResetToken extends BaseEntity {
  @Column({ unique: true })
  token: string;

  @Column()
  userId: string;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'userId' })
  user: User;

  @Column({ type: 'timestamp' })
  expiresAt: Date;

  @Column({ type: 'timestamp', nullable: true })
  usedAt: Date;
}
```

Controller NestJS:
```typescript
@Controller('auth')
export class AuthController {
  @Post('forgot-password')
  @Throttle({ default: { limit: 3, ttl: 3600000 } })
  async forgotPassword(@Body() dto: ForgotPasswordDto) {
    await this.authService.forgotPassword(dto.email);
    return { message: 'Si el email existe, recibiras instrucciones' };
  }

  @Post('reset-password')
  async resetPassword(@Body() dto: ResetPasswordDto) {
    await this.authService.resetPassword(dto.token, dto.newPassword);
    return { message: 'Contrasena actualizada exitosamente' };
  }
}
```

Flujo:
1. POST /api/auth/forgot-password { email }
   - Siempre retorna 200 (no revelar si existe)
   - Si existe, genera token y envia email
2. POST /api/auth/reset-password { token, newPassword }
   - Valida token no expirado y no usado
   - Cambia contrasena
   - Marca token como usado

Rate limiting: max 3 solicitudes por email por hora (usar @nestjs/throttler)

## Testing

- [ ] Solicitud genera token y envia email
- [ ] Reset con token valido cambia contrasena
- [ ] Token expirado retorna error
- [ ] Token usado retorna error
- [ ] Email inexistente retorna 200 (no revelar)
