# OB-004-B-002: Implementar endpoint de cambio de estado

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-004 - Objetivos de Recaudo |
| Story | OB-004-B - Estados y ciclo de vida de objetivos |
| Status | pending |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, estados |
| Depends on | OB-004-B-001 |
| Assigned | unassigned |

## Descripcion

Implementar endpoint que permita a administradores cambiar el estado de un objetivo, validando que la transicion sea permitida y registrando la justificacion cuando sea requerida.

## Contexto Tecnico

### Archivos afectados
- `src/api/routes/objetivos.routes.ts`
- `src/api/controllers/objetivos.controller.ts`
- `src/services/objetivo.service.ts`

### Enfoque tecnico
Endpoint PATCH especifico para cambio de estado. Validar transicion antes de aplicar.

## Criterios de Aceptacion

- [ ] PATCH /api/.../objetivos/:id/estado implementado
- [ ] Valida que la transicion sea permitida
- [ ] Requiere justificacion para PAUSADO y CANCELADO
- [ ] Solo admins pueden cambiar estado
- [ ] Retorna objetivo actualizado con nuevo estado

## Notas de Implementacion

Request:
```
PATCH /api/copropiedades/:copId/objetivos/:id/estado
Body: {
  "nuevoEstado": "PAUSADO",
  "justificacion": "Fondos insuficientes temporalmente"
}
```

Response (200):
```json
{
  "id": "uuid",
  "nombre": "Reparacion ascensores",
  "estado": "PAUSADO",
  "estadoAnterior": "ACTIVO",
  "justificacion": "Fondos insuficientes temporalmente",
  "cambiadoPor": "admin@ejemplo.com",
  "fechaCambio": "2025-01-20T10:00:00Z"
}
```

Errores:
- 400: Transicion no permitida
- 400: Justificacion requerida pero no proporcionada
- 403: No autorizado

## Testing

- [ ] Transicion valida actualiza estado
- [ ] Transicion invalida retorna 400
- [ ] Sin justificacion cuando es requerida retorna 400
- [ ] No-admin recibe 403
