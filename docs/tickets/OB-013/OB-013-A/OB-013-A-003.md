# OB-013-A-003: Implementar servicio base de notificaciones

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-013 - Notificaciones |
| Story | OB-013-A - Modelo de notificaciones |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, servicio, typescript |
| Depends on | OB-013-A-001 |
| Assigned | unassigned |

## Descripcion

Implementar el servicio base de notificaciones que será utilizado por otros módulos.

## Criterios de Aceptacion

- [ ] Clase NotificacionService implementada
- [ ] Método para crear notificaciones
- [ ] Respeta configuración de canal
- [ ] Distingue obligatorias de opcionales

## Notas de Implementacion

```typescript
// apps/api/src/modules/notificaciones/notificacion.service.ts

import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { InjectQueue } from '@nestjs/bull';
import { Queue } from 'bull';
import { Notificacion, TipoNotificacion, CanalNotificacion } from '../../entities/notificacion.entity';
import { PreferenciaNotificacion } from '../../entities/preferencia-notificacion.entity';

interface CrearNotificacionDto {
  usuarioId: string;
  tipo: TipoNotificacion;
  titulo: string;
  mensaje: string;
  datos?: object;
  entidadTipo?: string;
  entidadId?: string;
}

// Tipos obligatorios según Ley 1581
const TIPOS_OBLIGATORIOS: TipoNotificacion[] = [
  TipoNotificacion.CAMBIO_VISIBILIDAD_PROPIO,
  TipoNotificacion.CAMBIO_VISIBILIDAD_ADMIN,
];

@Injectable()
export class NotificacionService {
  constructor(
    @InjectRepository(Notificacion)
    private notificacionRepository: Repository<Notificacion>,
    @InjectRepository(PreferenciaNotificacion)
    private preferenciaRepository: Repository<PreferenciaNotificacion>,
    @InjectQueue('email') private emailQueue: Queue,
  ) {}

  async crear(dto: CrearNotificacionDto): Promise<void> {
    const esObligatoria = TIPOS_OBLIGATORIOS.includes(dto.tipo);

    // Obtener preferencias del usuario si no es obligatoria
    let canal: CanalNotificacion = CanalNotificacion.AMBOS;
    if (!esObligatoria) {
      const preferencias = await this.obtenerPreferencias(dto.usuarioId, dto.tipo);
      if (preferencias && !preferencias.habilitada) {
        return; // Usuario deshabilitó este tipo
      }
      canal = preferencias?.canal || CanalNotificacion.AMBOS;
    }

    // Crear notificación
    const notificacion = this.notificacionRepository.create({
      usuarioId: dto.usuarioId,
      tipo: dto.tipo,
      titulo: dto.titulo,
      mensaje: dto.mensaje,
      datos: dto.datos,
      entidadTipo: dto.entidadTipo,
      entidadId: dto.entidadId,
      obligatoria: esObligatoria,
      canal,
    });
    await this.notificacionRepository.save(notificacion);

    // Encolar email si corresponde
    if (canal === CanalNotificacion.EMAIL || canal === CanalNotificacion.AMBOS) {
      await this.encolarEmail(notificacion.id);
    }
  }

  async crearParaMultiplesUsuarios(
    usuarioIds: string[],
    dto: Omit<CrearNotificacionDto, 'usuarioId'>
  ): Promise<void> {
    await Promise.all(
      usuarioIds.map(usuarioId =>
        this.crear({ ...dto, usuarioId })
      )
    );
  }

  private async obtenerPreferencias(usuarioId: string, tipo: TipoNotificacion) {
    return this.preferenciaRepository.findOne({
      where: { usuarioId, tipo }
    });
  }

  private async encolarEmail(notificacionId: string): Promise<void> {
    // Implementado en OB-013-B-003
  }
}
```

Uso desde otros módulos:
```typescript
// En el servicio de aportes
await notificacionService.crear({
  usuarioId: aporte.usuarioId,
  tipo: 'APORTE_CONFIRMADO',
  titulo: 'Aporte confirmado',
  mensaje: `Su aporte de $${aporte.monto} ha sido confirmado`,
  datos: { monto: aporte.monto, actividad: actividad.nombre },
  entidadTipo: 'APORTE',
  entidadId: aporte.id,
});
```

## Testing

- [ ] Notificaciones se crean correctamente
- [ ] Obligatorias siempre se envían
- [ ] Preferencias respetadas para opcionales
- [ ] Email se encola cuando corresponde
