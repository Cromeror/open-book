# OB-013-A-001: Crear entidad Notificacion con TypeORM

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-013 - Notificaciones |
| Story | OB-013-A - Modelo de notificaciones |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, typeorm, entidad |
| Depends on | OB-001-A-001 |
| Assigned | unassigned |

## Descripcion

Crear la entidad Notificacion con decoradores TypeORM para almacenar todas las notificaciones del sistema.

## Criterios de Aceptacion

- [ ] Entidad Notificacion definida con decoradores TypeORM
- [ ] Migracion ejecutada exitosamente
- [ ] Indices para consultas eficientes

## Notas de Implementacion

Entidad Notificacion con TypeORM:
```typescript
import { Entity, Column, ManyToOne, JoinColumn, CreateDateColumn, PrimaryGeneratedColumn, Index } from 'typeorm';
import { User } from './user.entity';

export enum TipoNotificacion {
  // Objetivos y Actividades
  NUEVO_OBJETIVO = 'NUEVO_OBJETIVO',
  OBJETIVO_CERRADO = 'OBJETIVO_CERRADO',
  NUEVA_ACTIVIDAD = 'NUEVA_ACTIVIDAD',
  ACTIVIDAD_CERRADA = 'ACTIVIDAD_CERRADA',

  // Aportes
  APORTE_REGISTRADO = 'APORTE_REGISTRADO',
  APORTE_CONFIRMADO = 'APORTE_CONFIRMADO',
  APORTE_ANULADO = 'APORTE_ANULADO',

  // PQR
  PQR_CREADA = 'PQR_CREADA',
  PQR_RESPONDIDA = 'PQR_RESPONDIDA',
  PQR_CERRADA = 'PQR_CERRADA',

  // Visibilidad (Obligatorias - Ley 1581)
  CAMBIO_VISIBILIDAD_PROPIO = 'CAMBIO_VISIBILIDAD_PROPIO',
  CAMBIO_VISIBILIDAD_ADMIN = 'CAMBIO_VISIBILIDAD_ADMIN',

  // Sistema
  BIENVENIDA = 'BIENVENIDA',
  RECORDATORIO = 'RECORDATORIO',
}

export enum CanalNotificacion {
  EMAIL = 'EMAIL',
  IN_APP = 'IN_APP',
  AMBOS = 'AMBOS',
}

@Entity('notificaciones')
@Index(['usuarioId', 'leida'])
@Index(['usuarioId', 'createdAt'])
@Index(['tipo'])
export class Notificacion {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  // Destinatario
  @Column()
  usuarioId: string;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'usuarioId' })
  usuario: User;

  // Contenido
  @Column({
    type: 'enum',
    enum: TipoNotificacion,
  })
  tipo: TipoNotificacion;

  @Column()
  titulo: string;

  @Column({ type: 'text' })
  mensaje: string;

  @Column({ type: 'jsonb', nullable: true })
  datos: Record<string, any>; // Datos adicionales segun el tipo

  // Estado
  @Column({ default: false })
  leida: boolean;

  @Column({ type: 'timestamp', nullable: true })
  fechaLeida: Date;

  // Canal
  @Column({
    type: 'enum',
    enum: CanalNotificacion,
    default: CanalNotificacion.AMBOS,
  })
  canal: CanalNotificacion;

  @Column({ default: false })
  emailEnviado: boolean;

  @Column({ type: 'timestamp', nullable: true })
  fechaEmailEnviado: Date;

  // Obligatoriedad (Ley 1581)
  @Column({ default: false })
  obligatoria: boolean;

  // Referencia a entidad relacionada
  @Column({ nullable: true })
  entidadTipo: string; // OBJETIVO, ACTIVIDAD, APORTE, PQR, etc.

  @Column({ nullable: true })
  entidadId: string;

  // Timestamps
  @CreateDateColumn()
  createdAt: Date;
}
```

## Testing

- [ ] Migracion sin errores
- [ ] Entidad accesible desde repositorio TypeORM
- [ ] Indices creados correctamente
