# OB-013-C-002: Marcar notificaciones como leídas

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-013 - Notificaciones |
| Story | OB-013-C - Notificaciones in-app |
| Status | pending |
| Priority | medium |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, actualizacion |
| Depends on | OB-013-C-001 |
| Assigned | unassigned |

## Descripcion

Implementar endpoints para marcar notificaciones como leídas (individual y masivo).

## Criterios de Aceptacion

- [ ] PUT /api/notificaciones/:id/leer implementado
- [ ] PUT /api/notificaciones/leer-todas implementado
- [ ] Solo el propietario puede marcar
- [ ] Fecha de lectura registrada

## Notas de Implementacion

Marcar una notificación:
```
PUT /api/notificaciones/:id/leer
Authorization: Bearer <token>
```

Response:
```json
{
  "exito": true,
  "notificacion": {
    "id": "uuid",
    "leida": true,
    "fechaLeida": "2025-01-15T10:35:00Z"
  }
}
```

Marcar todas como leídas:
```
PUT /api/notificaciones/leer-todas
Authorization: Bearer <token>
```

Response:
```json
{
  "exito": true,
  "actualizadas": 12
}
```

Implementación:
```typescript
// PUT /api/notificaciones/:id/leer
async marcarLeida(req: Request, res: Response) {
  const { id } = req.params;
  const usuarioId = req.user.id;

  // Verificar propiedad
  const notificacion = await typeorm.notificacion.findFirst({
    where: { id, usuarioId },
  });

  if (!notificacion) {
    return res.status(404).json({ error: 'Notificación no encontrada' });
  }

  if (notificacion.leida) {
    return res.json({ exito: true, notificacion });
  }

  const actualizada = await typeorm.notificacion.update({
    where: { id },
    data: {
      leida: true,
      fechaLeida: new Date(),
    },
  });

  res.json({ exito: true, notificacion: actualizada });
}

// PUT /api/notificaciones/leer-todas
async marcarTodasLeidas(req: Request, res: Response) {
  const usuarioId = req.user.id;

  const resultado = await typeorm.notificacion.updateMany({
    where: {
      usuarioId,
      leida: false,
      canal: { in: ['IN_APP', 'AMBOS'] },
    },
    data: {
      leida: true,
      fechaLeida: new Date(),
    },
  });

  res.json({ exito: true, actualizadas: resultado.count });
}
```

## Testing

- [ ] Marca individual funciona
- [ ] Marca masiva funciona
- [ ] No puede marcar de otro usuario
- [ ] Fecha de lectura se registra
