# OB-013-D-001: Crear entidad de preferencias de notificacion

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-013 - Notificaciones |
| Story | OB-013-D - Preferencias de notificacion |
| Status | pending |
| Priority | low |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, typeorm, entidad |
| Depends on | OB-013-A-001 |
| Assigned | unassigned |

## Descripcion

Crear la entidad de preferencias de notificacion con TypeORM para que los usuarios puedan configurar que notificaciones desean recibir.

## Criterios de Aceptacion

- [ ] Entidad PreferenciaNotificacion creada con TypeORM
- [ ] Migracion ejecutada
- [ ] Valores por defecto establecidos

## Notas de Implementacion

Entidad PreferenciaNotificacion con TypeORM:
```typescript
import { Entity, Column, ManyToOne, JoinColumn, CreateDateColumn, UpdateDateColumn, PrimaryGeneratedColumn, Unique, Index } from 'typeorm';
import { User } from './user.entity';
import { TipoNotificacion, CanalNotificacion } from './notificacion.entity';

@Entity('preferencia_notificacion')
@Unique(['usuarioId', 'tipo'])
@Index(['usuarioId'])
export class PreferenciaNotificacion {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  // Usuario
  @Column()
  usuarioId: string;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'usuarioId' })
  usuario: User;

  // Configuracion por tipo
  @Column({
    type: 'enum',
    enum: TipoNotificacion,
  })
  tipo: TipoNotificacion;

  @Column({ default: true })
  habilitada: boolean;

  @Column({
    type: 'enum',
    enum: CanalNotificacion,
    default: CanalNotificacion.AMBOS,
  })
  canal: CanalNotificacion;

  // Timestamps
  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
```

Servicio para crear valores por defecto:
```typescript
@Injectable()
export class PreferenciaNotificacionService {
  constructor(
    @InjectRepository(PreferenciaNotificacion)
    private preferenciaRepository: Repository<PreferenciaNotificacion>,
  ) {}

  async crearPreferenciasDefault(usuarioId: string): Promise<void> {
    const tiposOpcionales = Object.values(TipoNotificacion).filter(
      t => !TIPOS_OBLIGATORIOS.includes(t)
    );

    const preferencias = tiposOpcionales.map(tipo => ({
      usuarioId,
      tipo,
      habilitada: true,
      canal: CanalNotificacion.AMBOS,
    }));

    await this.preferenciaRepository.save(preferencias);
  }
}
```

Nota: Los tipos obligatorios (CAMBIO_VISIBILIDAD_*) no tienen preferencias porque no pueden deshabilitarse.

## Testing

- [ ] Entidad migrada correctamente
- [ ] Valores por defecto creados
- [ ] Constraint unico funciona
