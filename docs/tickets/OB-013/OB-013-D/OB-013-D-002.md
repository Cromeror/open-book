# OB-013-D-002: Implementar endpoints de preferencias

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-013 - Notificaciones |
| Story | OB-013-D - Preferencias de notificación |
| Status | pending |
| Priority | low |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, api, configuracion |
| Depends on | OB-013-D-001 |
| Assigned | unassigned |

## Descripcion

Implementar endpoints para que los usuarios consulten y modifiquen sus preferencias de notificación.

## Criterios de Aceptacion

- [ ] GET /api/preferencias/notificaciones implementado
- [ ] PUT /api/preferencias/notificaciones implementado
- [ ] Tipos obligatorios no modificables
- [ ] Cambios aplican inmediatamente

## Notas de Implementacion

Consultar preferencias:
```
GET /api/preferencias/notificaciones
Authorization: Bearer <token>
```

Response:
```json
{
  "preferencias": [
    {
      "tipo": "NUEVO_OBJETIVO",
      "nombre": "Nuevos objetivos",
      "descripcion": "Notificaciones cuando se crea un nuevo objetivo de recaudo",
      "habilitada": true,
      "canal": "EMAIL",
      "obligatoria": false
    },
    {
      "tipo": "CAMBIO_VISIBILIDAD_ADMIN",
      "nombre": "Cambios administrativos de visibilidad",
      "descripcion": "Notificaciones obligatorias por ley cuando un admin cambia su visibilidad",
      "habilitada": true,
      "canal": "AMBOS",
      "obligatoria": true
    }
  ]
}
```

Actualizar preferencia:
```
PUT /api/preferencias/notificaciones
Authorization: Bearer <token>
Content-Type: application/json

{
  "tipo": "NUEVO_OBJETIVO",
  "habilitada": false,
  "canal": "IN_APP"
}
```

Response:
```json
{
  "exito": true,
  "preferencia": {
    "tipo": "NUEVO_OBJETIVO",
    "habilitada": false,
    "canal": "IN_APP"
  }
}
```

Implementación:
```typescript
// GET /api/preferencias/notificaciones
async getPreferencias(req: Request, res: Response) {
  const usuarioId = req.user.id;

  const preferencias = await typeorm.preferenciaNotificacion.findMany({
    where: { usuarioId },
  });

  // Agregar información de tipos obligatorios
  const resultado = Object.values(TipoNotificacion).map(tipo => {
    const pref = preferencias.find(p => p.tipo === tipo);
    const obligatoria = TIPOS_OBLIGATORIOS.includes(tipo);

    return {
      tipo,
      nombre: NOMBRES_TIPO[tipo],
      descripcion: DESCRIPCIONES_TIPO[tipo],
      habilitada: obligatoria ? true : (pref?.habilitada ?? true),
      canal: pref?.canal ?? 'AMBOS',
      obligatoria,
    };
  });

  res.json({ preferencias: resultado });
}

// PUT /api/preferencias/notificaciones
async updatePreferencia(req: Request, res: Response) {
  const usuarioId = req.user.id;
  const { tipo, habilitada, canal } = req.body;

  // Validar que no sea obligatorio
  if (TIPOS_OBLIGATORIOS.includes(tipo)) {
    return res.status(400).json({
      error: 'No se puede modificar esta preferencia',
      mensaje: 'Las notificaciones de cambios de visibilidad son obligatorias según la Ley 1581 de 2012',
    });
  }

  const preferencia = await typeorm.preferenciaNotificacion.upsert({
    where: {
      usuarioId_tipo: { usuarioId, tipo },
    },
    create: {
      usuarioId,
      tipo,
      habilitada,
      canal,
    },
    update: {
      habilitada,
      canal,
    },
  });

  res.json({ exito: true, preferencia });
}
```

## Testing

- [ ] Lista todas las preferencias
- [ ] Actualiza correctamente
- [ ] Rechaza modificar obligatorias
- [ ] Upsert funciona para nuevas
