# OB-014-E-004: Adaptar navegacion a metadatos dinamicos

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Permisos y Modulos |
| Story | OB-014-E - Sistema de Permisos Gobernado por Backend |
| Status | done |
| Priority | medium |
| Created | 2026-01-06 |
| Updated | 2026-01-06 |
| Labels | task, frontend, navigation, dynamic |
| Depends on | OB-014-E-002 |

## Descripcion

Modificar el sistema de navegacion para generarse dinamicamente desde los modulos del usuario (obtenidos en `/api/auth/me`) en lugar de usar configuracion estatica.

## Cambios Requeridos

### 1. Eliminar nav-config.ts estatico

El archivo `apps/web/src/lib/nav-config.ts` debe eliminarse. La navegacion se genera desde `moduleRegistry.getNavConfig()`.

### 2. Modificar Sidebar

```typescript
// apps/web/src/components/layout/Sidebar.tsx
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useModuleRegistry } from '@/lib/module-registry.context';
import { usePermissions } from '@/lib/permissions.context';
import { getIconComponent } from '@/lib/icons';
import { Home, Shield, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

export function Sidebar() {
  const pathname = usePathname();
  const { isLoaded, navConfig } = useModuleRegistry();
  const { isSuperAdmin } = usePermissions();

  if (!isLoaded) {
    return (
      <aside className="w-64 border-r bg-white p-4">
        <div className="flex items-center justify-center h-full">
          <Loader2 className="w-6 h-6 animate-spin text-gray-400" />
        </div>
      </aside>
    );
  }

  return (
    <aside className="w-64 border-r bg-white">
      <nav className="p-4 space-y-1">
        {/* Dashboard siempre visible */}
        <NavLink
          href="/dashboard"
          icon={<Home className="w-5 h-5" />}
          label="Inicio"
          isActive={pathname === '/dashboard'}
        />

        {/* Modulos dinamicos del usuario */}
        {navConfig.map((item) => {
          const Icon = getIconComponent(item.icon);
          return (
            <NavLink
              key={item.path}
              href={item.path}
              icon={<Icon className="w-5 h-5" />}
              label={item.label}
              isActive={pathname.startsWith(item.path)}
              data-nav={item.module}
            />
          );
        })}

        {/* Admin solo para SuperAdmin */}
        {isSuperAdmin && (
          <NavLink
            href="/admin"
            icon={<Shield className="w-5 h-5" />}
            label="Administracion"
            isActive={pathname.startsWith('/admin')}
          />
        )}
      </nav>
    </aside>
  );
}

interface NavLinkProps {
  href: string;
  icon: React.ReactNode;
  label: string;
  isActive: boolean;
  'data-nav'?: string;
}

function NavLink({ href, icon, label, isActive, ...props }: NavLinkProps) {
  return (
    <Link
      href={href}
      className={cn(
        'flex items-center gap-3 px-3 py-2 rounded-lg text-sm transition-colors',
        isActive
          ? 'bg-blue-50 text-blue-700 font-medium'
          : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
      )}
      {...props}
    >
      {icon}
      {label}
    </Link>
  );
}
```

### 3. Helper de Iconos

```typescript
// apps/web/src/lib/icons.ts
import {
  Target,
  DollarSign,
  Users,
  Building2,
  Home,
  FileText,
  BarChart3,
  Bell,
  Settings,
  Shield,
  Calendar,
  MessageSquare,
  type LucideIcon,
} from 'lucide-react';

const iconMap: Record<string, LucideIcon> = {
  Target,
  DollarSign,
  Users,
  Building2,
  Home,
  FileText,
  BarChart3,
  Bell,
  Settings,
  Shield,
  Calendar,
  MessageSquare,
};

export function getIconComponent(name: string): LucideIcon {
  return iconMap[name] || FileText;
}
```

### 4. Routing Dinamico

Crear ruta catch-all para modulos CRUD:

```typescript
// apps/web/src/app/(dashboard)/m/[moduleCode]/page.tsx
import { redirect, notFound } from 'next/navigation';
import { getServerPermissions } from '@/lib/permissions.server';
import { moduleRegistry } from '@/lib/module-registry';
import { GenericCRUDModule } from '@/components/modules/GenericCRUDModule';

interface Props {
  params: Promise<{ moduleCode: string }>;
}

export default async function DynamicModulePage({ params }: Props) {
  const { moduleCode } = await params;

  // Verificar acceso
  const permissions = await getServerPermissions();
  if (!permissions.hasModule(moduleCode)) {
    redirect('/dashboard');
  }

  // Obtener metadata
  const metadata = moduleRegistry.getMetadata(moduleCode);
  if (!metadata) {
    notFound();
  }

  // Si es especializado, obtener componente registrado
  if (metadata.type === 'specialized') {
    const Component = moduleRegistry.getSpecializedComponent(moduleCode);
    if (!Component) {
      notFound();
    }
    return (
      <Component
        moduleCode={moduleCode}
        metadata={metadata}
      />
    );
  }

  // Si es CRUD, usar componente generico
  return (
    <GenericCRUDModule
      moduleCode={moduleCode}
      metadata={metadata}
    />
  );
}
```

### 5. Rutas Estaticas para Modulos Especializados

Modulos con subrutas complejas o necesidades especiales mantienen rutas estaticas:

```
apps/web/src/app/(dashboard)/
├── m/[moduleCode]/page.tsx  # Catch-all para CRUD dinamicos
├── reports/                  # Especializado con subrutas
│   ├── page.tsx
│   └── export/page.tsx
├── audit/page.tsx           # Especializado
├── settings/page.tsx        # Especializado
└── admin/                   # SuperAdmin
    ├── page.tsx
    ├── users/page.tsx
    ├── pools/page.tsx
    ├── permissions/page.tsx
    └── modules/page.tsx
```

### 6. Configuracion de Navegacion en Backend

Los modulos CRUD usan paths dinamicos `/m/{code}`:

```json
{
  "code": "goals",
  "nav": {
    "path": "/m/goals",
    "order": 10
  }
}
```

Los modulos especializados usan paths estaticos:

```json
{
  "code": "reports",
  "nav": {
    "path": "/reports",
    "order": 60
  }
}
```

## Criterios de Aceptacion

- [ ] Navegacion se genera desde modulos del usuario
- [ ] Solo aparecen modulos a los que tiene acceso
- [ ] SuperAdmin ve todos los modulos mas seccion admin
- [ ] Ruta catch-all `/m/[moduleCode]` resuelve modulos CRUD
- [ ] Modulos especializados mantienen rutas estaticas
- [ ] Iconos se resuelven dinamicamente desde nombre string
- [ ] Sin errores de hidratacion
- [ ] Loading state mientras se cargan modulos
