# OB-014-E-001: Extender /api/auth/me con modulos y metadata

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-014 - Configuracion de Vistas por Permisos y Modulos |
| Story | OB-014-E - Sistema de Permisos Gobernado por Backend |
| Status | done |
| Priority | high |
| Created | 2026-01-06 |
| Updated | 2026-01-06 |
| Labels | task, backend, permissions, api |
| Depends on | OB-002-C |

## Descripcion

Extender el endpoint `/api/auth/me` para que retorne los modulos a los que el usuario tiene acceso, incluyendo la metadata necesaria para renderizar cada modulo. La metadata CRUD se segrega por accion - solo se incluye la metadata de las acciones que el usuario tiene permiso.

## Endpoint

```
GET /api/auth/me
Authorization: Bearer <token>  (requerido)
```

## Response

```typescript
interface AuthMeResponse {
  user: {
    id: string;
    email: string;
    firstName: string;
    lastName: string;
    isSuperAdmin: boolean;
  };
  modules: ModuleWithPermissions[];
}

interface ModuleWithPermissions {
  code: string;                    // 'goals', 'contributions', etc.
  label: string;                   // 'Objetivos de Recaudo'
  description: string;             // 'Gestiona los objetivos...'
  icon: string;                    // 'Target' (lucide icon)
  type: 'crud' | 'specialized';    // Tipo de modulo

  nav: {
    path: string;                  // '/goals'
    order: number;                 // Orden en menu
  };

  // Config base para modulos CRUD
  entity?: string;                 // 'Objetivo' (solo CRUD)
  endpoint?: string;               // '/api/goals' (solo CRUD)

  // Config para modulos especializados
  component?: string;              // 'ReportsModule' (solo specialized)

  // ACCIONES - Unificado para CRUD y specialized
  // Solo se incluyen las acciones que el usuario tiene permiso
  // El codigo de la accion coincide con el codigo del permiso
  actions: ModuleAction[];
}

// Accion del modulo - el codigo coincide con el codigo de permiso
interface ModuleAction {
  code: string;                    // 'read', 'create', 'update', 'delete', 'view', 'export'
  label: string;                   // 'Ver', 'Crear', 'Editar', 'Eliminar'
  description?: string;            // 'Permite ver registros'
  settings: ActionSettings;        // Tipado segun tipo de accion
}

// ============================================
// Settings tipados para acciones CRUD
// ============================================

type ActionSettings = CrudActionSettings | GenericActionSettings;

type CrudActionSettings =
  | ReadActionSettings
  | CreateActionSettings
  | UpdateActionSettings
  | DeleteActionSettings;

interface ReadActionSettings {
  type: 'read';
  listColumns: ColumnDefinition[];
  filters?: FilterDefinition[];
  sortable?: string[];
  defaultSort?: { field: string; order: 'asc' | 'desc' };
}

interface CreateActionSettings {
  type: 'create';
  fields: FieldDefinition[];
  validation?: ValidationRules;
}

interface UpdateActionSettings {
  type: 'update';
  fields: FieldDefinition[];
  validation?: ValidationRules;
}

interface DeleteActionSettings {
  type: 'delete';
  confirmation: string;
  soft?: boolean;
}

// ============================================
// Settings genericos para acciones especializadas
// ============================================

interface GenericActionSettings {
  type: 'generic';
  [key: string]: unknown;          // Cualquier config adicional
}

// ============================================
// Definiciones auxiliares
// ============================================

interface FieldDefinition {
  name: string;
  label: string;
  type: 'text' | 'number' | 'date' | 'select' | 'textarea' | 'boolean' | 'money';
  required?: boolean;
  options?: Array<{ value: string; label: string }>;
  min?: number;
  max?: number;
  placeholder?: string;
}

interface ColumnDefinition {
  field: string;
  label: string;
  sortable?: boolean;
  format?: 'date' | 'money' | 'boolean';
}

interface FilterDefinition {
  field: string;
  type: 'text' | 'select' | 'date' | 'dateRange';
  label: string;
  options?: Array<{ value: string; label: string }>;
}

interface ValidationRules {
  [field: string]: {
    required?: boolean;
    min?: number;
    max?: number;
    pattern?: string;
    message?: string;
  };
}
```

## Logica de Segregacion de Acciones

```typescript
// En AuthService o similar
async getModulesForUser(userId: string): Promise<ModuleWithPermissions[]> {
  const user = await this.usersRepository.findOne(userId, { relations: ['permissions'] });

  if (user.isSuperAdmin) {
    // SuperAdmin recibe TODOS los modulos con TODAS las acciones
    return this.getAllModulesWithAllActions();
  }

  const userModuleCodes = this.getUniqueModuleCodes(user.permissions);
  const modules: ModuleWithPermissions[] = [];

  for (const moduleCode of userModuleCodes) {
    const moduleConfig = await this.modulesRepository.findOne({ code: moduleCode });
    const userPermissions = this.getPermissionsForModule(user.permissions, moduleCode);

    const moduleResponse: ModuleWithPermissions = {
      code: moduleConfig.code,
      label: moduleConfig.label,
      description: moduleConfig.description,
      icon: moduleConfig.icon,
      type: moduleConfig.type,
      nav: moduleConfig.navConfig,
      actions: [], // Se poblara a continuacion
    };

    if (moduleConfig.type === 'crud') {
      moduleResponse.entity = moduleConfig.entity;
      moduleResponse.endpoint = moduleConfig.endpoint;
      moduleResponse.actions = this.buildCrudActions(
        moduleConfig.actionsConfig,
        userPermissions
      );
    } else if (moduleConfig.type === 'specialized') {
      moduleResponse.component = moduleConfig.component;
      moduleResponse.actions = this.buildSpecializedActions(
        moduleConfig.actionsConfig,
        userPermissions
      );
    }

    modules.push(moduleResponse);
  }

  return modules;
}

// Construir acciones CRUD basadas en permisos del usuario
private buildCrudActions(
  allActions: ModuleAction[],
  userPermissions: Permission[]
): ModuleAction[] {
  const permissionCodes = userPermissions.map(p => p.action);

  // Filtrar: solo incluir acciones cuyo codigo coincide con un permiso del usuario
  return allActions.filter(action => permissionCodes.includes(action.code));
}

// Construir acciones especializadas basadas en permisos del usuario
private buildSpecializedActions(
  allActions: ModuleAction[],
  userPermissions: Permission[]
): ModuleAction[] {
  const permissionCodes = userPermissions.map(p => p.action);

  // Mismo principio: codigo de accion = codigo de permiso
  return allActions.filter(action => permissionCodes.includes(action.code));
}
```

## Ejemplo de Response

### Usuario con permisos limitados (solo read en objetivos)

```json
{
  "user": {
    "id": "user-123",
    "email": "viewer@copropiedad.com",
    "firstName": "Maria",
    "lastName": "Garcia",
    "isSuperAdmin": false
  },
  "modules": [
    {
      "code": "goals",
      "label": "Objetivos de Recaudo",
      "description": "Gestiona los objetivos de recaudo",
      "icon": "Target",
      "type": "crud",
      "nav": { "path": "/goals", "order": 10 },
      "entity": "Objetivo",
      "endpoint": "/api/goals",
      "actions": [
        {
          "code": "read",
          "label": "Ver",
          "settings": {
            "type": "read",
            "listColumns": [
              { "field": "name", "label": "Nombre", "sortable": true },
              { "field": "targetAmount", "label": "Meta", "format": "money" },
              { "field": "deadline", "label": "Fecha Limite", "format": "date" }
            ],
            "filters": [
              { "field": "status", "type": "select", "label": "Estado", "options": [] }
            ]
          }
        }
      ]
    }
  ]
}
```

### Usuario admin (read, create, update en objetivos)

```json
{
  "user": {
    "id": "user-456",
    "email": "admin@copropiedad.com",
    "firstName": "Juan",
    "lastName": "Perez",
    "isSuperAdmin": false
  },
  "modules": [
    {
      "code": "goals",
      "label": "Objetivos de Recaudo",
      "description": "Gestiona los objetivos de recaudo",
      "icon": "Target",
      "type": "crud",
      "nav": { "path": "/goals", "order": 10 },
      "entity": "Objetivo",
      "endpoint": "/api/goals",
      "actions": [
        {
          "code": "read",
          "label": "Ver",
          "settings": {
            "type": "read",
            "listColumns": [
              { "field": "name", "label": "Nombre", "sortable": true },
              { "field": "targetAmount", "label": "Meta", "format": "money" },
              { "field": "deadline", "label": "Fecha Limite", "format": "date" }
            ]
          }
        },
        {
          "code": "create",
          "label": "Crear",
          "settings": {
            "type": "create",
            "fields": [
              { "name": "name", "label": "Nombre", "type": "text", "required": true },
              { "name": "description", "label": "Descripcion", "type": "textarea" },
              { "name": "targetAmount", "label": "Monto Meta", "type": "money", "required": true },
              { "name": "deadline", "label": "Fecha Limite", "type": "date", "required": true }
            ]
          }
        },
        {
          "code": "update",
          "label": "Editar",
          "settings": {
            "type": "update",
            "fields": [
              { "name": "name", "label": "Nombre", "type": "text", "required": true },
              { "name": "description", "label": "Descripcion", "type": "textarea" },
              { "name": "targetAmount", "label": "Monto Meta", "type": "money", "required": true },
              { "name": "deadline", "label": "Fecha Limite", "type": "date", "required": true }
            ]
          }
        }
      ]
    }
  ]
}
```

## Almacenamiento en DB

Extender la tabla `modules`:

```sql
ALTER TABLE modules ADD COLUMN type VARCHAR(20) DEFAULT 'crud';
ALTER TABLE modules ADD COLUMN entity VARCHAR(100);       -- Solo para CRUD
ALTER TABLE modules ADD COLUMN endpoint VARCHAR(255);     -- Solo para CRUD
ALTER TABLE modules ADD COLUMN component VARCHAR(100);    -- Solo para specialized
ALTER TABLE modules ADD COLUMN actions_config JSONB;      -- Array de acciones
ALTER TABLE modules ADD COLUMN nav_config JSONB;
ALTER TABLE modules ADD COLUMN "order" INTEGER DEFAULT 0;
```

Ejemplo de actions_config en DB para modulo CRUD:

```json
[
  {
    "code": "read",
    "label": "Ver",
    "settings": {
      "type": "read",
      "listColumns": [
        { "field": "name", "label": "Nombre", "sortable": true },
        { "field": "targetAmount", "label": "Meta", "format": "money" }
      ],
      "filters": [
        { "field": "status", "type": "select", "label": "Estado" }
      ]
    }
  },
  {
    "code": "create",
    "label": "Crear",
    "settings": {
      "type": "create",
      "fields": [
        { "name": "name", "label": "Nombre", "type": "text", "required": true },
        { "name": "targetAmount", "label": "Monto Meta", "type": "money", "required": true }
      ]
    }
  },
  {
    "code": "update",
    "label": "Editar",
    "settings": {
      "type": "update",
      "fields": [
        { "name": "name", "label": "Nombre", "type": "text", "required": true },
        { "name": "targetAmount", "label": "Monto Meta", "type": "money", "required": true }
      ]
    }
  },
  {
    "code": "delete",
    "label": "Eliminar",
    "settings": {
      "type": "delete",
      "confirmation": "Â¿Seguro que desea eliminar este objetivo?",
      "soft": true
    }
  }
]
```

Ejemplo de actions_config en DB para modulo especializado:

```json
[
  {
    "code": "view",
    "label": "Ver reportes",
    "description": "Visualizar reportes",
    "settings": { "type": "generic" }
  },
  {
    "code": "export",
    "label": "Exportar",
    "description": "Exportar a PDF/Excel",
    "settings": {
      "type": "generic",
      "formats": ["pdf", "excel", "csv"]
    }
  }
]
```

## Criterios de Aceptacion

- [ ] Endpoint GET /api/auth/me extendido con modulos
- [ ] Retorna solo los modulos a los que el usuario tiene acceso
- [ ] Acciones segregadas por permiso (codigo accion = codigo permiso)
- [ ] Acciones CRUD tienen settings tipados (ReadActionSettings, etc.)
- [ ] Acciones especializadas tienen GenericActionSettings
- [ ] SuperAdmin recibe todos los modulos con todas las acciones
- [ ] Modulos especializados incluyen nombre del componente
- [ ] Tests unitarios para la logica de segregacion de acciones
- [ ] Tests de integracion para el endpoint
