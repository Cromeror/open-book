# OB-004-B-003: Registrar historial de cambios de estado

## Metadata

| Campo | Valor |
|-------|-------|
| Epic | OB-004 - Objetivos de Recaudo |
| Story | OB-004-B - Estados y ciclo de vida de objetivos |
| Status | done |
| Priority | high |
| Created | 2025-12-31 |
| Updated | 2025-12-31 |
| Labels | task, auditoria, historial, trazabilidad |
| Depends on | OB-004-B-002 |
| Assigned | unassigned |

## Descripcion

Implementar el registro de historial de cambios de estado de objetivos, cumpliendo con el principio de trazabilidad. Cada cambio debe quedar documentado con quien, cuando y por que.

## Contexto Tecnico

### Archivos afectados
- `apps/api/src/entities/objetivo-historial.entity.ts`
- `apps/api/src/modules/objetivos/objetivos.service.ts`
- `apps/api/src/modules/objetivos/objetivos.controller.ts`

### Enfoque tecnico
Entidad TypeORM de historial separada que registra cada cambio de estado con metadatos completos.

## Criterios de Aceptacion

- [ ] Entidad ObjetivoHistorial creada con TypeORM
- [ ] Cada cambio de estado crea registro de historial
- [ ] GET /api/.../objetivos/:id/historial disponible
- [ ] Historial incluye: estado anterior, nuevo, fecha, usuario, justificacion
- [ ] Historial es inmutable (solo insertar)

## Notas de Implementacion

Entidad ObjetivoHistorial con TypeORM:
```typescript
import { Entity, Column, ManyToOne, JoinColumn, CreateDateColumn, PrimaryGeneratedColumn, Index } from 'typeorm';
import { Objetivo, EstadoObjetivo } from './objetivo.entity';
import { User } from './user.entity';

@Entity('objetivo_historial')
export class ObjetivoHistorial {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  @Index()
  objetivoId: string;

  @ManyToOne(() => Objetivo, (obj) => obj.historial)
  @JoinColumn({ name: 'objetivoId' })
  objetivo: Objetivo;

  @Column({
    type: 'enum',
    enum: EstadoObjetivo,
  })
  estadoAnterior: EstadoObjetivo;

  @Column({
    type: 'enum',
    enum: EstadoObjetivo,
  })
  estadoNuevo: EstadoObjetivo;

  @Column({ type: 'text', nullable: true })
  justificacion: string;

  @Column()
  userId: string;

  @ManyToOne(() => User)
  @JoinColumn({ name: 'userId' })
  user: User;

  @CreateDateColumn()
  createdAt: Date;
}
```

Controller NestJS:
```typescript
@Controller('objetivos')
@UseGuards(JwtAuthGuard)
export class ObjetivosController {
  @Get(':id/historial')
  async getHistorial(@Param('id') id: string) {
    return this.objetivosService.getHistorial(id);
  }
}
```

Response:
```json
{
  "data": [
    {
      "estadoAnterior": "ACTIVO",
      "estadoNuevo": "PAUSADO",
      "justificacion": "Fondos insuficientes",
      "usuario": "Admin Lopez",
      "fecha": "2025-01-20T10:00:00Z"
    }
  ]
}
```

## Testing

- [ ] Cambio de estado crea registro de historial
- [ ] Historial contiene todos los campos
- [ ] Endpoint retorna historial ordenado cronologicamente
- [ ] No se puede modificar ni eliminar historial
