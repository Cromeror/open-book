# HATEOAS Implementation Guide

## Overview

OpenBook implements HATEOAS (Hypermedia as the Engine of Application State) using a **unified capability model**. Resources are configured by superadmins in the API, and the web proxy consumes this configuration via gRPC to inject dynamic links into API responses.

## Architecture

```
┌─────────────┐
│  SuperAdmin │ Configures resources via /api/admin/resources
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────────────┐
│  API Database (resources table)                     │
│  ┌────────────────────────────────────────────┐    │
│  │ Resource {                                  │    │
│  │   code: 'goals',                           │    │
│  │   templateUrl: '/api/condominiums/{id}/goals', │    │
│  │   capabilities: [                          │    │
│  │     { name: 'list', method: 'GET', ...},   │    │
│  │     { name: 'close', method: 'POST', ...}  │    │
│  │   ]                                         │    │
│  │ }                                           │    │
│  └────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘
       │
       │ gRPC: ResourceService.GetResources()
       │ (no auth, public read)
       ▼
┌─────────────────────────────────────────────────────┐
│  Web Proxy (Next.js)                                │
│  - Caches resource configuration                    │
│  - Intercepts API responses                         │
│  - Injects _links based on:                         │
│    * Resource capabilities                          │
│    * User permissions                               │
│    * Current context (condominiumId, entityId)      │
└─────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────┐
│  API Response with HATEOAS                          │
│  {                                                   │
│    id: '123',                                        │
│    name: 'Mantenimiento Ascensor',                  │
│    _links: [                                         │
│      { rel: 'self', href: '/api/.../goals/123' },  │
│      { rel: 'close', href: '/api/.../close' }      │
│    ]                                                 │
│  }                                                   │
└─────────────────────────────────────────────────────┘
```

## Key Concepts

### ResourceCapability vs HateoasLink

These are **different concepts** in the HATEOAS flow:

#### ResourceCapability (Configuration/Template)

**Purpose**: Defines WHAT a resource can do (stored in database)

```typescript
interface ResourceCapability {
  name: string;        // Capability identifier: 'create', 'close', 'export'
  method: HttpMethod;  // HTTP method: 'GET', 'POST', 'PATCH', 'DELETE'
  urlPattern: string;  // URL pattern: '', '/{id}', '/{id}/close'
  permission?: string; // Optional permission: 'goals:close'
}
```

**Where it lives**: Database (`resources` table)
**When it's used**: Configuration by superadmin
**Nature**: Template with placeholders `{id}`, `{condominiumId}`
**Managed by**: Superadmins via `/api/admin/resources`

**Example:**
```typescript
{
  name: 'close',
  method: 'POST',
  urlPattern: '/{id}/close',
  permission: 'goals:close'
}
```

#### HateoasLink (Generated Result)

**Purpose**: Defines a SPECIFIC action for a SPECIFIC resource (generated dynamically)

```typescript
interface HateoasLink {
  rel: string;         // Relation type (from capability.name)
  href: string;        // FULLY INTERPOLATED URL (no placeholders)
  method: HttpMethod;  // HTTP method
  title?: string;      // Human-readable title
}
```

**Where it lives**: API responses (injected by proxy)
**When it's used**: Runtime, on every API request
**Nature**: Concrete, all variables replaced
**Generated by**: Web proxy based on context

**Example:**
```typescript
{
  rel: 'close',
  href: '/api/condominiums/abc-123/goals/xyz-456/close',
  method: 'POST',
  title: 'Cerrar objetivo'
}
```

### Transformation Flow

```typescript
// 1. CONFIGURATION (Database)
ResourceCapability {
  name: 'close',
  method: 'POST',
  urlPattern: '/{id}/close',
  permission: 'goals:close'
}

// ↓ Proxy reads capability + user context

// 2. CONTEXT (Runtime)
{
  templateUrl: '/api/condominiums/{condominiumId}/goals',
  condominiumId: 'abc-123',
  entityId: 'xyz-456',
  userPermissions: ['goals:close', 'goals:read']
}

// ↓ Proxy interpolates + filters by permissions

// 3. RESULT (API Response)
HateoasLink {
  rel: 'close',
  href: '/api/condominiums/abc-123/goals/xyz-456/close',
  method: 'POST',
  title: 'Cerrar objetivo'
}
```

### Comparison Table

| Aspect | ResourceCapability | HateoasLink |
|--------|-------------------|-------------|
| **What is it** | Template/configuration | Concrete link |
| **URLs** | With placeholders `{id}` | Interpolated `/goals/123` |
| **Permissions** | Defines which is required | Only included if user has it |
| **Where** | Database | HTTP Response |
| **When** | Setup/configuration time | Runtime/every request |
| **Name field** | `name` (capability identifier) | `rel` (relation type) |
| **Who creates** | Superadmin | Web proxy |
| **Scope** | All resources | Specific entity instance |

**In short**: **Capability** is the recipe, **HateoasLink** is the served dish.

## Unified Capability Model

### Design Principle

**All capabilities are treated equally** - no distinction between "standard" CRUD and "custom" actions.

- ✅ **CRUD**: `list`, `get`, `create`, `update`, `delete`
- ✅ **Custom**: `close`, `approve`, `export`, `archive`
- ✅ **Relations**: `activities`, `contributions`, `members`

All follow the same `ResourceCapability` structure.

### Why Unified?

**Benefits:**
- No conditional logic (`if (isCustom)` ❌)
- Simple data model (single array)
- Easy to extend (just add capability)
- Consistent processing (same code path)
- Frontend presets = UI sugar only

**Example:**
```typescript
// A resource with mixed capabilities
{
  code: 'goals',
  capabilities: [
    // CRUD
    { name: 'list', method: 'GET', urlPattern: '' },
    { name: 'create', method: 'POST', urlPattern: '' },

    // Custom action
    { name: 'close', method: 'POST', urlPattern: '/{id}/close' },

    // Related resource
    { name: 'activities', method: 'GET', urlPattern: '/{id}/activities' }
  ]
}
```

## API Endpoints

### Admin Endpoints (SuperAdmin only)

CRUD operations for resource configuration:

```
GET    /api/admin/resources          # List all resources
POST   /api/admin/resources          # Create new resource
GET    /api/admin/resources/:code    # Get specific resource
PATCH  /api/admin/resources/:code    # Update resource
DELETE /api/admin/resources/:code    # Soft delete resource
POST   /api/admin/resources/:code/toggle  # Toggle active status
```

**Authentication**: Requires `JwtAuthGuard` + `SuperAdminGuard`

### gRPC Service (Public, no auth)

Read-only access for web proxy:

```protobuf
service ResourceService {
  rpc GetResources(Empty) returns (GetResourcesResponse);
  rpc GetResource(GetResourceRequest) returns (GetResourceResponse);
}
```

**Authentication**: None (public configuration data)
**Consumer**: Web proxy (Next.js)

## Database Schema

```sql
CREATE TABLE resources (
  id UUID PRIMARY KEY,
  code VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  scope VARCHAR(20) DEFAULT 'global',  -- 'global' | 'condominium'
  template_url VARCHAR(255) NOT NULL,
  capabilities JSONB DEFAULT '[]',     -- Array of ResourceCapability
  is_active BOOLEAN DEFAULT true,

  -- Audit fields from BaseEntity
  created_at TIMESTAMPTZ,
  created_by UUID,
  updated_at TIMESTAMPTZ,
  updated_by UUID,
  deleted_at TIMESTAMPTZ,
  deleted_by UUID
);
```

### Capabilities Column (JSONB)

```json
[
  {
    "name": "list",
    "method": "GET",
    "urlPattern": "",
    "permission": null
  },
  {
    "name": "close",
    "method": "POST",
    "urlPattern": "/{id}/close",
    "permission": "goals:close"
  }
]
```

## Resource Scopes

### Global Resources

Resources not tied to a specific condominium:

```typescript
{
  code: 'users',
  scope: 'global',
  templateUrl: '/api/users'
}
```

**URL pattern**: `/api/users`, `/api/users/{id}`

### Condominium Resources

Resources scoped to a condominium:

```typescript
{
  code: 'goals',
  scope: 'condominium',
  templateUrl: '/api/condominiums/{condominiumId}/goals'
}
```

**URL pattern**: `/api/condominiums/{condominiumId}/goals/{id}`

## Permission System

### Default Permission Convention

If `permission` is not specified, defaults to: `{resourceCode}:{capabilityName}`

**Example:**
```typescript
// Capability
{ name: 'close', method: 'POST', urlPattern: '/{id}/close' }

// Default permission (if not specified)
'goals:close'  // {resourceCode}:{capabilityName}
```

### Custom Permissions

Override the default by specifying `permission`:

```typescript
{
  name: 'export',
  method: 'GET',
  urlPattern: '/{id}/export',
  permission: 'reports:export'  // Custom permission
}
```

## Example: Goals Resource

### Database Configuration

```json
{
  "code": "goals",
  "name": "Objetivos de Recaudo",
  "scope": "condominium",
  "templateUrl": "/api/condominiums/{condominiumId}/goals",
  "capabilities": [
    { "name": "list", "method": "GET", "urlPattern": "" },
    { "name": "get", "method": "GET", "urlPattern": "/{id}" },
    { "name": "create", "method": "POST", "urlPattern": "" },
    { "name": "update", "method": "PATCH", "urlPattern": "/{id}" },
    { "name": "delete", "method": "DELETE", "urlPattern": "/{id}" },
    { "name": "close", "method": "POST", "urlPattern": "/{id}/close" },
    { "name": "activities", "method": "GET", "urlPattern": "/{id}/activities" }
  ],
  "isActive": true
}
```

### Generated HATEOAS Links

For user with permissions `['goals:read', 'goals:close']` accessing goal `xyz-456` in condominium `abc-123`:

```json
{
  "id": "xyz-456",
  "name": "Mantenimiento Ascensor",
  "targetAmount": 5000000,
  "_links": [
    {
      "rel": "self",
      "href": "/api/condominiums/abc-123/goals/xyz-456",
      "method": "GET"
    },
    {
      "rel": "close",
      "href": "/api/condominiums/abc-123/goals/xyz-456/close",
      "method": "POST"
    },
    {
      "rel": "activities",
      "href": "/api/condominiums/abc-123/goals/xyz-456/activities",
      "method": "GET"
    }
  ]
}
```

**Note**: Links for `create`, `update`, `delete` are NOT included because user lacks permissions.

## Frontend Implementation

See [hateoas-web-implementation.md](../../.claude/plans/hateoas-web-implementation.md) for:
- gRPC client setup
- Proxy interceptor
- UI presets for admin panel
- Cache strategy

## Best Practices

### 1. Capability Naming

- Use lowercase, descriptive names
- Follow conventions: `list`, `get`, `create`, `update`, `delete`
- Custom actions: `close`, `approve`, `export`, `archive`
- Relations: `activities`, `members`, `contributions`

### 2. URL Patterns

- Collection operations: `''` (empty string)
- Item operations: `'/{id}'`
- Item actions: `'/{id}/close'`
- Nested resources: `'/{id}/activities'`

### 3. Permissions

- Let default convention work when possible
- Only specify custom permissions when needed
- Use namespaced format: `resource:action`

### 4. Resource Organization

- One resource per domain entity
- Group related capabilities together
- Keep `isActive` for feature flags

## Migration

Run migration to create the `resources` table:

```bash
pnpm nx run api:migration:run
```

Migration file: `1737600000000-CreateResourcesTable.ts`

## Files Reference

### Backend (API)

**Types & Entity:**
- `apps/api/src/types/resource.types.ts`
- `apps/api/src/entities/resource.entity.ts`

**Admin Module (SuperAdmin CRUD):**
- `apps/api/src/modules/admin/resources/`

**Resources Module (gRPC read-only):**
- `apps/api/src/modules/resources/`

**gRPC:**
- `apps/api/src/grpc/proto/resources.proto`
- `apps/api/src/grpc/controllers/resources.grpc-controller.ts`

**Migration:**
- `apps/api/src/migrations/1737600000000-CreateResourcesTable.ts`

### Frontend (Web)

See implementation plan: `.claude/plans/hateoas-web-implementation.md`

## FAQ

**Q: Why separate ResourceCapability from HateoasLink?**
A: Separation of concerns. Capabilities are configuration (what CAN be done), links are runtime (what this user CAN do with this specific resource).

**Q: Why no distinction between CRUD and custom capabilities?**
A: Simplifies the model. All capabilities follow the same structure and processing logic. No special cases.

**Q: Why gRPC without authentication?**
A: Resource configuration is public metadata, not sensitive data. No auth = faster, simpler. Permission filtering happens at link generation time.

**Q: Can I change a resource's capabilities at runtime?**
A: Yes, via admin endpoints. Web proxy caches resources (5min TTL), so changes propagate quickly.

**Q: What if a user lacks permission for all capabilities?**
A: Response includes empty `_links: []` array. Frontend handles gracefully (e.g., read-only view).
